<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ANESA+ ‚Äî Session 1</title>
<link rel="preconnect" href="https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app" crossorigin>
<link rel="preload" as="image" href="logo3.png" />
<style>

  /* ========== Base variables ========== */
:root{
  --bg:#f6f8fd; --card:#fff; --line:#e6e9f2; --txt:#0f1733; --muted:#6b78a6;
  --btn:#1f6fff; --danger:#d93025; --ok:#0a8c4a;
  --header-h:64px;

  /* pastel/border for cards & KPI */
  --bd:#e9eef7;
  --shadow:0 6px 24px rgba(13,38,76,.06);

  --kpi-total-bg:#eaf1ff; --kpi-total-bd:#d6e4ff; /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
  --kpi-used-bg:#ffe9e9;  --kpi-used-bd:#ffd6d6;  /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
  --kpi-left-bg:#e9f8ee;  --kpi-left-bd:#d7f0de;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
}

/* ========== Reset / layout ========== */
*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{
  font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  background:var(--bg); color:var(--txt);
}

/* ========== Header (fixed) ========== */
header{
  position:fixed; inset:0 auto auto 0; right:0; top:0;
  z-index:1000; display:flex; align-items:center; gap:12px;
  background:#1d3557; color:#fff; padding:10px 14px;
}
header img{ height:44px; width:auto }
.brand{ display:flex; flex-direction:column; line-height:1.15 }
.brand .sys{ font-size:24px; font-weight:800; letter-spacing:.2px }
.brand .welcome{ font-size:14px; color:#e6eefc; font-weight:600 }
.spacer{ flex:1 }

/* Logout button (icon) */
#btnLogout{
  background:#1f6fff; color:#fff; border:none; border-radius:12px;
  padding:8px 14px; cursor:pointer; box-shadow:0 6px 16px rgba(31,111,255,.25);
}
#btnLogout.icon-btn{
  width:36px; height:36px; padding:0; display:inline-grid; place-items:center;
  background:#fec89a; border-radius:12px; box-shadow:0 6px 16px rgba(31,111,255,.25);
}
#btnLogout.icon-btn svg{ width:20px; height:20px; fill:currentColor; }

/* ========== Main container ========== */
main{
  max-width:980px; margin:0 auto;
  padding:14px; display:grid; gap:18px;
  margin-top:calc(var(--header-h) + 8px);
}

/* ========== Generic UI ========== */
.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
input,button{
  border-radius:12px; border:1px solid var(--line);
  padding:10px 12px; font:inherit;
}
button{ cursor:pointer; background:var(--btn); color:#fff; border-color:transparent }
button.ghost{ background:#0f1733; color:#fff }
button[disabled]{ background:#cfd7ff; color:#6570a0; cursor:not-allowed }
.muted{ color:var(--muted) }
.pill{ display:inline-block; background:#eef3ff; border-radius:999px; padding:6px 12px }

/* ========== Card ========== */
.card{
  background:#fff; border:1px solid var(--bd); border-radius:16px;
  box-shadow:var(--shadow); padding:16px; position:relative;
}
.card>h3:first-child{
  position:static; margin:0 0 10px; padding:0;
  border:0; background:transparent; border-radius:0;
  font-size:16px; font-weight:800; display:flex; gap:8px; color:var(--txt);
}

/* ========== Rewards list ========== */
.reward{
  display:flex; gap:10px; align-items:center;
  border:1px solid var(--line); border-radius:10px; padding:10px; margin-bottom:8px;
}
.reward img{
  width:56px; height:56px; border-radius:8px; object-fit:cover;
  background:#f4f6fb; border:1px solid var(--line);
}

/* ========== Tables ========== */
table{ width:100%; border-collapse:collapse }
th,td{ border:1px solid var(--line); padding:8px 10px; text-align:left }
#annualBox table th:last-child,
#annualBox table td:last-child{ text-align:center; width:90px }
#weeklyBox table th:nth-child(3),
#weeklyBox table td:nth-child(3),
#weeklyBox table th:nth-child(4),
#weeklyBox table td:nth-child(4){ text-align:center; width:90px }

/* ========== Modals & toast ========== */
#qrModal,#actModal,#chooseModal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.5); z-index:60;
}
#qrBox,#actBox,#chooseBox{
  background:#fff; border:1px solid var(--line); border-radius:12px;
  padding:16px; max-width:640px; width:92vw;
}
.timer{ font-variant-numeric:tabular-nums; font-size:22px }
.pill2{ display:inline-block; background:#fff7e6; border:1px solid #ffd18a; color:#8a5300; border-radius:999px; padding:4px 10px }
.bad{ color:var(--danger) } .ok{ color:var(--ok) }
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:#0c8c5f; color:#fff; padding:10px 14px; border-radius:10px;
  box-shadow:0 8px 22px rgba(0,0,0,.18); opacity:0; transition:.25s; z-index:999;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }
.latest{ border:1px dashed var(--line); background:#f7f9ff; border-radius:10px; padding:10px; margin-bottom:10px }
.latest b{ font-weight:800 }

/* ========== Login page ========== */
body.is-login{ overflow:hidden; }
#loginBox{ display:flex; align-items:flex-start; justify-content:center; padding:12px }
.login-card{
  width:min(560px,92vw); text-align:center;
  background:rgba(255,255,255,.86); border:1px solid rgba(255,255,255,.6);
  border-radius:22px; box-shadow:0 20px 50px rgba(20,34,89,.12), 0 6px 18px rgba(20,34,89,.08);
  backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  padding:26px 18px 20px;
}
.login-logo{ width:88px; height:88px; object-fit:contain; margin:0 auto 6px; display:block; animation:floaty 3.6s ease-in-out infinite }
.login-title{ font-weight:800; font-size:clamp(18px,3.6vw,24px); margin:2px 0 }
.login-sub{ margin:0 0 12px; color:#7a86b6 }
.login-row{ display:flex; justify-content:center; gap:12px }
#sap{ width:170px; height:42px; text-align:center; border-radius:999px; border:1px solid #e2e7fb; background:#fff; box-shadow:inset 0 1px 0 rgba(255,255,255,.7) }
#sap:focus{ outline:none; border-color:#b9c8ff; box-shadow:0 0 0 4px rgba(116,148,255,.22) }
#btnLogin{
  height:42px; border-radius:999px; border:none; padding:0 18px; font-weight:700; letter-spacing:.2px;
  background:linear-gradient(135deg,#3b82f6,#6d28d9); box-shadow:0 10px 20px rgba(59,130,246,.25);
}
#btnLogin:hover{ transform:translateY(-1px); filter:brightness(1.03); box-shadow:0 12px 24px rgba(59,130,246,.3) }
@keyframes floaty{ 0%,100%{ transform:translateY(-2px) } 50%{ transform:translateY(2px) } }

:root{
  /* ‚Ä¶‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏î‡∏¥‡∏°‚Ä¶ */
  --logo-size: 260px;   /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ) */
  --logo-bob:  16px;    /* ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ) */
}

/* ‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
.login-logo{
  width: var(--logo-size);
  height: var(--logo-size);
  object-fit: contain;
  margin: 0 auto 6px;
  display: block;
  animation: floaty 3.6s ease-in-out infinite;
}

/* ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
@keyframes floaty{
  0%,100% { transform: translateY(calc(var(--logo-bob) * -1)); }
  50%     { transform: translateY(var(--logo-bob)); }
}

/* ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å ‡∏≠‡∏¢‡∏≤‡∏Å‡∏¢‡πà‡∏≠‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
@media (max-width:520px){
  .login-logo{
    --logo-size: 160px;
    --logo-bob: 12px;
  }
}

/* ========== KPI section ========== */
#kpiBox{ padding-top:8px; }
#kpiBox > h3{ margin:0 0 6px; }
#kpiBox .kpiRow{
  display:flex; align-items:center; gap:8px; margin-top:2px;
}
.kpi{
  min-width:96px; padding:6px 8px; text-align:center;
  border:1px solid var(--line); border-radius:12px;
  box-shadow:inset 0 2px 8px rgba(15,23,51,.05);
}
.kpi .label{ display:block; font-size:12px; line-height:1.2; color:var(--muted); margin-bottom:2px }
.kpi .value{ display:block; font-size:22px; font-weight:800; line-height:1 }

/* KPI colors */
.kpi.is-total{ background:var(--kpi-total-bg); border-color:var(--kpi-total-bd); color:#1f4b99 }
.kpi.is-used { background:var(--kpi-used-bg);  border-color:var(--kpi-used-bd);  color:#9c2a2a }
.kpi.is-left { background:var(--kpi-left-bg);  border-color:var(--kpi-left-bd);  color:#0a6b3d }

/* Top 20 button */
#kpiBox #btnTop20{
  margin-left:auto; font-size:13px; padding:6px 10px; border-radius:10px;
  background:#1f6fff; color:#fff; border:none; white-space:nowrap;
  box-shadow:0 4px 12px rgba(31,111,255,.18);
}

/* ========== Responsive ========== */
@media (max-width:720px){
  #kpiBox .kpiRow{ flex-wrap:wrap }
  #kpiBox #btnTop20{ order:4 } /* ‡∏•‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Ñ‡∏ö */
}
@media (max-width:520px){
  header img{ height:40px }
  .brand .sys{ font-size:22px }
  #sap{ width:150px; height:40px }
  #btnLogin{ height:40px; padding:0 16px }
  .login-logo{ width:80px; height:80px }
  .kpi{ min-width:92px; padding:6px 8px }
  .kpi .value{ font-size:18px }
  #btnLogout.icon-btn{ width:32px; height:32px; border-radius:10px }
  #btnLogout.icon-btn svg{ width:18px; height:18px }
}

/* ---- Fix: ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏±‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ---- */
body.is-login main{
  /* ‡∏î‡∏±‡∏ô‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Æ‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏≠‡∏µ‡∏Å 24px */
  margin-top: calc(var(--header-h) + 8px) !important;
}

body.is-login #loginBox{
  /* ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏¥‡πà‡∏° padding-top ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô section */
  padding-top: 16px !important;
}

body.is-login .login-card{
  /* ‡∏Å‡∏±‡∏ô CSS ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡∏ö‡∏Ñ‡πà‡∏≤: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏ä‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ */
  margin-top: 24px !important;
}

/* ===== Top20 table ===== */
.top20-table thead th{ text-align:center !important; }  /* ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ä‡∏¥‡∏î‡∏Å‡∏•‡∏≤‡∏á */

.top20-table th:nth-child(1),
.top20-table td:nth-child(1),
.top20-table th:nth-child(3),
.top20-table td:nth-child(3){
  width:76px;           /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 70/80 ‡πÑ‡∏î‡πâ */
  text-align:center;
}

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î */
@media (max-width:720px){
  .top20-table th:nth-child(1),
  .top20-table td:nth-child(1),
  .top20-table th:nth-child(3),
  .top20-table td:nth-child(3){ width:70px }
}
@media (max-width:420px){
  .top20-table th:nth-child(1),
  .top20-table td:nth-child(1),
  .top20-table th:nth-child(3),
  .top20-table td:nth-child(3){ width:64px }
}
</style>

</head>
<body class="is-login">
<header>
  <img src="logo4.png" alt="logo" />
  <div class="brand">
    <div class="sys">Anesthesia A+</div>
    <div id="welcomeText" class="welcome" style="display:none">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ‚Äî</div>
  </div>
  <div class="spacer"></div>
  <button id="btnLogout" class="icon-btn" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" aria-label="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" style="display:none">
  <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô logout ‡πÅ‡∏ö‡∏ö SVG -->
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M10 3a1 1 0 0 0-1 1v4h2V6h8v12h-8v-2H9v4a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H10z"/>
    <path d="M13 12a1 1 0 0 0-1-1H5.41l1.3-1.29A1 1 0 1 0 5.3 7.3l-3 3a1 1 0 0 0 0 1.41l3 3a1 1 0 1 0 1.41-1.41L5.41 13H12a1 1 0 0 0 1-1z"/>
  </svg>
</button>

</header>

<main>
  <!-- Login -->
  <section id="loginBox">
    <div class="login-card">
      <img src="logo3.png" alt="Mascot" class="login-logo" />
      <h1 class="login-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Anesthesia A+<br>‡∏ï‡∏≠‡∏ô ‚Äú‡∏•‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏ß...‡∏ö‡∏¥‡πâ‡∏ß‡πÅ‡∏ï‡πâ‡∏°‚Äù</h1>
      <p class="login-sub">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ <b>SAP</b> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
      <div class="login-row">
        <input id="sap" placeholder="SAP" inputmode="numeric" autocomplete="off" />
        <button id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px;min-height:20px"></div>
    </div>
  </section>

  <!-- KPI + Top20 -->
  <section id="kpiBox" class="card" style="display:none">
    <h3>üìä ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
    <div class="kpiRow row">
      <div class="kpi is-total">
      <span class="label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      <span class="value" id="uEarned">0</span>
    </div>
    <div class="kpi is-used">
      <span class="label">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>
      <span class="value" id="uUsed">0</span>
    </div>
    <div class="kpi is-left">
      <span class="label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
      <span class="value" id="uTotal">0</span>
    </div>
    <button id="btnTop20">üèÜTop 20</button>
  </div>
  </section>

  <!-- Today / Activities -->
  <section id="actTodayCard" class="card" style="display:none">
    <h3>üçÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
    <div id="actLatest" class="latest" style="display:none"></div>
    <div id="actTodayInfo" class="muted" style="display:none"></div>
    <div class="row" style="margin-top:8px">
      <button id="btnActNow">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button id="btnWinners">Top 20 ‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</button>
    </div>
    <div id="actList" style="margin-top:10px;display:none"></div>
  </section>

  <!-- Rewards -->
  <section id="rewardsBox" class="card" style="display:none">
    <h3>üéÅ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ</h3>
     <div id="rewards"></div>
    <div id="lockBanner" class="muted" style="margin-top:6px;display:none">
      <span>‡∏°‡∏µ QR ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Äî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô <b class="timer" id="bannerTimer">10:00</b></span>
      <button class="ghost" id="bannerShow" style="margin-left:8px">‡πÄ‡∏õ‡∏¥‡∏î QR</button>
    </div>
  </section>

  <!-- History -->
  <section id="historyBox" class="card" style="display:none">
    <h3>üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</h3>
    <table>
      <thead><tr><th>‡∏ß‡∏î‡∏õ</th><th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th><th>‡πÅ‡∏ï‡πâ‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
      <tbody id="history"><tr><td colspan="4" style="text-align:center">‚Äî</td></tr></tbody>
    </table>
  </section>

  <!-- Weekly -->
  <section id="weeklyBox" class="card" style="display:none">
    <h3>üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
    <table>
      <thead><tr><th>‡∏ß‡∏î‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th><th>‡∏ú‡∏•‡∏ï‡∏≠‡∏ö</th><th>‡πÅ‡∏ï‡πâ‡∏°</th></tr></thead>
      <tbody id="weekly"><tr><td colspan="4" style="text-align:center">‚Äî</td></tr></tbody>
    </table>
  </section>

  <!-- Annual forms -->
  <section id="annualBox" class="card" style="display:none">
    <h3>üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</h3>
    <table>
      <thead><tr><th>‡∏ß‡∏î‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</th><th>‡πÅ‡∏ï‡πâ‡∏° (‡∏£‡∏ß‡∏°)</th></tr></thead>
      <tbody id="annual"><tr><td colspan="3" style="text-align:center">‚Äî</td></tr></tbody>
    </table>
  </section>
</main>

<div id="top20Modal" class="modal" style="display:none">
  <div class="modal-card">
    <h3>Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
    <table>
      <thead>
         <tr>
           <th style="width:64px;text-align:center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
           <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
           <th style="width:120px;text-align:right">‡πÅ‡∏ï‡πâ‡∏°</th>
         </tr>
      </thead>
      <tbody id="top20List"><tr><td colspan="3" class="muted">‚Äî</td></tr></tbody>
    </table>
    <button onclick="hideModalTop20()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<!-- QR Modal -->
<div id="qrModal"><div id="qrBox">
  <div class="row" style="align-items:center;margin-bottom:6px">
    <h3 style="margin:0">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</h3>
    <span class="pill2" style="margin-left:auto">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô <b class="timer" id="qrTimer">10:00</b></span>
  </div>
  <div class="row" style="align-items:center">
    <div style="flex:1">
      <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: <b id="qrRewardName"></b> ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ <b id="qrPoints"></b> ‡πÅ‡∏ï‡πâ‡∏°</div>
      <div id="qrAck" class="muted" style="margin-top:6px"></div>
      <div id="qrExpired" class="bad" style="display:none;margin-top:6px">QR ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÅ‡∏•‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
    </div>
    <img id="qrImg" alt="QR" style="width:180px;height:180px;border:1px solid var(--line);border-radius:8px;background:#fff" />
  </div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button id="btnCloseQR" class="ghost">‡∏õ‡∏¥‡∏î</button>
  </div>
</div></div>

<!-- Activity Modal -->
<div id="actModal"><div id="actBox">
  <h3 id="actTitle">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
  <div id="actQuestion" class="muted" style="margin-bottom:8px"></div>
  <div id="actOpts"></div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button id="btnActSubmit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    <button id="btnActClose" class="ghost">‡∏õ‡∏¥‡∏î</button>
  </div>
  <div id="actStatus" class="muted" style="margin-top:6px"></div>
</div></div>

<!-- Two-step chooser -->
<div id="chooseModal"><div id="chooseBox">
  <h3 style="margin-top:0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
  <div id="chooseBody" class="row"></div>
  <div style="text-align:right;margin-top:8px">
    <button id="btnChooseClose" class="ghost">‡∏õ‡∏¥‡∏î</button>
  </div>
</div></div>

<dialog id="dlgTop"><div style="min-width:320px">
  <h3 id="dlgTopTitle">Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
  <div id="dlgTopBody"></div>
  <div style="text-align:right;margin-top:8px"><button onclick="this.closest('dialog').close()">‡∏õ‡∏¥‡∏î</button></div>
</div></dialog>

<div id="toast" class="toast"></div>

<footer style="text-align:center;color:#8b94b2;font-size:12px;margin:8px 0">
  ¬© 2025 | ‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏™‡∏±‡∏ç‡∏ç‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏Ñ‡∏ì‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•

</footer>

<script type="module">
window.state = window.state || { sap: "", weeklyRemote: [], offWeekly: null };
/* ========= Config ========= */
const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
const { getDatabase, ref, onValue, get, off, child } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js");
const app = initializeApp({
  apiKey: "AIzaSyAiSW2d16RpHjtUR7OIl2PVpvH_QPL3cp4",
  authDomain: "anesaplus.firebaseapp.com",
  databaseURL: "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anesaplus",
  appId: "1:518123966097:web:2f93eeb56ec026aa903930"
});

// Endpoints
const DB_URL = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";
const ADMIN_PAGE_URL = "https://sianesth.github.io/Admin_reward/"; 
// ‚¨áÔ∏è IMPORTANT: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Web App (Deployment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec';

// ===== ‡πÉ‡∏™‡πà‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å =====
async function postSubmissionToSheet(payload) {
  const url = (typeof SCRIPT_URL !== 'undefined') ? SCRIPT_URL : '';
  if (!url) {
    console.error('SCRIPT_URL missing');
    return { ok: false, error: 'SCRIPT_URL missing' };
  }

  try {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify(payload),
      keepalive: false,
      cache: 'no-store'
    });

    // ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á GAS ‡∏à‡∏∞‡∏™‡πà‡∏á 200 ‡∏û‡∏£‡πâ‡∏≠‡∏° body ‡∏ß‡πà‡∏≤‡∏á/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‚Üí ‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ
    let data = null;
    try { data = await res.json(); } catch (_) { data = null; }

    // ====== ‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥ (‡∏ù‡∏±‡πà‡∏á client) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ======
    if (data && (data.error === 'already_answered_today' || data.errorCode === 'ALREADY_ANSWERED')) {
      try {
        const actId = String(payload.actId || '').trim();
        if (actId) {
          const today = todayKey('Asia/Bangkok'); // ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡πÑ‡∏ó‡∏¢
          const SAP   = localStorage.getItem('SAP') || (state && state.sap) || '';
          const key   = `ans:${today}:${SAP}:${actId}`;
          localStorage.setItem(key, '1');          // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÅ‡∏ö‡∏ö ans:YYYY-MM-DD:SAP:ActID
          try { localStorage.setItem(aKey(actId), '1'); } catch (e) {}

          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏π‡πà clinic/non-clinic ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏ä‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
          try {
            const meta = (typeof getActMetaById === 'function') ? getActMetaById(actId) : null;
            const pk = meta && (typeof pairKeyOf === 'function') ? pairKeyOf(meta) : null;
            if (pk && typeof clinPairStoreKey === 'function') {
              localStorage.setItem(clinPairStoreKey(pk), '1');
            }
          } catch (e) {}

          // ‡∏¢‡∏¥‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ RTDB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
          try {
            await fetch(`${DB_URL}/public/answeredToday/${today}/${encodeURIComponent(actId)}/${encodeURIComponent(SAP)}.json`, {
              method: 'PUT',
              body: 'true'
            });
          } catch (_) {}
        }
      } catch (e) {}

      try { document.querySelector('#actModal').style.display = 'none'; } catch (e) {}
      if (typeof toast === 'function') toast('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 3000);
      return { ok: false, error: 'already_answered_today' };
    }

    // ====== ‡πÅ‡∏à‡πâ‡∏á Non-active ======
    if (data && data.error === 'USER_NON_ACTIVE') {
      if (typeof toast === 'function') {
        toast('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Non-active</b><br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 4000);
      }
      return { ok: false, error: 'USER_NON_ACTIVE' };
    }

    // ====== ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤ server ‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ correct ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ======
    if (data && data.ok && data.correct != null && typeof showAnswerResult === 'function') {
      if (data.correct === 'TRUE') {
        showAnswerResult(true, Number(data.points || 0));
      } else if (data.correct === 'FALSE') {
        showAnswerResult(false, 0);
      } else {
        showAnswerResult(null, 0); // PENDING
      }
    }

    // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    if (data) return data;

    // fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ body ‡∏ß‡πà‡∏≤‡∏á
    return { ok: true, correct: 'PENDING', points: null };

  } catch (e) {
    console.error('Submit error:', e);
    return { ok: false, error: String(e) };
  }
}

// ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ Status ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô boolean
function isActiveStatus(val){
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á "active", "non-active", TRUE/FALSE, 1/0, ‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
  const s = String(val ?? '').normalize('NFKC').trim().toLowerCase();
  if (typeof val === 'boolean') return val;
  if (!s) return false;                                       // ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á = ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
  if (/^(inactive|non-?active|disabled?|false|0|‡∏õ‡∏¥‡∏î|‡∏á‡∏î|‡∏´‡∏¢‡∏∏‡∏î)$/.test(s)) return false;
  if (/^(active|enabled?|true|1|‡πÄ‡∏õ‡∏¥‡∏î|‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô|on|yes)$/.test(s)) return true;
  return !(s.startsWith('non'));                              // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏∞‡∏Å‡∏î‡πÅ‡∏õ‡∏•‡∏Å‡πÜ
}

/* ========= Tiny helpers ========= */
const $ = q => document.querySelector(q);
function gasJSONP(params){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=d=>{ resolve(d); delete window[cb]; s.remove(); };
    const qs=new URLSearchParams({...params, callback:cb}).toString();
    const s=document.createElement('script'); s.src=`${SCRIPT_URL}?${qs}`;
    s.onerror=()=>reject(new Error('GAS JSONP error'));
    document.body.appendChild(s);
  });
}
  
async function hasAnswered(sap, actId){
  const r = await gasJSONP({act:'answered', sap, actId});
  return !!(r && r.ok && r.answered);
}

const fmt = n => Number(n||0).toLocaleString('th-TH');
const pad2 = n => String(n).padStart(2,'0');
function toast(html,ms=3000){ const el=$('#toast'); el.innerHTML=html; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),ms); }
function setWelcome(name){const el=$('#welcomeText'); if(name){ el.textContent='‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì '+name; el.style.display='block'; } else { el.style.display='none'; } }
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
// ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏™‡∏°‡∏≠
function todayKey(tz = 'Asia/Bangkok') {
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
  return fmt.format(new Date()); // YYYY-MM-DD
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô (optional)
function dayKeyFromDate(d, tz = 'Asia/Bangkok') {
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
  return fmt.format(d);
}

// === Date helpers (‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á ISO, 'YYYY-MM-DD HH:mm:ss', 'DD/MM/YYYY, HH:MM:SS', serial day) ===
function anyToDate(x){
  if (x instanceof Date) return x;
  if (x == null || x === '') return null;

  if (typeof x === 'number') {
    if (x > 25569 && x < 60000) return new Date((x - 25569) * 86400 * 1000); // serial day
    return new Date(x);
  }

  const s = String(x).trim();
  if (!s) return null;

  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?(?:Z|[+\-]\d{2}:?\d{2})?$/.test(s)){
    const fix = s.replace(/([+\-]\d{2})(\d{2})$/,'$1:$2'); // +0700 -> +07:00
    const d = new Date(fix);
    return isNaN(+d) ? null : d;
  }

  if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) {
    return new Date(s.replace(' ','T') + '+07:00');
  }

  if (/^\d{2}\/\d{2}\/\d{4}[, ] \d{1,2}:\d{2}:\d{2}$/.test(s)) {
    const m = s.replace(',', '').match(/^(\d{2})\/(\d{2})\/(\d{4}) (\d{1,2}:\d{2}:\d{2})$/);
    if (m) return new Date(`${m[3]}-${m[2]}-${m[1]}T${m[4]}+07:00`);
  }

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00+07:00');

  const d = new Date(s);
  return isNaN(+d) ? null : d;
}

function thaiDate(d){
  if (!d) return 'Invalid Date';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear() + 543;
  return `${dd}/${mm}/${yyyy}`;
}

function thaiFromKeys(obj, keys){
  for (const k of keys){
    if (obj && obj[k] != null && String(obj[k]).trim() !== ''){
      const d = anyToDate(obj[k]);
      if (d) return thaiDate(d);
    }
  }
  return 'Invalid Date';
}

// Google Drive image helpers
function extractId(u){ const s=String(u||""); if(!s) return ""; const m = s.match(/\/d\/([A-Za-z0-9_-]+)/) || s.match(/[?&]id=([A-Za-z0-9_-]+)/); return m&&m[1]?m[1]:""; }
function fixImg(u){ const s=String(u||'').trim(); if(!s) return ''; if(/uc\?export=view&id=/.test(s)) return s; const id=extractId(s); return id ? `https://drive.google.com/uc?export=view&id=${id}` : s; }
function driveThumb(id){ return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w300` : ''; }

/* ========= Header offset (fixed header space) ========= */
function applyHeaderOffset(){
  const h = document.querySelector('header')?.offsetHeight || 0;
  document.documentElement.style.setProperty('--header-h', h + 'px');
}
window.addEventListener('load', applyHeaderOffset);
window.addEventListener('resize', applyHeaderOffset);

/* ========= Session ========= */
const SESSION_KEY = 'anes.session.v1';
const saveSession = d => { try{ localStorage.setItem(SESSION_KEY, JSON.stringify(d)); }catch{} };
const readSession = () => { try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch{ return null } };
const clearSession = () => { try{ localStorage.removeItem(SESSION_KEY); }catch{} };
function clearAutoPopupFlags(){ try{ const ks=[]; for(let i=0;i<sessionStorage.length;i++){ const k=sessionStorage.key(i); if(k && k.startsWith('anes.autopopup.')) ks.push(k); } ks.forEach(k=>sessionStorage.removeItem(k)); }catch{} }

/* ========= State ========= */
let state={ sap:null,total:0,name:'', leader:[], rewards:{}, activities:[], activitiesMap:{}, lastSubmission:null, weeklyRemote: [], annual: [], activityIndex:{} };
let fb=null; let actIndex={};
let _submitting = false;

// ==== Pending KPI (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏ö‡∏ö Optimistic) ====
state._kpiServer = { earned:0, used:0, total:0 };   // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å RTDB ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
state._kpiPending = { earned:0, used:0, total:0 };  // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

function renderKPI(){
  const earned = state._kpiServer.earned + state._kpiPending.earned;
  const used   = state._kpiServer.used   + state._kpiPending.used;
  const total  = state._kpiServer.total  + state._kpiPending.total;
  $('#uEarned').textContent = fmt(earned);
  $('#uUsed').textContent   = fmt(used);
  $('#uTotal').textContent  = fmt(total);
}

// ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å RTDB ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå pending ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å Sync ‡πÅ‡∏•‡πâ‡∏ß
function reconcileKPIFromServer(newEarned, newUsed, newTotal){
  // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‚Äú‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô/‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï pending
  const changed = (
    newEarned !== state._kpiServer.earned ||
    newUsed   !== state._kpiServer.used   ||
    newTotal  !== state._kpiServer.total
  );
  state._kpiServer = { earned:newEarned, used:newUsed, total:newTotal };
  if (changed) {
    // ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏•‡πâ‡∏≤‡∏á pending ‡∏ó‡∏µ‡πà‡∏£‡∏≠
    state._kpiPending = { earned:0, used:0, total:0 };
  }
  renderKPI();
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î pending ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏îeltas (+/-)
function applyKPIDelta(deltaEarned=0, deltaUsed=0){
  state._kpiPending.earned += deltaEarned;
  state._kpiPending.used   += deltaUsed;
  state._kpiPending.total   = state._kpiPending.earned - state._kpiPending.used;
  renderKPI();
}

/* ========= Firebase ========= */
async function ensureFirebase(){ if(fb) return fb; const db = getDatabase(app); fb={ app, db, ref, onValue, get, off, child }; return fb; }

/* ========= Latest cache ========= */
const latestStoreKey = () => `anes.latest.${todayKey()}.${state.sap||'0'}`;
const saveLatestCache = x => { try{ localStorage.setItem(latestStoreKey(), JSON.stringify(x)); }catch{} };
const readLatestCache = () => { try{ return JSON.parse(localStorage.getItem(latestStoreKey())||'null'); }catch{ return null } };
const clearLatestCache = () => { try{ localStorage.removeItem(latestStoreKey()); }catch{} };

/* ========= Login / Logout (FAST + no-duplicate) ========= */
async function fetchUserQuickFast(sap){
  const DB = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";
  const paths = [
    `public/usersSummary/${encodeURIComponent(sap)}`,
    `public/users/${encodeURIComponent(sap)}`,
    `public/UsersSummary/${encodeURIComponent(sap)}`
  ];
  for (const p of paths){
    try{
      const r = await fetch(`${DB}/${p}.json?t=${Date.now()}`, { cache:'no-store' });
      if (!r.ok) continue;
      const u = await r.json();
      // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô object ‡πÅ‡∏•‡∏∞‡∏°‡∏µ field ‡πÉ‡∏î ‡πÜ ‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
      if (u && typeof u === 'object' && (
          'name' in u || 'Name' in u || 'PointsTotal' in u || 'pointsTotal' in u || 'Status' in u || 'active' in u
        )) {
        return u;
      }
    }catch(_){}
  }
  return null;
}

// ‡πÉ‡∏ä‡πâ gasJSONP ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
if (typeof window.gasJSONP !== 'function') {
  window.gasJSONP = function gasJSONP(params, timeoutMs=1800){
    return new Promise((resolve)=>{
      const cb='cb_'+Math.random().toString(36).slice(2);
      let done=false, timer=setTimeout(()=>{ if(!done){ done=true; resolve(null); } }, timeoutMs);
      window[cb]=d=>{ if(done) return; done=true; clearTimeout(timer); resolve(d); try{delete window[cb]; s.remove();}catch{} };
      const qs=new URLSearchParams({ ...params, callback:cb }).toString();
      const s=document.createElement('script');
      s.src = `${SCRIPT_URL}?${qs}`;
      s.onerror = ()=>{ if(done) return; done=true; clearTimeout(timer); resolve(null); };
      document.body.appendChild(s);
    });
  };
}

// ‡∏ñ‡∏≤‡∏° Apps Script ‡πÄ‡∏°‡∏∑‡πà‡∏≠ RTDB ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
async function checkUserStatusFast(sap){
  const r = await gasJSONP({ act:'userstatus', sap }, 1800);
  if (!r || r.ok !== true) return { found:false, active:false, name:'' };
  const hasFoundKey = ('found' in r) || ('exists' in r);
  const found  = hasFoundKey ? !!(r.found ?? r.exists) : (typeof r.active !== 'undefined');
  const active = !!r.active;
  const name   = r.name || '';
  return { found, active, name };
}

// ‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç
document.querySelector('#sap').addEventListener('input', e=>{
  e.target.value = e.target.value.replace(/[^\d]/g,'');
});

document.querySelector('#btnLogin').onclick = async () => {
  const sapEl = document.querySelector('#sap');
  const msgEl = document.querySelector('#loginMsg');
  const btn   = document.querySelector('#btnLogin');

  const sap = (sapEl.value || '').trim();
  if (!sap){ msgEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å SAP'; return; }

  btn.disabled = true;
  clearLoginMsg(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå/‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
document.querySelector('#loginMsg').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

  // 1) ‡πÄ‡∏ä‡πá‡∏Ñ RTDB ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡πá‡∏ß)
  let u = null;
  try { u = await fetchUserQuickFast(sap); } catch(_){ u = null; }

  // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Üí ‡∏ñ‡∏≤‡∏° GAS (‡∏°‡∏µ timeout)
  if (!u){
  const st = await checkUserStatusFast(sap);

  if (st.found && !st.active){
  showLoginError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Ä¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ admin');
  btn.disabled = false;
  return;
}
if (!st.found){
  showLoginError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Ä¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ admin');
  btn.disabled = false;
  return;
}

  // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ sync
  u = { name: st.name || sap, PointsEarned:0, PointsUsed:0, PointsTotal:0, active:true };
}

  // 3) ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å RTDB ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const rawStatus = (u.active ?? u.Status ?? u.status ?? u.Active ?? '');
  const ok = isActiveStatus(rawStatus);
if (!ok && rawStatus !== ''){
  showLoginError('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>non-active</b> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ admin');
  btn.disabled = false;
  return;
}

  // 4) ‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠ realtime
  msgEl.textContent = '';
  window.state = window.state || {};
  state.sap  = sap;
  state.name = (u.name || u.Name || sap);
  setWelcome(state.name);
  localStorage.setItem('SAP', sap);
  try{ localStorage.setItem('anes.session.v1', JSON.stringify({sap: state.sap, name: state.name})); }catch{}

  document.body.classList.remove('is-login');
  document.querySelector('#loginBox').style.display = 'none';
  document.querySelector('#btnLogout').style.display = 'inline-block';

  ['kpiBox','actTodayCard','rewardsBox','historyBox','weeklyBox']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='block'; });

  setTimeout(()=>{ try{
    attachRealtime();
    autoOpenOnceIfAvailable(true);
    scheduleAutoPopup();
  }catch(e){ console.error(e); } }, 0);
};

document.querySelector('#btnLogout').onclick = ()=>{
  try{
    localStorage.removeItem('SAP');
    localStorage.removeItem('anes.session.v1');
  }catch(_){}
  location.reload();
};

function showLoginError(msg){
  const el = document.querySelector('#loginMsg');
  el.innerHTML = msg;
  el.classList.remove('muted');
  el.classList.add('bad');   // <- .bad ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
}
function clearLoginMsg(){
  const el = document.querySelector('#loginMsg');
  el.textContent = '';
  el.classList.remove('bad');
  el.classList.add('muted');
}

/* ========= QR lock (10m) ========= */
const QRKEY=()=>`anes.qrlock.${state.sap||'0'}`; let lock=null, raf=null;
function loadLock(){ try{ const x=JSON.parse(localStorage.getItem(QRKEY())||'null'); if(!x) return null; if(Date.now()>x.until){ localStorage.removeItem(QRKEY()); return null } return x }catch{ return null } }
function saveLock(o){ lock=o; localStorage.setItem(QRKEY(),JSON.stringify(o)); }
function clearLock(){ lock=null; localStorage.removeItem(QRKEY()); }
function disableRedeem(dis){ document.querySelectorAll('.btnRedeem').forEach(b=>b.disabled=dis); }
function countdown(until){ const left=Math.max(0,until-Date.now()), mm=Math.floor(left/60000), ss=Math.floor((left%60000)/1000); $('#qrTimer').textContent=`${pad2(mm)}:${pad2(ss)}`; const b=$('#bannerTimer'); if(b) b.textContent=`${pad2(mm)}:${pad2(ss)}`; if(left<=0){ $('#qrExpired').style.display='block'; clearLock(); applyBanner(); if(raf) cancelAnimationFrame(raf); return; } raf=requestAnimationFrame(()=>countdown(until)); }
function applyBanner(){ const el=$('#lockBanner'); if(lock){ el.style.display='block'; $('#bannerShow').onclick=()=>openQR(lock,true); disableRedeem(true); } else { el.style.display='none'; disableRedeem(false); } }
function buildQRUrl(p){ const b64=btoa(unescape(encodeURIComponent(JSON.stringify(p)))); const url=`${ADMIN_PAGE_URL}#p=${encodeURIComponent(b64)}`; return `https://quickchart.io/qr?size=240&text=${encodeURIComponent(url)}`; }
$('#btnCloseQR').onclick=()=>$('#qrModal').style.display='none';
function openQR(o,fromResume=false){ $('#qrRewardName').textContent=o.reward; $('#qrPoints').textContent=fmt(o.pts); $('#qrExpired').style.display='none'; $('#qrAck').textContent=''; $('#qrImg').src=buildQRUrl({sap:o.sap,reward:o.reward,pts:o.pts,ts:o.ts,v:1}); $('#qrModal').style.display='flex'; countdown(o.until); if(!fromResume) applyBanner(); }
function createQR(name,pts){ if(!state.sap) return; if(lock){applyBanner();return;} const ts=new Date().toISOString(), until=Date.now()+10*60*1000; const o={sap:state.sap,reward:name,pts,ts,until}; saveLock(o); disableRedeem(true); openQR(o); }

/* ========= Weekly store ========= */
function weeklyKey(){ return `anes.weekly.${state.sap||'0'}`; }
function loadWeekly(){ try{ return JSON.parse(localStorage.getItem(weeklyKey())||'[]'); }catch{return []} }
function saveWeekly(arr){ localStorage.setItem(weeklyKey(), JSON.stringify(arr)); }
function addOrUpdateWeekly(e){ const arr=loadWeekly(); const i=arr.findIndex(x=>x.dateISO===e.dateISO && String(x.actId||'')===String(e.actId||'')); if(i>=0) arr[i]={...arr[i],...e}; else arr.push(e); saveWeekly(arr); renderWeekly(); }
function thisWeekRange(){ const d=new Date(); const day=(d.getDay()+6)%7; const start=new Date(d); start.setHours(0,0,0,0); start.setDate(d.getDate()-day); const end=new Date(start); end.setDate(start.getDate()+7); return [start,end]; }

/* ========= ‚Äú‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏µ‡∏ï‡∏£‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ========= */
function aKey(id){ return `anes.act.answered.${id}.${todayKey()}.${state.sap||'0'}`; }
function unmarkAns(id){ try{ localStorage.removeItem(aKey(id)); }catch{} }
function clinPairStoreKey(key){ return `anes.group.clinpair.${key}.${todayKey()}.${state.sap||'0'}`; }
function unmarkClinPair(key){ try{ localStorage.removeItem(clinPairStoreKey(key)); }catch{} }

function renderWeekly(){
  const [wStart, wEnd]=thisWeekRange();
  const localArr=loadWeekly().map(x=>({
    dateText:String(x.dateISO||x.ts||''),
    actId:String(x.actId||''),
    title:String(x.title||''),
    result:x.result,
    points:x.points,
    _source:'local'
  }));

    const remoteArr = (state.weeklyRemote || []).map(x => ({
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° x.dateText ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏£‡∏Å
    dateText: String(x.dateText || x.dateISO || x.ts || x.timestamp || ''),
    actId: String(x.actId || ''),
    title: String(x.title || ''),
    result: x.result,
    points: x.points,
    _source: 'remote'
  }));

  const pickByKey={};
  [...localArr,...remoteArr].forEach(x=>{
  const d = anyToDate(x.dateText);
  if(!d) return;
  if(!(d>=wStart && d<wEnd)) return;
  const key = (d.toISOString().slice(0,10)) + '|' + x.actId;
  const item = {
    _d: d,
    title: x.title || (getActMetaById(x.actId)||{}).Title || (getActMetaById(x.actId)||{}).Question || x.actId || '-',
    result: x.result,
    points: Number(x.points||0),
    _source: x._source
  };
  const prev = pickByKey[key];
  if(!prev){ pickByKey[key]=item; return; }
  const better = (prev._source!=='remote' && item._source==='remote') || (item.points > prev.points);
  if(better) pickByKey[key]=item;
});

  const merged = Object.values(pickByKey).sort((a,b)=> b._d - a._d);
  const html = merged.length
    ? merged.map(r=>{
        const th = thaiDate(r._d);
        const result=r.result==null?'‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à':(r.result?'‡∏ñ‡∏π‡∏Å':'‡∏ú‡∏¥‡∏î');
        const pts=(r.points==null)?'‚Äî':fmt(r.points);
        return `<tr><td>${th}</td><td>${escapeHtml(r.title)}</td><td>${result}</td><td>${pts}</td></tr>`;
      }).join('')
    : '<tr><td colspan="4" style="text-align:center">‚Äî</td></tr>';

  $('#weekly').innerHTML=html;
  $('#weeklyBox').style.display='block';
}

/* ========= Annual ========= */
function renderAnnual(){
  const box=$('#annualBox'); const tb=$('#annual'); if(!box||!tb) return;

  const raw = Array.isArray(state.annual) ? state.annual : Object.values(state.annual||{});

  // sort ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ anyToDate
  const list = raw.slice().sort((a,b)=>{
    const da = anyToDate(a.timestamp ?? a.awardedAt ?? a.AwardedAt);
    const db = anyToDate(b.timestamp ?? b.awardedAt ?? b.AwardedAt);
    return (db?.getTime()||0) - (da?.getTime()||0);
  });

  if(!list.length){
    tb.innerHTML='<tr><td colspan="3" style="text-align:center">‚Äî</td></tr>';
    box.style.display='block';
    return;
  }

  const rows = list.map(r=>{
    const d  = anyToDate(r.timestamp ?? r.awardedAt ?? r.AwardedAt);
    const dt = thaiDate(d);
    const title = String(r.title||r.Title||`‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${r.formNo||r.FormNo||''}`).trim();
    const total = Number(r.totalPoints ?? (Number(r.basePoints||r.BasePoints||0)+Number(r.bonusPoints||r.BonusPoints||0)))||0;
    return `<tr><td>${dt}</td><td>${escapeHtml(title)}</td><td style="text-align:center">${total}</td></tr>`;
  }).join('');

  tb.innerHTML = rows;
  box.style.display='block';
}

function parseLocal(s){ if(!s) return NaN; let t=String(s).trim(); t=t.replace(/([+\-]\d{2}):?(\d{2})$/, (m,hh,mm)=>{ const ok=['00','30','45']; return `${hh}:${ok.includes(mm)?mm:'00'}`; }).replace(/([+\-])(\d)(?=:)/,(_,sign,d)=>`${sign}0${d}`); if(/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(t)){ const ts=new Date(t.replace(' ','T')).getTime(); if(!Number.isNaN(ts)) return ts; } const ts2=new Date(t).getTime(); if(!Number.isNaN(ts2)) return ts2; const m=t.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/); if(m){ const y=Number(m[3])<100?2000+Number(m[3]):Number(m[3]); const mm=Number(m[2])-1; const dd=Number(m[1]); const hh=Number(m[4]||0); const mi=Number(m[5]||0); return new Date(y,mm,dd,hh,mi).getTime(); } return NaN; }
function isIn(st,en){ const now=Date.now(); const a=parseLocal(st); const b=parseLocal(en); if(Number.isNaN(a)&&Number.isNaN(b)) return true; if(Number.isNaN(a)) return now<=b; if(Number.isNaN(b)) return now>=a; const start=Math.min(a,b); const end=Math.max(a,b); return now>=start && now<=end; }
function isTodayLocal(str){ const t=parseLocal(str); if(Number.isNaN(t)) return false; const d=new Date(t), n=new Date(); return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate(); }
function hasAns(id){
  if(!id) return false;

  // ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
  if(localStorage.getItem(aKey(id))) return true;

  // ‚úÖ ‡∏î‡∏π‡∏Ñ‡∏µ‡∏¢‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢: ans:YYYY-MM-DD:SAP:ActID (‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢)
  const k2 = `ans:${todayKey('Asia/Bangkok')}:${state.sap||''}:${id}`;
  if(localStorage.getItem(k2)) return true;

  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (optimistic)
  const x = state.lastSubmission;
  if(!x) return false;
  const same = String(x.actId||'') === String(id||'');
  const ts   = x.ts || x.timestamp;
  if(!ts) return false;
  const d = new Date(ts), n = new Date();
  return same && d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate();
}

function titleClinType(t){ const s=String(t||'').toLowerCase(); if(/\bnon[-\s]?clinical\b/.test(s) || /(non[-\s]?clinical)/i.test(t)) return 'nonclin'; if(/\bclinic\b/.test(s) || /\bclinical\b/.test(s) || /(clinic)/i.test(t)) return 'clin'; return null; }
function pairKeyOf(a){ const g=a.GroupId||a.groupId||''; const t=a.Title||a.Question||''; const tag=titleClinType(t); return (g && tag)?String(g):null; }

/* ========= Preload activities for titles ========= */
let _allActsLoaded=false;
async function preloadAllActivities(){ if(_allActsLoaded) return; _allActsLoaded=true; try{ const r=await fetch(`${DB_URL}/public/activities.json?t=${Date.now()}`,{cache:'no-store'}); const all=r.ok?await r.json():null; if(all){ Object.values(all).forEach(a=>{ const id=a.ActID||a.id||a.actId; if(id) state.activityIndex[id]=a; }); renderWeekly(); } }catch{} }
function getActMetaById(id){ if(!id) return null; if(actIndex && actIndex[id]) return actIndex[id]; const todays=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{}); const hit=todays.find(a=>(a.ActID||a.id||a.actId)===id); if(hit) return hit; if(state.activityIndex && state.activityIndex[id]) return state.activityIndex[id]; return null; }

/* ========= Realtime wires ========= */
async function attachRealtime(){
  const FB=await ensureFirebase();
  await preloadAllActivities();

  onValue(ref(FB.db,'public/usersSummary/'+state.sap), s=>{
  const v = s.val() || {};
  state.total = Number(v.pointsTotal||v.PointsTotal||0);

  ['kpiBox','actTodayCard','rewardsBox','historyBox','weeklyBox']
    .forEach(id=>$('#'+id).style.display='block');

  const earned = Number(v.pointsEarned||v.PointsEarned||0);
  const used   = Number(v.pointsUsed  ||v.PointsUsed  ||0);
  const total  = Number(v.pointsTotal ||v.PointsTotal || (earned - used) || 0);

  reconcileKPIFromServer(earned, used, total);

  // ‡πÇ‡∏´‡∏•‡∏î lock ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ü‡∏£‡∏°‡πÅ‡∏£‡∏Å enable
  lock = loadLock();
  applyBanner();
  if (lock) openQR(lock, true);

  renderRewards();          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å lock ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
  renderWeekly();
});

  onValue(ref(FB.db,'public/redemptions/'+state.sap), s=>{
    const arr=s.val()||[];
    $('#history').innerHTML = Array.isArray(arr)&&arr.length
      ? arr.slice(-50).reverse().map(x=>`<tr><td>${escapeHtml((x.timestamp||'').replace('T',' ').slice(0,19))}</td><td>${escapeHtml(x.rewardName||'')}</td><td>${fmt(x.points||0)}</td><td>${escapeHtml(x.status||'')}</td></tr>`).join('')
      : '<tr><td colspan="4" style="text-align:center">‚Äî</td></tr>';
  });

  onValue(ref(FB.db,'public/rewards'), s=>{ state.rewards=s.val()||{}; renderRewards(); if(lock) disableRedeem(true); });
  onValue(ref(FB.db,'public/leaderboard'), s=>{ state.leader=s.val()||[]; });
  onValue(ref(FB.db,'public/actIndex'), snap=>{ actIndex=snap.val()||{}; renderWeekly(); renderLatest(state.lastSubmission||readLatestCache()); });

  onValue(ref(FB.db,'public/redeemAck/'+state.sap), s=>{
    const a=s.val(); if(!a) return; const key=`ack:${state.sap}:${a.timestamp||''}:${a.rewardName||''}`; if(localStorage.getItem(key)) return; localStorage.setItem(key,'1'); try{$('#qrModal').style.display='none';}catch{}; const dt=(a.timestamp||'').replace('T',' ').slice(0,19); toast(`‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡πâ‡∏ß<br><b>${escapeHtml(a.rewardName||'')}</b><br>${escapeHtml(dt)} ‚Ä¢ ‡πÇ‡∏î‡∏¢ ${escapeHtml(a.admin||'admin')}`,4500); $('#qrAck').textContent=`‡πÅ‡∏•‡∏Å "${a.rewardName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì ‡πÇ‡∏î‡∏¢ ${a.admin||'admin'}`; clearLock(); applyBanner(); renderRewards();
  });

  preloadAllActivities();
  wireWeeklyRealtime();
  wireAnnualRealtime();

  ensureActivitiesRealtime();
}

/* ========= Rewards render ========= */
function renderRewards(){
  const data = state.rewards || {};

  // ‡πÅ‡∏õ‡∏•‡∏á/‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  const needOf = (v) =>
    Number(v.pointsRequired ?? v.PointsRequired ?? v.points ?? 0) || 0;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢ (tie-break ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠/‡∏™‡∏ï‡πá‡∏≠‡∏Å)
  const list = Object.entries(data)
    .map(([name, v]) => ({
      name,
      v,
      need: needOf(v),
      stock: Number(v.stock ?? v.Stock ?? 0) || 0
    }))
    .sort((a, b) => (b.need - a.need) || (b.stock - a.stock) || a.name.localeCompare(b.name, 'th'));

  const html = list.map(({name, v, need, stock}) => {
    // active guard (‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö true/false, ‚Äúactive/non-active‚Äù, 1/0, ‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
    const isTrue = (x) => {
      const s = String(x ?? '').trim().toLowerCase();
      if (typeof x === 'boolean') return x;
      if (!s) return false;
      if (['false','0','no','off','inactive','non-active','‡∏õ‡∏¥‡∏î','‡∏á‡∏î','‡∏´‡∏¢‡∏∏‡∏î'].includes(s)) return false;
      if (['true','1','yes','on','active','‡πÄ‡∏õ‡∏¥‡∏î','‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'].includes(s)) return true;
      return false;
    };
    const active = isTrue(v.Active ?? v.active);

    const lockNow = (lock ?? loadLock());
    const can = (state.total >= need && stock > 0 && !lockNow && need > 0 && active);

    const raw = (v.imageUrl || v.ImageURL || v.Image || '');
    const url = (() => {
      const u = fixImg(raw);
      if (!u) return '';
      const join = u.includes('?') ? '&' : '?';
      return u + join + 'v=' + encodeURIComponent(v.UpdatedAt || '');
    })();

    const idForThumb = extractId(url);
    return `
      <div class="reward">
        <img loading="lazy" decoding="async"
             src="${url || 'https://via.placeholder.com/56?text=%20'}"
             data-thumb="${idForThumb ? driveThumb(idForThumb) : ''}"
             onerror="this.onerror=null; if(this.dataset.thumb){ this.src=this.dataset.thumb; this.dataset.thumb=''; } else { this.src='https://via.placeholder.com/56?text=%20'; }"
             alt="${escapeHtml(name)}">
        <div style="flex:1">
          <b>${escapeHtml(name)}</b>
          <div class="muted">${Number(need).toLocaleString('th-TH')} ‡πÅ‡∏ï‡πâ‡∏° ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Number(stock).toLocaleString('th-TH')}</div>
        </div>
        <button class="btnRedeem" ${can ? '' : 'disabled'} data-name="${escapeHtml(name)}" data-need="${need}">‡πÅ‡∏•‡∏Å</button>
      </div>`;
  }).join('') || '<div class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî</div>';

  $('#rewards').innerHTML = html;
  document.querySelectorAll('.btnRedeem').forEach(b=>{
    b.onclick = () => { if(b.disabled) return; createQR(b.dataset.name, Number(b.dataset.need||0)); };
  });
}

/* ========= Top 20 (dialog) ========= */
$('#btnTop20').onclick = async () => {
  try {
    const FB = await ensureFirebase();
    const snap = await FB.get(FB.ref(FB.db, 'public/usersSummary'));
    const users = snap.val() || {};

    const top = Object.values(users).map(u => {
      const name  = String(u.name || u.Name || u.sap || u.SAP || '-').trim();
      const total = Number(
        u.PointsTotal ?? u.pointsTotal ??
        (Number(u.PointsEarned ?? u.pointsEarned ?? 0) - Number(u.PointsUsed ?? u.pointsUsed ?? 0))
      ) || 0;
      return { name, total };
    }).sort((a,b) => b.total - a.total).slice(0,20);

    const thead = `
      <thead>
        <tr>
          <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°</th>
        </tr>
      </thead>`;

    const tbody = `<tbody>${
      top.map((r,i) => `
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(r.name || '-')}</td>
          <td>${fmt(r.total)}</td>
        </tr>
      `).join('')
    }</tbody>`;

    $('#dlgTopTitle').textContent = 'Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°';
    $('#dlgTopBody').innerHTML = `<table class="top20-table">${thead}${tbody}</table>`;
    $('#dlgTop').showModal();
  } catch (e) {
    console.error(e);
    $('#dlgTopTitle').textContent = 'Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°';
    $('#dlgTopBody').textContent = '‚Äî';
    $('#dlgTop').showModal();
  }
};

/* ========= Activities realtime ========= */
let actOpen=false, _autoTimer=null;
function renderActList(){ $('#actList').innerHTML=''; $('#actList').style.display='none'; }

function ensureActivitiesRealtime(){ (async ()=>{
  const FB=await ensureFirebase(); const tk=todayKey(); const aref=FB.ref(FB.db,'public/activitiesByDate/'+tk);
  FB.onValue(aref, async s=>{
    let obj=s.val()||{}; let arr=Array.isArray(obj)? obj : Object.values(obj||{});
    if(!arr.length){ try{ const r=await fetch(`${DB_URL}/public/activities.json?t=${Date.now()}`,{cache:'no-store'}); const all=(await r.json())||{}; arr=Object.values(all).filter(a=>{ const active=String((a.Active==null?'TRUE':a.Active)).toLowerCase()!=='false'; return active && isTodayAct(a); }); }catch{} }
    state.activities=arr; state.activitiesMap={}; arr.forEach(a=>{ const gid=(a.GroupId||''); (state.activitiesMap[gid] ||= []).push(a); });
    renderWeekly(); renderLatest(state.lastSubmission||readLatestCache()); checkActivity(); renderActList(); autoOpenOnceIfAvailable(); scheduleAutoPopup();
  });
})(); }

function extractDateKey(s){ const m=String(s||'').match(/\b(20\d{2}-\d{2}-\d{2})\b/); return m?m[1]:null; }
function groupDate(a){ return extractDateKey(a.GroupId||a.groupId) || extractDateKey(a.ActID||a.id||a.actId); }
function isTodayAct(a){ const k=todayKey(); const gd=groupDate(a); if(gd) return gd===k; return isTodayLocal(a.WindowStart) || isTodayLocal(a.WindowEnd); }

function pickAct(){
  const list=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{});
  const cand=list.filter(a=>{ const active=String((a.Active==null?'TRUE':a.Active)).toLowerCase()!=='false'; if(!active) return false; const id=a.ActID||a.id||a.actId; if(!id) return false; if(!isTodayAct(a)) return false; if(hasAns(id)) return false; if(!isIn(a.WindowStart,a.WindowEnd)) return false; const pk=pairKeyOf(a); if(pk && localStorage.getItem(clinPairStoreKey(pk))) return false; return true; }).sort((x,y)=>parseLocal(x.WindowStart)-parseLocal(y.WindowStart));
  if(!cand.length) return null;
  const byPair={}; cand.forEach(a=>{ const pk=pairKeyOf(a); if(!pk) return; (byPair[pk]=byPair[pk]||[]).push(a); });
  const pair=Object.entries(byPair).find(([pk,arr])=> arr.length>=2 && !localStorage.getItem(clinPairStoreKey(pk)));
  if(pair){ const list2=pair[1].slice(0,2).sort((x,y)=>parseLocal(x.WindowStart)-parseLocal(y.WindowStart)); return { twoStep:'clinPair', list:list2 }; }
  return cand[0];
}

function autoOpenOnceIfAvailable(force=false){ if(!state.sap || actOpen) return; const pick=pickAct(); if(!pick){ scheduleAutoPopup(); return; } const id= pick.twoStep==='clinPair' ? ('GROUP:'+pairKeyOf(pick.list[0])) : (pick.ActID||pick.id||pick.actId); const key=`anes.autopopup.${todayKey()}.${id}`; if(!force && sessionStorage.getItem(key)) return; sessionStorage.setItem(key,'1'); if(pick.twoStep==='clinPair') openActSelector(pick); else openAct(pick); }
function scheduleAutoPopup(){ clearTimeout(_autoTimer); if(!state.sap) return; const now=Date.now(); const upcoming=getTodayActs().filter(a=>{ const id=a.ActID||a.id||a.actId; if(!id) return false; if(hasAns(id)) return false; const pk=pairKeyOf(a); if(pk && localStorage.getItem(clinPairStoreKey(pk))) return false; const st=parseLocal(a.WindowStart); return !Number.isNaN(st) && st>now; }).sort((a,b)=> parseLocal(a.WindowStart)-parseLocal(b.WindowStart)); if(!upcoming.length) return; const when=Math.max(250, parseLocal(upcoming[0].WindowStart)-now+200); _autoTimer=setTimeout(()=> autoOpenOnceIfAvailable(), when); }
window.addEventListener('focus', ()=> autoOpenOnceIfAvailable());
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) autoOpenOnceIfAvailable(); });
function getTodayActs(){ const l=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{}); return l.filter(isTodayAct); }

/* ========= Winners ========= */
function currentActForWinners(){ const acts=getTodayActs().slice().sort((a,b)=>(parseLocal(a.WindowStart)||0)-(parseLocal(b.WindowStart)||0)); if(!acts.length) return null; if(state.lastSubmission && acts.some(a=>(a.ActID||a.id||a.actId)===state.lastSubmission.actId)){ return acts.find(a=>(a.ActID||a.id||a.actId)===state.lastSubmission.actId); } const inwin=acts.find(a=> isIn(a.WindowStart,a.WindowEnd)); return inwin || acts[0]; }
async function readJson(path){ try{ const r=await fetch(`${DB_URL}/${path}.json?t=${Date.now()}`,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
async function fetchWinnersTable(today, actId){
  const paths = [
    actId ? `public/winnersByDate/${today}/${encodeURIComponent(actId)}` : null,
    `public/winnersByDate/${today}`
  ].filter(Boolean);

  for (const p of paths){
    const data = await readJson(p);
    if (!data) continue;

    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏°‡∏µ __table
    if (data.__table && Array.isArray(data.__table.rows)){
      // map ‡πÅ‡∏Ñ‡πà 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å: ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö, ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
      const rows = data.__table.rows.map(r => [ String(r[0] ?? ''), String(r[1] ?? '') ]);
      return { cols:['‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], rows };
    }

    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡πÅ‡∏ö‡∏ö: __list = [{rank,sap,name,ts}]
    if (Array.isArray(data.__list)){
      const rows = data.__list.map(x => [
        String(x.rank ?? ''),
        String(x.name ?? x.sap ?? '-')
      ]);
      return { cols:['‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], rows };
    }

    // ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°: object ‡∏ï‡πà‡∏≠ SAP { sap, name, ts }
    const items = Object.entries(data)
      .filter(([k]) => !k.startsWith('__'))
      .map(([,v]) => v)
      .filter(Boolean)
      .sort((a,b) => new Date(a.ts||a.timestamp||0) - new Date(b.ts||b.timestamp||0));

    if (items.length){
      const seen = new Set(), rows=[];
      for (const it of items){
        const sap = String(it.sap || it.SAP || '');
        if (!sap || seen.has(sap)) continue;
        seen.add(sap);
        rows.push([
          String(rows.length+1),
          String(it.name || sap)
        ]);
        if (rows.length >= 20) break;
      }
      return { cols:['‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], rows };
    }
  }

  return { cols:['‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], rows:[] };
}

async function loadTop20Winners(today, actId){
  const paths=[ actId?`public/winnersByDate/${today}/${encodeURIComponent(actId)}`:null, `public/winnersByDate/${today}` ].filter(Boolean);
  for(const p of paths){ const data=await readJson(p); if(!data) continue; if(typeof data==='object'){ const arr=Object.values(data).flatMap(v=> Object.values(v||{})); if(arr.length){ arr.sort((a,b)=> new Date(a.ts||a.timestamp||0) - new Date(b.ts||b.timestamp||0)); const seen=new Set(); const out=[]; for(const it of arr){ const sap=it.sap||it.SAP; if(!sap || seen.has(sap)) continue; seen.add(sap); out.push({ sap:String(sap), ts: it.ts||it.timestamp||null }); if(out.length>=20) break; } return out; } }
  }
  return [];
}

$('#btnWinners').onclick = async () => {
  const today = todayKey();
  const act   = currentActForWinners();
  const actId = act ? (act.ActID||act.id||act.actId) : null;
  const actTitle = act ? (act.Title||act.Question||actId||'') : '';

  $('#dlgTopTitle').textContent = actTitle
    ? `Top 20 (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ) ‚Äî ${actTitle}`
    : 'Top 20 (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';

  const table = await fetchWinnersTable(today, actId);

  if (table.rows && table.rows.length){
    const thead = `<thead><tr>${table.cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${
      table.rows.map(r=>`<tr>${
        r.map((c,i)=> `<td${i===0? ' style="width:80px;text-align:center"':''}>${escapeHtml(String(c))}</td>`).join('')
      }</tr>`).join('')
    }</tbody>`;
    $('#dlgTopBody').innerHTML =
  `<table class="top20-table">
     ${thead}
     ${tbody}
   </table>`;
  } else {
    $('#dlgTopBody').innerHTML = '‚Äî';
  }
  $('#dlgTop').showModal();
};

/* ========= Open activity UI ========= */
function openActSelector(group){ const box=$('#chooseBody'); box.innerHTML=group.list.map((a,i)=>`<button class="ghost" data-i="${i}" style="flex:1">${escapeHtml(a.Title||('‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '+(i+1)))}</button>`).join(''); box.querySelectorAll('button').forEach(btn=>btn.onclick=()=>{ const i=Number(btn.dataset.i||0); $('#chooseModal').style.display='none'; openAct(group.list[i]); }); $('#btnChooseClose').onclick=()=>$('#chooseModal').style.display='none'; $('#chooseModal').style.display='flex'; }

function openAct(act){
  actOpen=true; const id=act.ActID||act.id||act.actId; const t=String(act.InputType||'MCQ').toUpperCase().replace(/[^A-Z0-9]/g,'');
  $('#actTitle').textContent=(act.Question||act.Title||''); $('#actQuestion').style.display='none'; $('#actQuestion').textContent=''; $('#actStatus').textContent=''; const box=$('#actOpts');
  if(['NUM2','NUM','NUMBER','NUMERIC'].includes(t)) { box.innerHTML=`<input id="actText" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" maxlength="2" inputmode="numeric" style="width:140px;text-align:center">`; setTimeout(()=>{ const inp=$('#actText'); try{ inp.focus(); }catch{}; inp.addEventListener('input', e => e.target.value = e.target.value.replace(/[^\d]/g,'').slice(0,2)); inp.addEventListener('keydown',e=>{ if(e.key==='Enter') $('#btnActSubmit').click(); }); },0); }
  else if(t==='TEXT') { box.innerHTML=`<input id="actText" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" style="width:100%">`; setTimeout(()=>{ try{$('#actText').focus();}catch{} },0); }
  else {
    const labels = ['A','B','C','D'];
    const options = ['OptionA','OptionB','OptionC','OptionD'].map(k=>act[k]).filter(v=>v!=null&&String(v).trim()!=='');
    box.innerHTML = options.length
      ? options.map((t,i)=> {
          const L = labels[i];
          return `<label style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
                    <input type="radio" name="actOpt" value="${L}">
                    <span><b>${L}.</b> ${escapeHtml(String(t))}</span>
                  </label>`;
        }).join('')
      : '<div class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</div>';
  }
  $('#actModal').style.display='flex';

 $('#btnActSubmit').onclick = async () => {
  if (_submitting) return;
  _submitting = true;
  try {
    // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥ (‡∏ù‡∏±‡πà‡∏á client)
    const id = act.ActID || act.id || act.actId;
    if (localStorage.getItem(aKey(id))) {
      $('#actStatus').textContent = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
      $('#actModal').style.display = 'none';   // ‚úÖ ‡∏õ‡∏¥‡∏î modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      actOpen = false;
      return;
    }

    // ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    let ans;
    if (['NUM2','NUM','NUMBER','NUMERIC','TEXT'].includes(t)) {
      ans = ($('#actText').value || '').trim();
      if (t !== 'TEXT' && !/^\d{2}$/.test(ans)) {
        $('#actStatus').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (00‚Äì99)';
        try { $('#actText').focus(); } catch(_){}
        return;
      }
    } else {
      const chk = document.querySelector('input[name="actOpt"]:checked');
      if (!chk) { $('#actStatus').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö'; return; }
      ans = String(chk.value || '').trim().toUpperCase();
    }

    // ‡∏ï‡∏µ‡∏ï‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (optimistic)
    localStorage.setItem(aKey(id),'1');
    const pk = pairKeyOf(act); if (pk) localStorage.setItem(clinPairStoreKey(pk),'1');
    localStorage.setItem('anes.act.lastAns.' + id + '.' + (state.sap || ''), ans);

    // payload
    const key = 'ans_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const ts  = new Date().toISOString();
    const payload = { sap: state.sap, actId: id, answer: ans, timestamp: ts, client: 'web-anesa+' };

    // Optimistic UI (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ MCQ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏â‡∏•‡∏¢)
    const isNumeric = ['NUM2','NUM','NUMBER','NUMERIC'].includes(t);
    const hasAnswer = String(act.Answer || '').trim() !== '';
    const instantOK = (!isNumeric && hasAnswer) ? clientIsCorrect(act, ans) : null;
    const instantPts = (instantOK === true) ? (Number(act.BasePoints||0) + Number(act.CorrectBonus||0)) : 0;
    if (instantOK === true && instantPts > 0) {
      applyKPIDelta(instantPts, 0);
    }
    const optimistic = { actId: id, title: (act.Title || id), ts, correct: instantOK, points: (instantOK ? instantPts : 0), userAnswer: ans, Finalized: false };
    state.lastSubmission = optimistic;
    renderLatest(optimistic);
    addOrUpdateWeekly({ dateISO: ts, title: optimistic.title, actId: id, result: optimistic.correct, points: optimistic.points, Finalized: false });

    $('#actModal').style.display = 'none';
    actOpen = false;
    toast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 1200);
    $('#btnActNow').disabled = true;
    checkActivity();

    // PUT queue ‚Üí RTDB
    try {
      await fetch(DB_URL + '/public/answersQueue/' + encodeURIComponent(key) + '.json', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch(_) {}

    // Apps Script: queue:process
    let server = null;
    try{
      const r = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'queue:process', key, item: payload })
      });
      server = await r.json();
    }catch(_){}

    // ‚¨ÖÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Non-active
    if (server && server.error === 'USER_NON_ACTIVE') {
      toast('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Non-active</b><br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 4000);
      // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏µ‡∏ï‡∏£‡∏≤‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
      unmarkAns(id);
      const pk2 = pairKeyOf(act); if (pk2) unmarkClinPair(pk2);
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏∏‡πà‡∏°
      $('#btnActNow').disabled = false;
      checkActivity();
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•
    if (server && server.ok) {
      const final = {
        actId: id,
        title: optimistic.title,
        ts: ts,
        correct: (server.correct === 'TRUE' ? true : (server.correct === 'FALSE' ? false : null)),
        points: Number(server.points || 0),
        userAnswer: ans,
        Finalized: (server.correct !== 'PENDING')
      };

      const delta = Number(final.points || 0) - Number(instantPts || 0);
      if (delta !== 0) applyKPIDelta(delta, 0);

      state.lastSubmission = final;
      renderLatest(final);
      addOrUpdateWeekly({ dateISO: ts, title: final.title, actId: id, result: final.correct, points: final.points, Finalized: final.Finalized });
    } else {
      // fallback ‚Üí ‡∏¢‡∏¥‡∏á submit ‡∏ï‡∏£‡∏á
      const res = await postSubmissionToSheet(payload);
      if (res && res.error === 'USER_NON_ACTIVE') {
        toast('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Non-active</b><br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 4000);
        unmarkAns(id); const pk2 = pairKeyOf(act); if (pk2) unmarkClinPair(pk2);
        $('#btnActNow').disabled = false; checkActivity();
        return;
      }
      if (res && res.ok){
        const final = {
          actId: id, title: optimistic.title, ts: ts,
          correct: (res.correct === 'TRUE' ? true : (res.correct === 'FALSE' ? false : null)),
          points: (res.points == null ? 0 : Number(res.points)),
          userAnswer: ans, Finalized: true
        };
        const delta2 = Number(final.points || 0) - Number(instantPts || 0);
        if (delta2 !== 0) applyKPIDelta(delta2, 0);

        state.lastSubmission = final;
        renderLatest(final);
        addOrUpdateWeekly({ dateISO: ts, title: final.title, actId: id, result: final.correct, points: final.points, Finalized: true });
      }
    }

  } catch (err) {
    console.error(err);
    $('#actStatus').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
  } finally {
    _submitting = false;
  }
};

  $('#btnActClose').onclick=()=>{ $('#actModal').style.display='none'; actOpen=false; };
}

function renderLatest(x){
  const box=$('#actLatest'); const isTodayTs=ts=>{ if(!ts) return false; const d=new Date(ts), n=new Date(); return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate(); };
  const acts=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{});
  const hasTodayData=obj=> !!obj && ( isTodayTs(obj.ts) || (!!obj.actId && acts.some(a=>(a.ActID||a.id||a.actId)===obj.actId)) );
  const data=hasTodayData(x)? x : readLatestCache(); if(!hasTodayData(data)) return; saveLatestCache(data);
  const act=acts.find(a=>(a.ActID||a.id||a.actId)===data.actId) || {}; const your=(data.userAnswer || localStorage.getItem(`anes.act.lastAns.${data.actId||''}.${state.sap||''}`) || '‚Äî')+''; const ansKey=(act.Answer||'')+'';
  const mapAnswerText = (act, raw) => {
     const K = String(raw||'').trim().toUpperCase();
     const optMap = {A:act.OptionA, B:act.OptionB, C:act.OptionC, D:act.OptionD};
     if(['A','B','C','D'].includes(K)){
       const t = optMap[K];
       return t ? `${K}. ${t}` : K;
     }
     const m = String(raw||'').trim().match(/^([A-D‡∏Å-‡∏á])[\.\)]?/i);
     const L = m ? m[1].toUpperCase() : '';
     if(L){
       const t = optMap[L];
       return t ? `${L}. ${t}` : raw;
     }
     return raw;
  };

  const ansText=ansKey ? mapAnswerText(act, ansKey) : '';
  let verdict=''; if(data.correct===true){ verdict=`<span class="ok">‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>${(data.points!=null && data.points>0)?` ‚Ä¢ +${data.points} ‡πÅ‡∏ï‡πâ‡∏°`:''}`; } else if(data.correct===false){ const reveal=ansKey?` ‚Ä¢ ‡πÄ‡∏â‡∏•‡∏¢: <b>${escapeHtml(ansText)}</b>`:''; verdict=`<span class="bad">‡∏™‡∏π‡πâ‡∏™‡∏π‡πâ‡∏ô‡πä‡∏≤‡∏≤‡∏≤‡∏≤</span>${reveal}`; } else { verdict=`<span class="muted">‚åõ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`; }
  const qText=(act.Question||act.Title||data.title||data.actId||'-')+'';
  const html=`<div><b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</b> ${escapeHtml(qText)}</div><div><b>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</b> ${escapeHtml(your)} ‚Ä¢ ${verdict}</div>`;
  box.innerHTML=html; box.style.display='block';
}

function checkActivity(){ if(!state.sap){ $('#actTodayCard').style.display='none'; return; } $('#actTodayCard').style.display='block'; const pick=pickAct(); $('#btnActNow').disabled=!pick; renderActList(); }
$('#btnActNow').onclick=()=>{ const pick=pickAct(); if(!pick){ $('#btnActNow').disabled=true; return; } if(pick.twoStep==='clinPair'){ openActSelector(pick); } else { openAct(pick); } };

function mapWeeklyRow(it){ const dateText=String(it.dateISO||it.ts||it.timestamp||it.Date||it.date||it.time||''); const actId=String(it.actId||it.ActID||it.ActivityId||it.activityId||it.setId||it.GroupId||it.FormId||''); let title=String(it.title||it.Title||it.ActivityTitle||it.FormTitle||it.name||it.question||''); if(!title && actId){ const meta=getActMetaById(actId); if(meta) title=meta.Title||meta.Question||''; } const r=(it.result ?? it.Result ?? it.correct ?? it.Correct); let result=null; if(r===true || String(r).toLowerCase()==='true' || String(r)==='1') result=true; if(r===false || String(r).toLowerCase()==='false' || String(r)==='0') result=false; const points=Number(it.points ?? it.Points ?? it.point ?? it.award ?? it.Award ?? it.pointsAwarded ?? it.Score ?? 0) || 0; return { dateText, actId, title, result, points }; }

async function wireWeeklyRealtime(){
  const FB = await ensureFirebase();
  const unsub = [];
  const paths = [
    `public/weeklyByUser/${state.sap}`,
    `public/FormAwardsByUser/${state.sap}`,
    `public/formAwardsByUser/${state.sap}` // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢
  ];
  paths.forEach(p => {
    const r = ref(FB.db, p);
    const stop = onValue(r, snap => {
      const obj = snap.val() || {};
      const arr = Array.isArray(obj) ? obj : Object.values(obj);
      if (!arr.length) return;
      state.weeklyRemote = arr.map(mapWeeklyRow);
      renderWeekly();
    });
    unsub.push(() => off(r));
  });
  state.offWeekly = () => unsub.forEach(f => f && f());
}


/* ========= Annual realtime ========= */
state.offAnnual && state.offAnnual();
async function wireAnnualRealtime(){ const FB=await ensureFirebase(); const r=ref(FB.db,'public/annualByUser/'+state.sap); state.offAnnual = onValue(r, snap=>{ const val=snap.val()||{}; const arr=Array.isArray(val)? val : Object.entries(val).map(([k,v])=>({_key:k,...v})); state.annual = arr.filter(Boolean).sort((a,b)=> new Date(b.timestamp||b.awardedAt||0) - new Date(a.timestamp||a.awardedAt||0)).slice(0,200); renderAnnual(); }); }

/* ========= Auto restore ========= */
(function restoreSession(){ const sess=readSession(); if(!sess||!sess.sap) return; state.sap=sess.sap; state.name=sess.name||sess.sap; setWelcome(state.name); document.body.classList.remove('is-login'); $('#loginBox').style.display='none'; $('#btnLogout').style.display='inline-block'; $('#actTodayCard').style.display='block'; renderLatest(readLatestCache()); clearAutoPopupFlags(); attachRealtime(); autoOpenOnceIfAvailable(true); scheduleAutoPopup(); })();

/* ========= Heartbeat ========= */
setInterval(()=>{ if(!state.sap) return; try{ if(!actOpen){ checkActivity(); autoOpenOnceIfAvailable(); } }catch{} }, 5000);

// ===== Client-side correctness helper (instant MCQ) =====
function _normStr(s){
  return String(s||'').replace(/[.\u200b]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
}
function stripChoicePrefix_(s){
  return String(s||'').replace(/^\s*([A-D‡∏Å-‡∏á])[\.\)]?\s*/i,'');
}
function clientIsCorrect(meta, userAns){
  const cat = String(meta.Category||'');
  if(/DAY(1|16)_LOTTO/i.test(cat)){
    const u2 = String(userAns||'').replace(/\D/g,'').slice(-2);
    const a2 = String(meta.Answer||'').replace(/\D/g,'').slice(-2);
    return (u2 && a2 && u2===a2);
  }
  const a = _normStr(stripChoicePrefix_(meta.Answer));
  const u = _normStr(userAns);
  if(u && a && u===a) return true;

  const letterMap = {A:'OptionA',B:'OptionB',C:'OptionC',D:'OptionD','‡∏Å':'OptionA','‡∏Ç':'OptionB','‡∏Ñ':'OptionC','‡∏á':'OptionD'};
  if(u.length===1){
    const keyRaw = String(userAns||'').trim();
    const key = letterMap[keyRaw.toUpperCase()] || letterMap[keyRaw];
    const full = key ? _normStr(stripChoicePrefix_(meta[key]||'')) : '';
    if(full && full===a) return true;
  }
  const m = String(meta.Answer||'').trim().match(/^([A-D‡∏Å-‡∏á])[\.\)]?/i);
  const ansLetter = m ? m[1].toUpperCase() : '';
  if(ansLetter){
    if(String(userAns||'').trim().toUpperCase() === ansLetter) return true;
    const opt = letterMap[ansLetter];
    const full = opt ? _normStr(stripChoicePrefix_(meta[opt]||'')) : '';
    if(full && _normStr(userAns) === full) return true;
  }
  return false;
}

function pickDateFrom(o){
  const raw = (o?.dateISO ?? o?.awardedAt ?? o?.timestamp ?? o?.ts ?? o?.date ?? '').toString();
  if(!raw) return null;
  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ISO-friendly: ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á -> T, ‡πÅ‡∏•‡∏∞ +0700 -> +07:00
  const s = raw.replace(' ', 'T').replace(/([+\-]\d{2})(\d{2})$/, '$1:$2');
  let d = new Date(s);
  if(!isNaN(d)) return d;

  // ‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö dd/mm/yyyy hh:mm
  const m = raw.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})(?:[ T](\d{1,2}):(\d{2}))?$/);
  if(m){
    d = new Date(+m[3], +m[2]-1, +m[1], +(m[4]||0), +(m[5]||0));
    if(!isNaN(d)) return d;
  }
  return null;
}
function fmtThaiDate(d){
  return d ? d.toLocaleDateString('th-TH',{day:'2-digit',month:'2-digit',year:'numeric'}) : '‚Äî';
}
</script>

</body>
</html>