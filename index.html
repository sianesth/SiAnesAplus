<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ANESA+ ‚Äî Session 1</title>
<link rel="preconnect" href="https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app" crossorigin>
<link rel="preload" as="image" href="logo3.png" />
<style>

  /* ========== Base variables ========== */
:root{
  --bg:#f6f8fd; --card:#fff; --line:#e6e9f2; --txt:#0f1733; --muted:#6b78a6;
  --btn:#1f6fff; --danger:#d93025; --ok:#0a8c4a;
  --header-h:64px;

  /* pastel/border for cards & KPI */
  --bd:#e9eef7;
  --shadow:0 6px 24px rgba(13,38,76,.06);

  --kpi-total-bg:#eaf1ff; --kpi-total-bd:#d6e4ff; /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
  --kpi-used-bg:#ffe9e9;  --kpi-used-bd:#ffd6d6;  /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
  --kpi-left-bg:#e9f8ee;  --kpi-left-bd:#d7f0de;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
}

/* ========== Reset / layout ========== */
*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{
  font:15px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  background:var(--bg);
  color:var(--txt);
  -webkit-font-smoothing: antialiased;   /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏à‡∏≠‡∏Ñ‡∏≠‡∏° */
}

/* ========== Header (fixed) ========== */
header{
  position:fixed; inset:0 auto auto 0; right:0; top:0;
  z-index:1000; display:flex; align-items:center; gap:12px;
  background:#1d3557; color:#fff; padding:10px 14px;
}
header img{ height:44px; width:auto }
.brand{ display:flex; flex-direction:column; line-height:1.15 }
.brand .sys{ font-size:24px; font-weight:800; letter-spacing:.2px }
.brand .welcome{ font-size:14px; color:#e6eefc; font-weight:600 }
.spacer{ flex:1 }

/* Logout button (icon) */
#btnLogout{
  background:#1f6fff; color:#fff; border:none; border-radius:12px;
  padding:8px 14px; cursor:pointer; box-shadow:0 6px 16px rgba(31,111,255,.25);
}
#btnLogout.icon-btn{
  width:36px; height:36px; padding:0; display:inline-grid; place-items:center;
  background:#fec89a; border-radius:12px; box-shadow:0 6px 16px rgba(31,111,255,.25);
}
#btnLogout.icon-btn svg{ width:20px; height:20px; fill:currentColor; }

/* ========== Main container ========== */
main{
  max-width:980px; margin:0 auto;
  padding:14px; display:grid; gap:18px;
  margin-top:calc(var(--header-h) + 8px);
}

/* ========== Generic UI ========== */
.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
input,button{
  border-radius:12px; border:1px solid var(--line);
  padding:10px 12px; font:inherit;
}
button{ cursor:pointer; background:var(--btn); color:#fff; border-color:transparent }
button.ghost{ background:#0f1733; color:#fff }
button[disabled]{ background:#cfd7ff; color:#6570a0; cursor:not-allowed }
.muted{ color:var(--muted) }
.pill{ display:inline-block; background:#eef3ff; border-radius:999px; padding:6px 12px }

/* ========== Card ========== */
.card{
  background:#fff; border:1px solid var(--bd); border-radius:16px;
  box-shadow:var(--shadow); padding:16px; position:relative;
}
.card>h3:first-child{
  position:static; margin:0 0 10px; padding:0;
  border:0; background:transparent; border-radius:0;
  font-size:16px; font-weight:800; display:flex; gap:8px; color:var(--txt);
}

/* ========== Rewards list ========== */
.reward{
  display:flex; gap:10px; align-items:center;
  border:1px solid var(--line); border-radius:10px; padding:10px; margin-bottom:8px;
}
.reward img{
  width:56px; height:56px; border-radius:8px; object-fit:cover;
  background:#f4f6fb; border:1px solid var(--line);
}

/* ========== Tables ========== */
table{ width:100%; border-collapse:collapse }
th,td{ border:1px solid var(--line); padding:8px 10px; text-align:left }
#annualBox table th:last-child,
#annualBox table td:last-child{ text-align:center; width:90px }
#weeklyBox table th:nth-child(3),
#weeklyBox table td:nth-child(3),
#weeklyBox table th:nth-child(4),
#weeklyBox table td:nth-child(4){ text-align:center; width:90px }

/* ========== Modals & toast ========== */
#qrModal,#actModal,#chooseModal{
  position:fixed;
  inset:0;
  display:none;

  /* üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å center ‚Üí start ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏≠‡∏¢‡∏•‡∏á */
  align-items:flex-start;
  justify-content:center;

  /* üî• ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å header */
  padding-top: calc(var(--header-h) + 16px);

  background:rgba(0,0,0,.5);
  z-index:60;
}

#qrBox,#actBox,#chooseBox{
  background:#fff;
  border:1px solid var(--line);
  border-radius:12px;
  padding:16px;
  max-width:640px;
  width:92vw;

  /* ‚≠ê ‡∏Å‡∏±‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡πâ‡∏ô‡∏à‡∏≠ + ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ */
  max-height: calc(100vh - var(--header-h) - 32px);
  overflow:auto;
}

.timer{ font-variant-numeric:tabular-nums; font-size:22px }
.pill2{ display:inline-block; background:#fff7e6; border:1px solid #ffd18a; color:#8a5300; border-radius:999px; padding:4px 10px }
.bad{ color:var(--danger) } .ok{ color:var(--ok) }
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:#0c8c5f; color:#fff; padding:10px 14px; border-radius:10px;
  box-shadow:0 8px 22px rgba(0,0,0,.18); opacity:0; transition:.25s; z-index:999;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }
.latest{ border:1px dashed var(--line); background:#f7f9ff; border-radius:10px; padding:10px; margin-bottom:10px }
.latest b{ font-weight:800 }

/* ========== Login page ========== */
body.is-login{
  overflow:hidden;  /* ‡∏´‡∏ô‡πâ‡∏≤ login ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏•‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
  background:
    radial-gradient(circle at top, #eef2ff 0%, #f4f4ff 35%, #fdf2ff 70%, #ffffff 100%);
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á login ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏ô‡∏¥‡∏î ‡πÜ */
#loginBox{
  display:flex;
  justify-content:center;    /* ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ */
  align-items:flex-start;    /* ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° center ‚Üí ‡∏Ç‡∏¢‡∏±‡∏ö card ‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô */
  padding:24px 12px 20px;    /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏•‡∏á‡∏°‡∏≤ + ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡∏°‡∏∏‡∏ô ‡πÜ */
  min-height:calc(100vh - var(--header-h));
}

/* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ login */
body.is-login{
  background:
    radial-gradient(circle at top, #eef2ff 0%, #f4f4ff 35%, #fdf2ff 70%, #ffffff 100%);
}

.login-card{
  width:min(560px,92vw);
  text-align:center;
  background:linear-gradient(145deg,#ffffff,#fdf4ff); /* ‡∏Ç‡∏≤‡∏ß‡∏≠‡∏°‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
  border:1px solid #e5e7ff;
  border-radius:24px;
  box-shadow:0 18px 40px rgba(148,163,244,.26);
  backdrop-filter:blur(18px);
  -webkit-backdrop-filter:blur(18px);
  padding:28px 22px 22px;
}

.login-title{ font-weight:800; font-size:clamp(18px,3.6vw,24px); margin:2px 0 }
.login-sub{ margin:0 0 12px; color:#9ca3c7 }
.login-row{ display:flex; justify-content:center; gap:12px }
#sap{ width:170px; height:42px; text-align:center; border-radius:999px; border:1px solid #e2e7fb; background:#fff; box-shadow:inset 0 1px 0 rgba(255,255,255,.7) }
#sap:focus{ outline:none; border-color:#b9c8ff; box-shadow:0 0 0 4px rgba(116,148,255,.22) }
#btnLogin{
  height:42px; border-radius:999px; border:none; padding:0 18px; font-weight:700; letter-spacing:.2px;
  background:linear-gradient(135deg,#3b82f6,#6d28d9); box-shadow:0 10px 20px rgba(59,130,246,.25);
}
#btnLogin:hover{ transform:translateY(-1px); filter:brightness(1.03); box-shadow:0 12px 24px rgba(59,130,246,.3) }

:root{
  /* ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÇ‡∏•‡πÇ‡∏Å‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö login */
  --logo-size: 200px;   /* ‡πÄ‡∏î‡∏¥‡∏° 260 ‚Üí ‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏° */
  --logo-bob:  12px;    /* ‡πÄ‡∏î‡πâ‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
}

/* ‡πÇ‡∏•‡πÇ‡∏Å‡πâ */
.login-logo{
  width: var(--logo-size);
  height: var(--logo-size);
  object-fit: contain;
  margin: 0 auto 6px;
  display: block;
  animation: floaty 3.6s ease-in-out infinite;
}

/* ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏° */
@keyframes floaty{
  0%,100% { transform: translateY(calc(var(--logo-bob) * -0.6)); }
  50%     { transform: translateY(var(--logo-bob)); }
}

/* ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) ‚Üí ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î */
@media (max-width:520px){
  .login-logo{
    --logo-size: 150px;
    --logo-bob: 10px;
  }
}

/* ========== KPI section ========== */
#kpiBox{ padding-top:8px; }
#kpiBox > h3{ margin:0 0 6px; }
#kpiBox .kpiRow{
  display:flex; align-items:center; gap:8px; margin-top:2px;
}
.kpi{
  min-width:96px; padding:6px 8px; text-align:center;
  border:1px solid var(--line); border-radius:12px;
  box-shadow:inset 0 2px 8px rgba(15,23,51,.05);
}
.kpi .label{ display:block; font-size:12px; line-height:1.2; color:var(--muted); margin-bottom:2px }
.kpi .value{ display:block; font-size:22px; font-weight:800; line-height:1 }

/* KPI colors */
.kpi.is-total{ background:var(--kpi-total-bg); border-color:var(--kpi-total-bd); color:#1f4b99 }
.kpi.is-used { background:var(--kpi-used-bg);  border-color:var(--kpi-used-bd);  color:#9c2a2a }
.kpi.is-left { background:var(--kpi-left-bg);  border-color:var(--kpi-left-bd);  color:#0a6b3d }

/* Top 20 button */
#kpiBox #btnTop20{
  margin-left:auto; font-size:13px; padding:6px 10px; border-radius:10px;
  background:#1f6fff; color:#fff; border:none; white-space:nowrap;
  box-shadow:0 4px 12px rgba(31,111,255,.18);
}

/* ========== Responsive ========== */
@media (max-width:720px){
  #kpiBox .kpiRow{ flex-wrap:wrap }
  #kpiBox #btnTop20{ order:4 } /* ‡∏•‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Ñ‡∏ö */
}
@media (max-width:520px){
  header img{ height:40px }
  .brand .sys{ font-size:22px }
  #sap{ width:150px; height:40px }
  #btnLogin{ height:40px; padding:0 16px }
  .login-logo{ width:80px; height:80px }
  .kpi{ min-width:92px; padding:6px 8px }
  .kpi .value{ font-size:18px }
  #btnLogout.icon-btn{ width:32px; height:32px; border-radius:10px }
  #btnLogout.icon-btn svg{ width:18px; height:18px }
}

/* ---- Layout login: ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏û‡∏≠‡∏î‡∏µ‡∏ó‡∏∏‡∏Å‡∏à‡∏≠ ---- */
body.is-login main{
  margin-top: var(--header-h); /* ‡πÄ‡∏Æ‡∏î‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° */
}

/* ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≠‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏°‡∏≤‡∏Å ‡πÜ (< 650px) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ scroll ‡πÑ‡∏î‡πâ */
@media (max-height:650px){
  body.is-login #loginBox{
    align-items:flex-start;
    padding-top:12px;
  }
  body.is-login .login-card{
    margin-top:8px;
  }
}

/* ===== Top20 table ===== */
.top20-table thead th{ 
  text-align:center !important; 
}

.top20-table th:nth-child(1),
.top20-table td:nth-child(1),
.top20-table th:nth-child(3),
.top20-table td:nth-child(3){
  width:76px;
  text-align:center;
}

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î */
@media (max-width:720px){
  .top20-table th:nth-child(1),
  .top20-table td:nth-child(1),
  .top20-table th:nth-child(3),
  .top20-table td:nth-child(3){
     width:70px;
  }
}
@media (max-width:420px){
  .top20-table th:nth-child(1),
  .top20-table td:nth-child(1),
  .top20-table th:nth-child(3),
  .top20-table td:nth-child(3){
     width:64px;
  }
}

/* ===== ‡∏Å‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏≠‡∏Å ===== */
.latest{
  border:1px dashed var(--line);
  background:#f0f6ff;             /* ‡∏ü‡πâ‡∏≤‡∏ô‡∏ß‡∏• */
  border-radius:12px;
  padding:8px 10px;                /* üî• ‡∏•‡∏î‡∏ö‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å 10‚Äì14 ‚Üí 8‚Äì10 */
  margin-bottom:10px;
}

/* ===== Card ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ä‡∏¥‡∏î‡∏Ç‡∏≠‡∏ö‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô) ===== */
.act-item{
  border:1px solid #e0e6ef;
  border-radius:10px;
  background:#ffffff;
  padding:8px 12px;              /* üî• ‡∏•‡∏î padding ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡∏π compact */
  margin:6px 0;             /* üî• ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á */
  box-shadow:0 2px 4px rgba(0,0,0,0.03);
}

/* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
.act-item div{
  margin:2px 0;
}

.act-item + .act-item{
  border-top:1px dashed #d9dde3;
  padding-top:10px;
}

/* label ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ */
.lbl{
  color:#3A6B8A !important;
  font-weight:700 !important;
}

/* ‡∏£‡∏∞‡∏¢‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏£‡∏ß‡∏° */
.act-item div{
  margin:4px 0;
}

/* ========== ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ========== */
.act-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}

.row.activity-buttons{
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
}
#btnActNow,
#btnWinners,
#btnLottoAll{
    flex:1;                              /* üî• ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
    text-align:center;
    font-size:14px;
    padding:10px 0;
    border-radius:12px;
    background:#1f6fff;
    color:#fff;
    font-weight:600;
    border:none;
    box-shadow:0 4px 10px rgba(0,0,0,.12); /* ‡∏°‡∏¥‡∏ï‡∏¥ */
    transition:.25s;
}

/* hover effect */
#btnActNow:hover,
#btnWinners:hover,
#btnLottoAll:hover{
    transform:translateY(-2px);
    filter:brightness(1.05);
}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏à‡∏≤‡∏á */
#btnActNow{
    background:#dfe7ff;
    color:#3a4a90;
}

/* Responsive Tablet */
@media(max-width:820px){
    #btnActNow,#btnWinners,#btnLottoAll{
        font-size:13px;
        padding:9px 0;
    }
}

/* Responsive Mobile */
@media(max-width:600px){
    #btnActNow,#btnWinners,#btnLottoAll{
        font-size:12px;
        padding:8px 0;
        border-radius:10px;
    }
}

/* ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
@media(max-width:420px){
    #btnActNow,#btnWinners,#btnLottoAll{
        font-size:11px;
        padding:6px 0;
    }
}
.act-actions{ flex-wrap:nowrap; overflow-x:auto; }

/* ‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥ */
.pts {
  font-weight:400 !important;
}

/* ===== Question Image (Activity) ===== */
.q-img-wrap{
  margin:8px 0;
  text-align:center;
}
.q-img{
  max-width:100%;
  height:auto;
  max-height:min(38vh, 320px);   /* ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏£‡∏π‡∏õ */
  object-fit:contain;
  border-radius:14px;

  cursor:default;        /* ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏î‡∏Ç‡∏¢‡∏≤‡∏¢ */
  pointer-events:none;   /* ‚úÖ ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å 100% */

  box-shadow:0 6px 18px rgba(0,0,0,.2);
}

@media (max-width:520px){
  .q-img{ max-height:32vh; }  /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
}

/* ===== Lightbox ===== */
.img-lightbox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.img-lightbox img{
  max-width:95vw;
  max-height:95vh;
  border-radius:16px;
}

/* ===== PATCH: Rewards Image Bigger ===== */
.reward img{
  width:96px;
  height:96px;
  object-fit:cover;
  border-radius:14px;
  cursor:zoom-in;
  border:1px solid #e3e8f0;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
}

@media(min-width:768px){
  .reward img{
    width:120px;
    height:120px;
  }
}

</style>

</head>
<body class="is-login">
<header>
  <img src="logo4.png" alt="logo" />
  <div class="brand">
    <div class="sys">Anesthesia A+</div>
    <div id="welcomeText" class="welcome" style="display:none">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ‚Äî</div>
  </div>
  <div class="spacer"></div>
  <button id="btnLogout" class="icon-btn" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" aria-label="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" style="display:none">
  <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô logout ‡πÅ‡∏ö‡∏ö SVG -->
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M10 3a1 1 0 0 0-1 1v4h2V6h8v12h-8v-2H9v4a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H10z"/>
    <path d="M13 12a1 1 0 0 0-1-1H5.41l1.3-1.29A1 1 0 1 0 5.3 7.3l-3 3a1 1 0 0 0 0 1.41l3 3a1 1 0 1 0 1.41-1.41L5.41 13H12a1 1 0 0 0 1-1z"/>
  </svg>
</button>

</header>

<main>
  <!-- Login -->
  <section id="loginBox">
    <div class="login-card">
      <img src="logo3.png" alt="Mascot" class="login-logo" />
      <h1 class="login-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Anesthesia A+<br>‡∏ï‡∏≠‡∏ô ‚Äú‡∏•‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏ß...‡∏ö‡∏¥‡πâ‡∏ß‡πÅ‡∏ï‡πâ‡∏°‚Äù</h1>
      <p class="login-sub">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ <b>SAP</b> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
      <div class="login-row">
        <input id="sap" placeholder="SAP" inputmode="numeric" autocomplete="off" />
        <button id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px;min-height:20px"></div>
    </div>
  </section>

  <!-- KPI + Top20 -->
  <section id="kpiBox" class="card" style="display:none">
    <h3>üìä ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
    <div class="kpiRow row">
      <div class="kpi is-total">
      <span class="label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      <span class="value" id="uEarned">0</span>
    </div>
    <div class="kpi is-used">
      <span class="label">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span>
      <span class="value" id="uUsed">0</span>
    </div>
    <div class="kpi is-left">
      <span class="label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
      <span class="value" id="uTotal">0</span>
    </div>
    <button id="btnTop20">üèÜTop 20</button>
  </div>
  </section>

  <!-- Today / Activities -->
  <section id="actTodayCard" class="card" style="display:none">
    <h3>üçÄ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
    <div id="actLatest" class="latest" style="display:none">
    <div class="act-item">
      <div><b class="title"></b></div>
      <div>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span class="userAnswer"></span></div>
      <div>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: <span class="result"></span></div>
      <div>‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <b class="pts">0</b> <span class="bonus"></span></div>
    </div>
  </div>

    <div id="actTodayInfo" class="muted" style="display:none"></div>
    <div class="row activity-buttons" style="margin-top:8px">
      <button id="btnActNow">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button id="btnWinners">Top20 Today</button>
      <button id="btnLottoAll">‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢</button>
    </div>
    <div id="actList" style="margin-top:10px;display:none"></div>
  </section>

  <!-- Rewards -->
  <section id="rewardsBox" class="card" style="display:none">
    <h3>üéÅ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ</h3>
     <div id="rewards"></div>
    <div id="lockBanner" class="muted" style="margin-top:6px;display:none">
      <span>‡∏°‡∏µ QR ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Äî ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô <b class="timer" id="bannerTimer">10:00</b></span>
      <button class="ghost" id="bannerShow" style="margin-left:8px">‡πÄ‡∏õ‡∏¥‡∏î QR</button>
    </div>
  </section>

  <!-- History -->
  <section id="historyBox" class="card" style="display:none">
    <h3>üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</h3>
    <table>
      <thead><tr><th>‡∏ß‡∏î‡∏õ</th><th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th><th>‡πÅ‡∏ï‡πâ‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
      <tbody id="history"><tr><td colspan="4" style="text-align:center">‚Äî</td></tr></tbody>
    </table>
  </section>

  <!-- Weekly -->
  <section id="weeklyBox" class="card" style="display:none">
    <h3>üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
    <table>
      <thead><tr><th>‡∏ß‡∏î‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th><th>‡∏ú‡∏•‡∏ï‡∏≠‡∏ö</th><th>‡πÅ‡∏ï‡πâ‡∏°</th></tr></thead>
      <tbody id="weekly"><tr><td colspan="4" style="text-align:center">‚Äî</td></tr></tbody>
    </table>
  </section>

  <!-- Annual forms -->
  <section id="annualBox" class="card" style="display:none">
    <h3>üóìÔ∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</h3>
    <table>
      <thead><tr><th>‡∏ß‡∏î‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</th><th>‡πÅ‡∏ï‡πâ‡∏°</th></tr></thead>
      <tbody id="annual"><tr><td colspan="3" style="text-align:center">‚Äî</td></tr></tbody>
    </table>
  </section>
</main>

<div id="top20Modal" class="modal" style="display:none">
  <div class="modal-card">
    <h3>Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
    <table>
      <thead>
         <tr>
           <th style="width:64px;text-align:center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
           <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
           <th style="width:120px;text-align:right">‡πÅ‡∏ï‡πâ‡∏°</th>
         </tr>
      </thead>
      <tbody id="top20List"><tr><td colspan="3" class="muted">‚Äî</td></tr></tbody>
    </table>
    <button onclick="hideModalTop20()">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<!-- QR Modal -->
<div id="qrModal"><div id="qrBox">
  <div class="row" style="align-items:center;margin-bottom:6px">
    <h3 style="margin:0">‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</h3>
    <span class="pill2" style="margin-left:auto">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô <b class="timer" id="qrTimer">10:00</b></span>
  </div>
  <div class="row" style="align-items:center">
    <div style="flex:1">
      <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: <b id="qrRewardName"></b> ‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ <b id="qrPoints"></b> ‡πÅ‡∏ï‡πâ‡∏°</div>
      <div id="qrAck" class="muted" style="margin-top:6px"></div>
      <div id="qrExpired" class="bad" style="display:none;margin-top:6px">QR ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÅ‡∏•‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
    </div>
    <img id="qrImg" alt="QR" style="width:180px;height:180px;border:1px solid var(--line);border-radius:8px;background:#fff" />
  </div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button id="btnCloseQR" class="ghost">‡∏õ‡∏¥‡∏î</button>
  </div>
</div></div>

<!-- Activity Modal -->
<div id="actModal"><div id="actBox">
  <h3 id="actTitle">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
  <div id="actQuestion" class="muted" style="margin-bottom:8px"></div>
  <div id="actOpts"></div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button id="btnActSubmit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
    <button id="btnActClose" class="ghost">‡∏õ‡∏¥‡∏î</button>
  </div>
  <div id="actStatus" class="muted" style="margin-top:6px"></div>
</div></div>

<!-- Two-step chooser -->
<div id="chooseModal"><div id="chooseBox">
  <h3 style="margin-top:0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h3>
  <div id="chooseBody" class="row"></div>
  <div style="text-align:right;margin-top:8px">
    <button id="btnChooseClose" class="ghost">‡∏õ‡∏¥‡∏î</button>
  </div>
</div></div>

<dialog id="dlgTop"><div style="min-width:320px">
  <h3 id="dlgTopTitle">Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</h3>
  <div id="dlgTopBody"></div>
  <div style="text-align:right;margin-top:8px"><button onclick="this.closest('dialog').close()">‡∏õ‡∏¥‡∏î</button></div>
</div></dialog>

<div id="toast" class="toast"></div>

<footer style="text-align:center;color:#8b94b2;font-size:11px;margin:8px 0">
  ¬© 2025 | ‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏™‡∏±‡∏ç‡∏ç‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏Ñ‡∏ì‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏≤‡∏ä‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•<br>
  <span style="font-size:10px;opacity:.85">Version 1.1 by Zuree.Yoo</span>
</footer>

<script type="module">
window.state = window.state || { sap: "", weeklyRemote: [], offWeekly: null };
/* ========= Config ========= */
const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
const { getDatabase, ref, onValue, get, off, child } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js");
const app = initializeApp({
  apiKey: "AIzaSyAiSW2d16RpHjtUR7OIl2PVpvH_QPL3cp4",
  authDomain: "anesaplus.firebaseapp.com",
  databaseURL: "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anesaplus",
  appId: "1:518123966097:web:2f93eeb56ec026aa903930"
});

// Endpoints
const DB_URL = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";
const ADMIN_PAGE_URL = "https://sianesth.github.io/Admin_reward/"; 
// ‚¨áÔ∏è IMPORTANT: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Web App (Deployment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPOW_Wk7bZYb3zG4qRciOENbBSMo2TRdfdJxXzC1C5tRxav1R_dlF5SuuXKoEkJi84Ig/exec';

async function postSubmissionToSheet(payload) {
  const url = (typeof SCRIPT_URL !== 'undefined') ? SCRIPT_URL : '';
  if (!url) {
    console.error('SCRIPT_URL missing');
    return { ok: false, error: 'SCRIPT_URL missing' };
  }

  /* ‚≠ê‚≠ê‚≠ê (H1) ‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡∏ù‡∏±‡πà‡∏á client ‚Äì ‡∏ß‡∏≤‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚≠ê‚≠ê‚≠ê */
  const today = todayKey('Asia/Bangkok');
  const SAP = localStorage.getItem('SAP') || state.sap;
  // ‚≠ê PATCH: ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÅ‡∏ö‡∏ö "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢" (‡∏Å‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•‡∏Ñ‡∏•‡∏¥‡∏Å ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
  const finalKey = `ans:${today}:${SAP}:${payload.actId}`;          // ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
  const pendKey  = `ans_pending:${today}:${SAP}:${payload.actId}`;  // ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà

  if(localStorage.getItem(finalKey)){
     toast("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
     return {ok:false, error:"already_answered_today"};
  }

  // ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ network
  if(localStorage.getItem(pendKey)){
     toast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...");
     return {ok:false, error:"sending"};
  }

  // ‡∏ï‡∏±‡πâ‡∏á pending ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏∞‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
  localStorage.setItem(pendKey, String(Date.now()));


  try {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify(payload),
      keepalive: false,
      cache: 'no-store'
    });

    // ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á GAS ‡∏à‡∏∞‡∏™‡πà‡∏á 200 ‡∏û‡∏£‡πâ‡∏≠‡∏° body ‡∏ß‡πà‡∏≤‡∏á/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‚Üí ‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ
    let data = null;
    try { data = await res.json(); } catch (_) { data = null; }

    // ====== ‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥ (‡∏ù‡∏±‡πà‡∏á client) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ======
    if (data && (data.error === 'already_answered_today' || data.errorCode === 'ALREADY_ANSWERED')) {
      try {
        const actId = String(payload.actId || '').trim();
        if (actId) {
          const today = todayKey('Asia/Bangkok'); // ‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡πÑ‡∏ó‡∏¢
          const SAP   = localStorage.getItem('SAP') || (state && state.sap) || '';
          const key   = `ans:${today}:${SAP}:${actId}`;
          localStorage.setItem(key, '1');          // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÅ‡∏ö‡∏ö ans:YYYY-MM-DD:SAP:ActID
          try { localStorage.setItem(aKey(actId), '1'); } catch (e) {}

          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏π‡πà clinic/non-clinic ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏ä‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢
          try {
            const meta = (typeof getActMetaById === 'function') ? getActMetaById(actId) : null;
            const pk = meta && (typeof pairKeyOf === 'function') ? pairKeyOf(meta) : null;
            if (pk && typeof clinPairStoreKey === 'function') {
              localStorage.setItem(clinPairStoreKey(pk), '1');
            }
          } catch (e) {}

          // ‡∏¢‡∏¥‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ RTDB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
          try {
            await fetch(`${DB_URL}/public/answeredToday/${today}/${encodeURIComponent(actId)}/${encodeURIComponent(SAP)}.json`, {
              method: 'PUT',
              body: 'true'
            });
          } catch (_) {}
        }
      } catch (e) {}

      try { document.querySelector('#actModal').style.display = 'none'; } catch (e) {}
      if (typeof toast === 'function') toast('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß', 3000);
      return { ok: false, error: 'already_answered_today' };
    }

    // ====== ‡πÅ‡∏à‡πâ‡∏á Non-active ======
    if (data && data.error === 'USER_NON_ACTIVE') {
      if (typeof toast === 'function') {
        toast('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Non-active</b><br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 4000);
      }
      localStorage.removeItem(pendKey);
      return { ok: false, error: 'USER_NON_ACTIVE' };
    }

    // ====== ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤ server ‡πÉ‡∏´‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ correct ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ======
if (data && data.ok && data.correct != null && typeof showAnswerResult === 'function') {
    if (data.correct === 'TRUE') {
        showAnswerResult(true, Number(data.points || 0));
    } else if (data.correct === 'FALSE') {
        showAnswerResult(false, 0);
    } else {
        showAnswerResult(null, 0); // PENDING
    }
}

startFastPollAfterSubmit(payload.actId);

// ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
return data;

/* -----------------------------------------------------
   ‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Refresh
----------------------------------------------------- */
try {
    renderLatest([{
        actId: payload.actId,
        title: payload.title || state.currentQuestion?.title,
        userAnswer: payload.answer,
        result: data.correct === 'TRUE' ? true : data.correct === 'FALSE' ? false : null,
        points: Number(data.points || 0),
        bonus: Number(data.bonus || 0),
        dateISO: todayKey()
    }]);

    addOrUpdateWeekly({
        dateISO: todayKey(),
        actId: payload.actId,
        title: payload.title,
        result: data.correct === 'TRUE',
        points: Number(data.points || 0),
        bonus: Number(data.bonus || 0)
    });
} catch(err){
    console.warn("Render immediate failed:", err);
}


/* -----------------------------------------------------
   ‚≠ê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Optimistic UI)
----------------------------------------------------- */
try {
    const box = document.querySelector('#actLatest');
    if (box) {
        const pts = box.querySelector('.pts');
        const bonus = box.querySelector('.bonus');
        if (pts)   pts.textContent   = Number(data.points || 0);
        if (bonus) bonus.textContent = Number(data.bonus || 0);
    }
} catch(err){
    console.warn("Update score UI failed:", err);
}

    /* ============================================================
   ‚≠ê ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏û‡∏≠‡∏î‡∏µ ‚Äî ‡∏•‡πá‡∏≠‡∏Å Clinic/Non-clinic ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≠‡∏ö
   ============================================================ */
    try {
      const meta = getActMetaById(payload.actId);
      const pk = meta ? pairKeyOf(meta) : null;
      if (pk) {
          localStorage.setItem(clinPairStoreKey(pk), "1");
      }
    } catch (_) {}

    // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    localStorage.removeItem(pendKey);
    if (data) return data;

    // fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ body ‡∏ß‡πà‡∏≤‡∏á
    localStorage.removeItem(pendKey);
    return { ok: true, correct: 'PENDING', points: null };

  } catch (e) {
    console.error('Submit error:', e);
    try{ localStorage.removeItem(pendKey); }catch(_){ }
    return { ok: false, error: String(e) };
  }
}

// ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ Status ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô boolean
function isActiveStatus(val){
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á "active", "non-active", TRUE/FALSE, 1/0, ‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
  const s = String(val ?? '').normalize('NFKC').trim().toLowerCase();
  if (typeof val === 'boolean') return val;
  if (!s) return false;                                       // ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á = ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï
  if (/^(inactive|non-?active|disabled?|false|0|‡∏õ‡∏¥‡∏î|‡∏á‡∏î|‡∏´‡∏¢‡∏∏‡∏î)$/.test(s)) return false;
  if (/^(active|enabled?|true|1|‡πÄ‡∏õ‡∏¥‡∏î|‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô|on|yes)$/.test(s)) return true;
  return !(s.startsWith('non'));                              // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏∞‡∏Å‡∏î‡πÅ‡∏õ‡∏•‡∏Å‡πÜ
}

/* ========= Tiny helpers ========= */
const $ = q => document.querySelector(q);
function gasJSONP(params){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=d=>{ resolve(d); delete window[cb]; s.remove(); };
    const qs=new URLSearchParams({...params, callback:cb}).toString();
    const s=document.createElement('script'); s.src=`${SCRIPT_URL}?${qs}`;
    s.onerror=()=>reject(new Error('GAS JSONP error'));
    document.body.appendChild(s);
  });
}
  
async function hasAnswered(sap, actId){
  const r = await gasJSONP({act:'answered', sap, actId});
  return !!(r && r.ok && r.answered);
}

const fmt = n => Number(n||0).toLocaleString('th-TH');
const pad2 = n => String(n).padStart(2,'0');
function toast(html,ms=3000){ const el=$('#toast'); el.innerHTML=html; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),ms); }
function setWelcome(name){const el=$('#welcomeText'); if(name){ el.textContent='‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì '+name; el.style.display='block'; } else { el.style.display='none'; } }
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function parseQuestion(q){
  if(!q) return { text:'', img:'' };

  const s = String(q).trim();
  const imgMatch = s.match(/\[IMG\]([\s\S]*?)\[\/IMG\]/i);

  if(imgMatch){
    return {
      img: fixImg(imgMatch[1].trim()),
      text: s.replace(imgMatch[0], '').trim()
    };
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏£‡∏π‡∏õ‡∏•‡πâ‡∏ß‡∏ô
  if(/^https?:\/\/.+\.(png|jpg|jpeg|gif|webp)$/i.test(s) || s.includes('drive.google.com')){
    return { img: fixImg(s), text:'' };
  }

  return { text:s, img:'' };
}

function renderQuestionHTML(q){
  const { text, img } = parseQuestion(q);
  let html = '';

  if (img) {
    const full = fixImg(img);              // ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô uc?export=download&id=...
    const id   = extractId(img);
    const thumb = driveThumb(id);          // fallback ‡∏ñ‡πâ‡∏≤ full ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ

    html += `
      <div class="q-img-wrap">
        <img
          src="${full}"
          class="q-img"
          loading="lazy"
          decoding="async"
          referrerpolicy="no-referrer"
          data-full="${full}"
          data-thumb="${thumb}"
          onerror="this.onerror=null; if(this.dataset.thumb){ this.src=this.dataset.thumb; }"
          alt="question image"
        >
      </div>`;
  }

  if (text) {
    html += `<div class="q-text">${escapeHtml(text)}</div>`;
  }

  return html || '<div class="muted">‚Äî</div>';
}

// ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏™‡∏°‡∏≠
function todayKey(tz = 'Asia/Bangkok') {
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
  return fmt.format(new Date()); // YYYY-MM-DD
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡πÉ‡∏ä‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô (optional)
function dayKeyFromDate(d, tz = 'Asia/Bangkok') {
  const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' });
  return fmt.format(d);
}

// === Date helpers (‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á ISO, 'YYYY-MM-DD HH:mm:ss', 'DD/MM/YYYY, HH:MM:SS', serial day) ===
function anyToDate(x){
¬† if (x instanceof Date) return x;
¬† if (x == null || x === '') return null;

¬† if (typeof x === 'number') {
¬† ¬† // 1. Unix Timestamp (milliseconds) - Firebase/GAS ‡∏°‡∏±‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ (13 ‡∏´‡∏•‡∏±‡∏Å)
¬† ¬† if (String(x).length === 13) return new Date(x);¬†
¬† ¬† // 2. [‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] Unix Timestamp (seconds) - ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô ms)
¬† ¬† if (String(x).length === 10) return new Date(x * 1000);
¬† ¬† // 3. Serial Day Number (Excel/Sheets: 45000+)
¬† ¬† if (x > 25569 && x < 60000) return new Date((x - 25569) * 86400 * 1000);¬†
¬† ¬† return new Date(x);
¬† }

¬† const s = String(x).trim();
¬† if (!s) return null;

¬† // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏µ ‡∏û.‡∏®. ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤)
¬† const dmMatch = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})([, ]?\s?(\d{1,2}:\d{2}:\d{2}))?/);
¬† if (dmMatch) {
¬† ¬† const [, day, month, yearStr, , timeStr='00:00:00'] = dmMatch;
¬† ¬† let year = Number(yearStr);
¬† ¬† // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ ‡∏û.‡∏®.]
¬† ¬† if (year > 2400) { year = year - 543; }¬†
¬† ¬†¬†
¬† ¬† // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢ (+07:00)
¬† ¬† const isoDateStr = `${year}-${month}-${day}T${timeStr}`;¬†
¬† ¬† const d = new Date(isoDateStr + '+07:00');
¬† ¬† if (!isNaN(d.getTime())) return d;
¬† }
¬†¬†
¬†¬† // 5. Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ISO String ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Timezone Offset
   if (!s.includes('Z') && !/[+\-]\d{2}:?\d{2}$/.test(s)) {
     if (/^\d{4}-\d{2}-\d{2}(?:[ T]\d{2}:\d{2}:\d{2}(?:\.\d{3})?)?$/.test(s)) {
       const d = new Date(s.replace(' ','T') + '+07:00');
       if (!isNaN(+d)) return d;
     }
   }

¬† // 6. Final Fallback: ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡πâ JavaScript ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏≠‡∏á¬†
¬† const d = new Date(s);
¬† return isNaN(+d) ? null : d;
}

function thaiDate(d){
  if (!(d instanceof Date) || isNaN(d.getTime())) return '‚Äî';
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear() + 543;
  return `${dd}/${mm}/${yyyy}`;
}

// ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å object ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÑ‡∏ó‡∏¢
function thaiFromKeys(obj, keys){
  if (!obj) return '‚Äî';

  // 1) ‡∏•‡∏≠‡∏á‡∏ï‡∏≤‡∏° key ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ['awardedAt','timestamp','dateISO'])
  for (const k of (keys || [])){
    if (obj[k] != null && String(obj[k]).trim() !== ''){
      const d = anyToDate(obj[k]);
      if (d) return thaiDate(d);
    }
  }

  // 2) ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÑ‡∏•‡πà‡∏ó‡∏∏‡∏Å field ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ date/time/stamp/award
  for (const [k, v] of Object.entries(obj)){
    if (!v) continue;
    if (!/(date|time|stamp|award)/i.test(k)) continue;
    const d = anyToDate(v);
    if (d) return thaiDate(d);
  }

  // 3) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡∏µ‡∏î ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "Invalid Date"
  return '‚Äî';
}

// Google Drive image helpers
function extractId(u){
  const s = String(u || '').trim();
  if(!s) return '';

  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å: /file/d/FILE_ID/view
  let m = s.match(/\/file\/d\/([A-Za-z0-9_-]+)/);
  if (m && m[1]) return m[1];

  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≠‡∏á: ?id=FILE_ID
  m = s.match(/[?&]id=([A-Za-z0-9_-]+)/);
  if (m && m[1]) return m[1];

  return '';
}

function fixImg(u){ const s=String(u||'').trim(); if(!s) return ''; if(/uc\?export=view&id=/.test(s)) return s; const id=extractId(s); return id ? `https://drive.google.com/uc?export=view&id=${id}` : s; }
function driveThumb(id){ return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w300` : ''; }
// ===== FAST POLL < 20s after submit =====
let __fastPollTimer = null;

function startFastPollAfterSubmit(actId){
  // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≠‡∏ô
  if (__fastPollTimer) { clearInterval(__fastPollTimer); __fastPollTimer = null; }

  const start = Date.now();
  const MAX_MS = 20000;     // < 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  const EVERY = 2000;       // ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1500 ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)

  // helper: ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  function isLatestUpdated(){
    const box = document.querySelector('#actLatest');
    if (!box) return false;
    const txt = box.textContent || '';
    // ‡∏°‡∏µ "‡πÄ‡∏â‡∏•‡∏¢:" ‡πÅ‡∏•‡πâ‡∏ß + ‡πÄ‡∏Ñ‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏£‡∏á actId ‡∏à‡∏∞‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏Ç‡∏∂‡πâ‡∏ô
    // (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ data-actid ‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ renderLatest ‡∏Å‡πà‡∏≠‡∏ô)
    return txt.includes('‡πÄ‡∏â‡∏•‡∏¢:') || txt.includes('‡πÄ‡∏â‡∏•‡∏¢');
  }

  // ‡∏¢‡∏¥‡∏á‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏£‡∏≠ 2 ‡∏ß‡∏¥)
  (async () => {
    try{
      // ‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ realtime ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏Ñ‡πà render ‡∏ã‡πâ‡∏≥‡∏Å‡πá‡∏Ç‡∏∂‡πâ‡∏ô
      if (typeof renderLatest === 'function') renderLatest();
      if (typeof renderKPI === 'function') renderKPI();
      if (typeof renderPoints === 'function') renderPoints();

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/summary ‡∏à‡∏≤‡∏Å Firebase/GAS ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢
      if (typeof refreshUserSummary === 'function') await refreshUserSummary();
      if (typeof pullUserSummary === 'function') await pullUserSummary();
    }catch(_){}
  })();

  __fastPollTimer = setInterval(async () => {
    const elapsed = Date.now() - start;

    try{
      // 1) ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      if (typeof refreshUserSummary === 'function') await refreshUserSummary();
      if (typeof pullUserSummary === 'function') await pullUserSummary();

      // 2) ‡∏™‡∏±‡πà‡∏á render ‡∏Å‡∏•‡πà‡∏≠‡∏á ‚Äú‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù ‡πÉ‡∏´‡∏°‡πà
      if (typeof renderLatest === 'function') renderLatest();
      if (typeof renderKPI === 'function') renderKPI();
      if (typeof renderPoints === 'function') renderPoints();

      // 3) ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (isLatestUpdated()){
        clearInterval(__fastPollTimer);
        __fastPollTimer = null;
        return;
      }
    }catch(_){}

    // 4) ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‚Üí ‡∏´‡∏¢‡∏∏‡∏î
    if (elapsed >= MAX_MS){
      clearInterval(__fastPollTimer);
      __fastPollTimer = null;
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á toast ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏≤ ‡πÜ:
      // toast('‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
    }
  }, EVERY);
}

/* ========= Header offset (fixed header space) ========= */
function applyHeaderOffset(){
  const h = document.querySelector('header')?.offsetHeight || 0;
  document.documentElement.style.setProperty('--header-h', h + 'px');
}
window.addEventListener('load', applyHeaderOffset);
window.addEventListener('resize', applyHeaderOffset);

/* ========= Session ========= */
const SESSION_KEY = 'anes.session.v1';
const saveSession = d => { try{ localStorage.setItem(SESSION_KEY, JSON.stringify(d)); }catch{} };
const readSession = () => { try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch{ return null } };
const clearSession = () => { try{ localStorage.removeItem(SESSION_KEY); }catch{} };
function clearAutoPopupFlags(){ try{ const ks=[]; for(let i=0;i<sessionStorage.length;i++){ const k=sessionStorage.key(i); if(k && k.startsWith('anes.autopopup.')) ks.push(k); } ks.forEach(k=>sessionStorage.removeItem(k)); }catch{} }

/* ========= State ========= */
let state = {
  sap: null,
  total: 0,
  name: '',
  leader: [],
  rewards: {},
  activities: [],
  activitiesMap: {},
  lastSubmission: null,
  weeklyRemote: [],
  annual: [],
  activityIndex: {},

  // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
  formAwards: [],      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å FormAwardsByUser/{sap}
  formTitles: {}       // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å FormTitles (map formId -> row)
};

let fb=null; let actIndex={};
let _submitting = false;

// ==== Pending KPI (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÅ‡∏ö‡∏ö Optimistic) ====
state._kpiServer = { earned:0, used:0, total:0 };   // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å RTDB ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
state._kpiPending = { earned:0, used:0, total:0 };  // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

function renderKPI(){
  const earned = state._kpiServer.earned + state._kpiPending.earned;
  const used   = state._kpiServer.used   + state._kpiPending.used;
  const total  = state._kpiServer.total  + state._kpiPending.total;
  $('#uEarned').textContent = fmt(earned);
  $('#uUsed').textContent   = fmt(used);
  $('#uTotal').textContent  = fmt(total);
}

// ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å RTDB ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå pending ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å Sync ‡πÅ‡∏•‡πâ‡∏ß
function reconcileKPIFromServer(newEarned, newUsed, newTotal){
  // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‚Äú‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô/‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï pending
  const changed = (
    newEarned !== state._kpiServer.earned ||
    newUsed   !== state._kpiServer.used   ||
    newTotal  !== state._kpiServer.total
  );
  state._kpiServer = { earned:newEarned, used:newUsed, total:newTotal };
  if (changed) {
    // ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏•‡πâ‡∏≤‡∏á pending ‡∏ó‡∏µ‡πà‡∏£‡∏≠
    state._kpiPending = { earned:0, used:0, total:0 };
  }
  renderKPI();
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î pending ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏îeltas (+/-)
function applyKPIDelta(deltaEarned=0, deltaUsed=0){
  state._kpiPending.earned += deltaEarned;
  state._kpiPending.used   += deltaUsed;
  state._kpiPending.total   = state._kpiPending.earned - state._kpiPending.used;
  renderKPI();
}

/* ========= Firebase ========= */
async function ensureFirebase(){ if(fb) return fb; const db = getDatabase(app); fb={ app, db, ref, onValue, get, off, child }; return fb; }

/* ========= Latest cache ========= */
const latestStoreKey = () => `anes.latest.${todayKey()}.${state.sap||'0'}`;
const saveLatestCache = x => { try{ localStorage.setItem(latestStoreKey(), JSON.stringify(x)); }catch{} };
const readLatestCache = () => { try{ return JSON.parse(localStorage.getItem(latestStoreKey())||'null'); }catch{ return null } };
const clearLatestCache = () => { try{ localStorage.removeItem(latestStoreKey()); }catch{} };

/* ========= Login / Logout (FAST + no-duplicate) ========= */
async function fetchUserQuickFast(sap){
  const DB = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";
  const paths = [
    `public/usersSummary/${encodeURIComponent(sap)}`,
    `public/users/${encodeURIComponent(sap)}`,
    `public/UsersSummary/${encodeURIComponent(sap)}`
  ];
  for (const p of paths){
    try{
      const r = await fetch(`${DB}/${p}.json?t=${Date.now()}`, { cache:'no-store' });
      if (!r.ok) continue;
      const u = await r.json();
      // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô object ‡πÅ‡∏•‡∏∞‡∏°‡∏µ field ‡πÉ‡∏î ‡πÜ ‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
      if (u && typeof u === 'object' && (
          'name' in u || 'Name' in u || 'PointsTotal' in u || 'pointsTotal' in u || 'Status' in u || 'active' in u
        )) {
        return u;
      }
    }catch(_){}
  }
  return null;
}

// ‡πÉ‡∏ä‡πâ gasJSONP ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
if (typeof window.gasJSONP !== 'function') {
  window.gasJSONP = function gasJSONP(params, timeoutMs=1800){
    return new Promise((resolve)=>{
      const cb='cb_'+Math.random().toString(36).slice(2);
      let done=false, timer=setTimeout(()=>{ if(!done){ done=true; resolve(null); } }, timeoutMs);
      window[cb]=d=>{ if(done) return; done=true; clearTimeout(timer); resolve(d); try{delete window[cb]; s.remove();}catch{} };
      const qs=new URLSearchParams({ ...params, callback:cb }).toString();
      const s=document.createElement('script');
      s.src = `${SCRIPT_URL}?${qs}`;
      s.onerror = ()=>{ if(done) return; done=true; clearTimeout(timer); resolve(null); };
      document.body.appendChild(s);
    });
  };
}

// ‡∏ñ‡∏≤‡∏° Apps Script ‡πÄ‡∏°‡∏∑‡πà‡∏≠ RTDB ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
async function checkUserStatusFast(sap){
  const r = await gasJSONP({ act:'userstatus', sap }, 1800);
  if (!r || r.ok !== true) return { found:false, active:false, name:'' };
  const hasFoundKey = ('found' in r) || ('exists' in r);
  const found  = hasFoundKey ? !!(r.found ?? r.exists) : (typeof r.active !== 'undefined');
  const active = !!r.active;
  const name   = r.name || '';
  return { found, active, name };
}

// ‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç
document.querySelector('#sap').addEventListener('input', e=>{
  e.target.value = e.target.value.replace(/[^\d]/g,'');
});

document.querySelector('#btnLogin').onclick = async () => {
  const sapEl = document.querySelector('#sap');
  const msgEl = document.querySelector('#loginMsg');
  const btn   = document.querySelector('#btnLogin');

  const sap = (sapEl.value || '').trim();
  if (!sap){ msgEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å SAP'; return; }

  btn.disabled = true;
  clearLoginMsg(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå/‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ó‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
document.querySelector('#loginMsg').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

  // 1) ‡πÄ‡∏ä‡πá‡∏Ñ RTDB ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡πá‡∏ß)
  let u = null;
  try { u = await fetchUserQuickFast(sap); } catch(_){ u = null; }

  // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Üí ‡∏ñ‡∏≤‡∏° GAS (‡∏°‡∏µ timeout)
  if (!u){
  const st = await checkUserStatusFast(sap);

  if (st.found && !st.active){
  showLoginError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Ä¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ admin');
  btn.disabled = false;
  return;
}
if (!st.found){
  showLoginError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‚Ä¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ admin');
  btn.disabled = false;
  return;
}

  // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠ sync
  u = { name: st.name || sap, PointsEarned:0, PointsUsed:0, PointsTotal:0, active:true };
}

  // 3) ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å RTDB ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const rawStatus = (u.active ?? u.Status ?? u.status ?? u.Active ?? '');
  const ok = isActiveStatus(rawStatus);
if (!ok && rawStatus !== ''){
  showLoginError('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>non-active</b> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ admin');
  btn.disabled = false;
  return;
}

  // 4) ‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠ realtime
  msgEl.textContent = '';
  window.state = window.state || {};
  state.sap  = sap;
  state.name = (u.name || u.Name || sap);
  setWelcome(state.name);
  localStorage.setItem('SAP', sap);
  try{ localStorage.setItem('anes.session.v1', JSON.stringify({sap: state.sap, name: state.name})); }catch{}

  document.body.classList.remove('is-login');
  document.querySelector('#loginBox').style.display = 'none';
  document.querySelector('#btnLogout').style.display = 'inline-block';

  ['kpiBox','actTodayCard','rewardsBox','historyBox','weeklyBox']
    .forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='block'; });

  setTimeout(()=>{ try{
    attachRealtime();
    autoOpenOnceIfAvailable(true);
    scheduleAutoPopup();
  }catch(e){ console.error(e); } }, 0);
};


function isActiveStatusField(x){
  // true/false, 1/0, active/non-active, ‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
  if (typeof x === 'boolean') return x;
  const s = String(x ?? '').trim().toLowerCase();
  if (!s) return true; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ active
  if (['false','0','no','off','inactive','non-active','disabled','‡∏õ‡∏¥‡∏î','‡∏á‡∏î','‡∏´‡∏¢‡∏∏‡∏î','‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô','‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'].includes(s)) return false;
  if (['true','1','yes','on','active','enabled','‡πÄ‡∏õ‡∏¥‡∏î','‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'].includes(s)) return true;
  return true;
}

function forceLogout(msg){
  try{ if (msg) toast(msg); }catch(_){}
  // ‡∏õ‡∏¥‡∏î modal ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
  ['actModal','chooseModal','qrModal'].forEach(id=>{
    try{ const el=document.getElementById(id); if(el) el.style.display='none'; }catch(_){}
  });
  // ‡∏•‡πâ‡∏≤‡∏á session
  try{
    localStorage.removeItem('SAP');
    localStorage.removeItem('anes.session.v1');
  }catch(_){}
  // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login (‡∏Å‡∏±‡∏ô browser cache)
  setTimeout(()=>{ location.reload(true); }, 120);
}


document.querySelector('#btnLogout').onclick = ()=>{ forceLogout('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö'); };

function showLoginError(msg){
  const el = document.querySelector('#loginMsg');
  el.innerHTML = msg;
  el.classList.remove('muted');
  el.classList.add('bad');   // <- .bad ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
}
function clearLoginMsg(){
  const el = document.querySelector('#loginMsg');
  el.textContent = '';
  el.classList.remove('bad');
  el.classList.add('muted');
}

/* ========= QR lock (10m) ========= */
const QRKEY=()=>`anes.qrlock.${state.sap||'0'}`; let lock=null, raf=null;
function loadLock(){ try{ const x=JSON.parse(localStorage.getItem(QRKEY())||'null'); if(!x) return null; if(Date.now()>x.until){ localStorage.removeItem(QRKEY()); return null } return x }catch{ return null } }
function saveLock(o){ lock=o; localStorage.setItem(QRKEY(),JSON.stringify(o)); }
function clearLock(){ lock=null; localStorage.removeItem(QRKEY()); }
function disableRedeem(dis){ document.querySelectorAll('.btnRedeem').forEach(b=>b.disabled=dis); }
function countdown(until){ const left=Math.max(0,until-Date.now()), mm=Math.floor(left/60000), ss=Math.floor((left%60000)/1000); $('#qrTimer').textContent=`${pad2(mm)}:${pad2(ss)}`; const b=$('#bannerTimer'); if(b) b.textContent=`${pad2(mm)}:${pad2(ss)}`; if(left<=0){ $('#qrExpired').style.display='block'; clearLock(); applyBanner(); if(raf) cancelAnimationFrame(raf); return; } raf=requestAnimationFrame(()=>countdown(until)); }
function applyBanner(){ const el=$('#lockBanner'); if(lock){ el.style.display='block'; $('#bannerShow').onclick=()=>openQR(lock,true); disableRedeem(true); } else { el.style.display='none'; disableRedeem(false); } }
function buildQRUrl(p){ const b64=btoa(unescape(encodeURIComponent(JSON.stringify(p)))); const url=`${ADMIN_PAGE_URL}#p=${encodeURIComponent(b64)}`; return `https://quickchart.io/qr?size=240&text=${encodeURIComponent(url)}`; }
$('#btnCloseQR').onclick=()=>$('#qrModal').style.display='none';
function openQR(o,fromResume=false){ $('#qrRewardName').textContent=o.reward; $('#qrPoints').textContent=fmt(o.pts); $('#qrExpired').style.display='none'; $('#qrAck').textContent=''; $('#qrImg').src=buildQRUrl({sap:o.sap,reward:o.reward,pts:o.pts,ts:o.ts,v:1}); $('#qrModal').style.display='flex'; countdown(o.until); if(!fromResume) applyBanner(); }
function createQR(name,pts){ if(!state.sap) return; if(lock){applyBanner();return;} const ts=new Date().toISOString(), until=Date.now()+10*60*1000; const o={sap:state.sap,reward:name,pts,ts,until}; saveLock(o); disableRedeem(true); openQR(o); }

/* ========= Weekly store ========= */
function weeklyKey(){ return `anes.weekly.${state.sap||'0'}`; }
function loadWeekly(){ try{ return JSON.parse(localStorage.getItem(weeklyKey())||'[]'); }catch{return []} }
function saveWeekly(arr){ localStorage.setItem(weeklyKey(), JSON.stringify(arr)); }
function addOrUpdateWeekly(e){ const arr=loadWeekly(); const i=arr.findIndex(x=>x.dateISO===e.dateISO && String(x.actId||'')===String(e.actId||'')); if(i>=0) arr[i]={...arr[i],...e}; else arr.push(e); saveWeekly(arr); renderWeekly(); }
function thisWeekRange(){ const d=new Date(); const day=(d.getDay()+6)%7; const start=new Date(d); start.setHours(0,0,0,0); start.setDate(d.getDate()-day); const end=new Date(start); end.setDate(start.getDate()+7); return [start,end]; }

/* ========= ‚Äú‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏µ‡∏ï‡∏£‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡∏Å‡∏£‡∏ì‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ========= */
function aKey(id){ return `anes.act.answered.${id}.${todayKey()}.${state.sap||'0'}`; }
function unmarkAns(id){ try{ localStorage.removeItem(aKey(id)); }catch{} }
function clinPairStoreKey(key){ return `anes.group.clinpair.${key}.${todayKey()}.${state.sap||'0'}`; }
function unmarkClinPair(key){ try{ localStorage.removeItem(clinPairStoreKey(key)); }catch{} }

function renderWeekly(){
  const [wStart, wEnd]=thisWeekRange();
  const localArr=loadWeekly().map(x=>({
    dateText:String(x.dateISO||x.ts||''),
    actId:String(x.actId||''),
    title:String(x.title||''),
    result:x.result,
    points:x.points,
    _source:'local'
  }));

    const remoteArr = (state.weeklyRemote || []).map(x => ({
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° x.dateText ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏£‡∏Å
    dateText: String(x.dateText || x.dateISO || x.ts || x.timestamp || ''),
    actId: String(x.actId || ''),
    title: String(x.title || ''),
    result: x.result,
    points: x.points,
    _source: 'remote'
  }));

  const pickByKey={};
  [...localArr,...remoteArr].forEach(x=>{
  const d = anyToDate(x.dateText);
  if(!d) return;
  if(!(d>=wStart && d<wEnd)) return;
  const key = (d.toISOString().slice(0,10)) + '|' + x.actId;
  const item = {
    _d: d,
    title: x.title || (getActMetaById(x.actId)||{}).Title || (getActMetaById(x.actId)||{}).Question || x.actId || '-',
    result: x.result,
    points: Number(x.points||0),
    _source: x._source
  };
  const prev = pickByKey[key];
  if(!prev){ pickByKey[key]=item; return; }
  const better = (prev._source!=='remote' && item._source==='remote') || (item.points > prev.points);
  if(better) pickByKey[key]=item;
});

  const merged = Object.values(pickByKey).sort((a,b)=> b._d - a._d);
  const html = merged.length
    ? merged.map(r=>{
        const th = thaiDate(r._d);
        const result=r.result==null?'‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à':(r.result?'‡∏ñ‡∏π‡∏Å':'‡∏ú‡∏¥‡∏î');
        const pts=(r.points==null)?'‚Äî':fmt(r.points);
        return `<tr><td>${th}</td><td>${escapeHtml(r.title)}</td><td>${result}</td><td>${pts}</td></tr>`;
      }).join('')
    : '<tr><td colspan="4" style="text-align:center">‚Äî</td></tr>';

  $('#weekly').innerHTML=html;
  $('#weeklyBox').style.display='block';
}

function parseLocal(s){ if(!s) return NaN; let t=String(s).trim(); t=t.replace(/([+\-]\d{2}):?(\d{2})$/, (m,hh,mm)=>{ const ok=['00','30','45']; return `${hh}:${ok.includes(mm)?mm:'00'}`; }).replace(/([+\-])(\d)(?=:)/,(_,sign,d)=>`${sign}0${d}`); if(/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(t)){ const ts=new Date(t.replace(' ','T')).getTime(); if(!Number.isNaN(ts)) return ts; } const ts2=new Date(t).getTime(); if(!Number.isNaN(ts2)) return ts2; const m=t.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/); if(m){ const y=Number(m[3])<100?2000+Number(m[3]):Number(m[3]); const mm=Number(m[2])-1; const dd=Number(m[1]); const hh=Number(m[4]||0); const mi=Number(m[5]||0); return new Date(y,mm,dd,hh,mi).getTime(); } return NaN; }
function isIn(st,en){ const now=Date.now(); const a=parseLocal(st); const b=parseLocal(en); if(Number.isNaN(a)&&Number.isNaN(b)) return true; if(Number.isNaN(a)) return now<=b; if(Number.isNaN(b)) return now>=a; const start=Math.min(a,b); const end=Math.max(a,b); return now>=start && now<=end; }
function isTodayLocal(str){ const t=parseLocal(str); if(Number.isNaN(t)) return false; const d=new Date(t), n=new Date(); return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate(); }
function hasAns(id){
  if(!id) return false;

  // --- ‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Protocol & Non-Protocol ---  
  const meta = getActMetaById(id);
  const pairKey = meta ? pairKeyOf(meta) : null;
  if (pairKey) {
      const clinKey = clinPairStoreKey(pairKey);
      if (localStorage.getItem(clinKey)) return true;
  }

  // ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
  if(localStorage.getItem(aKey(id))) return true;

  // ‡∏Ñ‡∏µ‡∏¢‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ans:YYYY-MM-DD:SAP:ActID
  const k2 = `ans:${todayKey('Asia/Bangkok')}:${state.sap||''}:${id}`;
  if(localStorage.getItem(k2)) return true;

  // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (optimistic)
  const x = state.lastSubmission;
  if(!x) return false;
  const same = String(x.actId||'') === String(id||'');
  const ts   = x.ts || x.timestamp;
  if(!ts) return false;

  const d = new Date(ts), n = new Date();
  return same &&
         d.getFullYear()===n.getFullYear() &&
         d.getMonth()===n.getMonth() &&
         d.getDate()===n.getDate();
}

function titleClinType(t){ const s=String(t||'').toLowerCase(); if(/\bnon[-\s]?clinical\b/.test(s) || /(non[-\s]?clinical)/i.test(t)) return 'nonclin'; if(/\bclinic\b/.test(s) || /\bclinical\b/.test(s) || /(clinic)/i.test(t)) return 'clin'; return null; }
function pairKeyOf(a){ const g=a.GroupId||a.groupId||''; const t=a.Title||a.Question||''; const tag=titleClinType(t); return (g && tag)?String(g):null; }

/* ========= Preload activities for titles ========= */
let _allActsLoaded=false;
async function preloadAllActivities(){ if(_allActsLoaded) return; _allActsLoaded=true; try{ const r=await fetch(`${DB_URL}/public/activities.json?t=${Date.now()}`,{cache:'no-store'}); const all=r.ok?await r.json():null; if(all){ Object.values(all).forEach(a=>{ const id=a.ActID||a.id||a.actId; if(id) state.activityIndex[id]=a; }); renderWeekly(); } }catch{} }
function getActMetaById(id){ if(!id) return null; if(actIndex && actIndex[id]) return actIndex[id]; const todays=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{}); const hit=todays.find(a=>(a.ActID||a.id||a.actId)===id); if(hit) return hit; if(state.activityIndex && state.activityIndex[id]) return state.activityIndex[id]; return null; }

/* ========= Realtime wires ========= */
async function attachRealtime(){
  const FB=await ensureFirebase();
  await preloadAllActivities();

  if (state.offUserSummary) { try{ state.offUserSummary(); }catch(_){ } state.offUserSummary=null; }
  state.offUserSummary = onValue(ref(FB.db,'public/usersSummary/'+state.sap), s=>{
  const v = s.val() || {};
  // ‚≠ê Watcher: ‡∏ñ‡πâ‡∏≤ status ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô non-active ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  const active = isActiveStatusField(v.Status ?? v.status ?? v.Active ?? v.active);
  state.userActive = !!active;
  if (!active) { forceLogout('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (non-active)'); return; }

  state.total = Number(v.pointsTotal||v.PointsTotal||0);

  ['kpiBox','actTodayCard','rewardsBox','historyBox','weeklyBox']
    .forEach(id=>$('#'+id).style.display='block');

  const earned = Number(v.pointsEarned||v.PointsEarned||0);
  const used   = Number(v.pointsUsed  ||v.PointsUsed  ||0);
  const total  = Number(v.pointsTotal ||v.PointsTotal || (earned - used) || 0);

  reconcileKPIFromServer(earned, used, total);

  // ‡πÇ‡∏´‡∏•‡∏î lock ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ü‡∏£‡∏°‡πÅ‡∏£‡∏Å enable
  lock = loadLock();
  applyBanner();
  if (lock) openQR(lock, true);

  renderRewards();          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å lock ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
  renderWeekly();
});

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏à‡∏≤‡∏Å path ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà GAS ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ: redemptionsByUser/{sap}
onValue(ref(FB.db, 'public/redemptionsByUser/' + state.sap), async s => {
  const obj  = s.val() || {};
  // obj ‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á { thKey: { ts, reward|rewardName, points, adminName } }
  const list = Object.values(obj)
    .map(x => ({
      timestamp: x.timestamp || x.ts || x.updatedAt || '',
      rewardName: x.rewardName || x.reward || '',
      points: Number(x.points || x.PointsUsed || 0) || 0,
      status: x.status || 'CONFIRMED'
    }))
    .sort((a,b) => new Date(b.timestamp||0) - new Date(a.timestamp||0))
    .slice(0,50);

  if (list.length) {
    $('#history').innerHTML = list.map(x => `
      <tr>
        <td>${escapeHtml(String(x.timestamp||'').replace('T',' ').slice(0,19))}</td>
        <td>${escapeHtml(x.rewardName||'')}</td>
        <td style="text-align:center">${fmt(x.points||0)}</td>
        <td>${escapeHtml(x.status||'')}</td>
      </tr>
    `).join('');
  } else {
    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí ‡∏î‡∏∂‡∏á single latest ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    try{
      const res = await fetch(`${DB_URL}/public/redemptionsLatest/${encodeURIComponent(state.sap)}.json?t=${Date.now()}`, { cache:'no-store' });
      const v = await res.json();
      if (v && typeof v === 'object') {
        const row = `
          <tr>
            <td>${escapeHtml(String((v.timestamp||v.ts||'').replace('T',' ').slice(0,19)))}</td>
            <td>${escapeHtml(v.rewardName || v.reward || '')}</td>
            <td style="text-align:center">${fmt(Number(v.points||0))}</td>
            <td>${escapeHtml(v.status || 'CONFIRMED')}</td>
          </tr>`;
        $('#history').innerHTML = row;
        return;
      }
    }catch(_){}
    $('#history').innerHTML = '<tr><td colspan="4" style="text-align:center">‚Äî</td></tr>';
  }
});

  onValue(ref(FB.db,'public/rewards'), s=>{ state.rewards=s.val()||{}; renderRewards(); if(lock) disableRedeem(true); });
  onValue(ref(FB.db,'public/leaderboard'), s=>{ state.leader=s.val()||[]; });
  onValue(ref(FB.db,'public/actIndex'), snap=>{ actIndex=snap.val()||{}; renderWeekly(); renderLatest(state.lastSubmission||readLatestCache()); });

  onValue(ref(FB.db,'public/redeemAck/'+state.sap), s=>{
    const a=s.val(); if(!a) return; const key=`ack:${state.sap}:${a.timestamp||''}:${a.rewardName||''}`; if(localStorage.getItem(key)) return; localStorage.setItem(key,'1'); try{$('#qrModal').style.display='none';}catch{}; const dt=(a.timestamp||'').replace('T',' ').slice(0,19); toast(`‚úÖ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡πâ‡∏ß<br><b>${escapeHtml(a.rewardName||'')}</b><br>${escapeHtml(dt)} ‚Ä¢ ‡πÇ‡∏î‡∏¢ ${escapeHtml(a.admin||'admin')}`,4500); $('#qrAck').textContent=`‡πÅ‡∏•‡∏Å "${a.rewardName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì ‡πÇ‡∏î‡∏¢ ${a.admin||'admin'}`; clearLock(); applyBanner(); renderRewards();
  });

  preloadAllActivities();
  wireWeeklyRealtime();
  wireAnnualRealtime();

  ensureActivitiesRealtime();
}

/* ========= Rewards render ========= */
function renderRewards(){
  const data = state.rewards || {};

  // ‡πÅ‡∏õ‡∏•‡∏á/‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  const needOf = (v) =>
    Number(v.pointsRequired ?? v.PointsRequired ?? v.points ?? 0) || 0;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢ (tie-break ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠/‡∏™‡∏ï‡πá‡∏≠‡∏Å)
  const list = Object.entries(data)
    .map(([name, v]) => ({
      name,
      v,
      need: needOf(v),
      stock: Number(v.stock ?? v.Stock ?? 0) || 0
    }))
    .sort((a, b) => (b.need - a.need) || (b.stock - a.stock) || a.name.localeCompare(b.name, 'th'));

  const html = list.map(({name, v, need, stock}) => {
    // active guard (‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö true/false, ‚Äúactive/non-active‚Äù, 1/0, ‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
    const isTrue = (x) => {
      const s = String(x ?? '').trim().toLowerCase();
      if (typeof x === 'boolean') return x;
      if (!s) return false;
      if (['false','0','no','off','inactive','non-active','‡∏õ‡∏¥‡∏î','‡∏á‡∏î','‡∏´‡∏¢‡∏∏‡∏î'].includes(s)) return false;
      if (['true','1','yes','on','active','‡πÄ‡∏õ‡∏¥‡∏î','‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'].includes(s)) return true;
      return false;
    };
    const active = isTrue(v.Active ?? v.active);

    const lockNow = (lock ?? loadLock());
    const can = (state.total >= need && stock > 0 && !lockNow && need > 0 && active);

    const raw = (v.imageUrl || v.ImageURL || v.Image || '');
    const url = (() => {
      const u = fixImg(raw);
      if (!u) return '';
      const join = u.includes('?') ? '&' : '?';
      return u + join + 'v=' + encodeURIComponent(v.UpdatedAt || '');
    })();

    const idForThumb = extractId(url);
    return `
      <div class="reward">
        <img loading="lazy" decoding="async"
             class="reward-img"
             src="${url || 'https://via.placeholder.com/56?text=%20'}"
             data-thumb="${idForThumb ? driveThumb(idForThumb) : ''}"
             onerror="this.onerror=null; if(this.dataset.thumb){ this.src=this.dataset.thumb; this.dataset.thumb=''; } else { this.src='https://via.placeholder.com/56?text=%20'; }"
             alt="${escapeHtml(name)}">
        <div style="flex:1">
          <b>${escapeHtml(name)}</b>
          <div class="muted">${Number(need).toLocaleString('th-TH')} ‡πÅ‡∏ï‡πâ‡∏° ‚Ä¢ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${Number(stock).toLocaleString('th-TH')}</div>
        </div>
        <button class="btnRedeem" ${can ? '' : 'disabled'} data-name="${escapeHtml(name)}" data-need="${need}">‡πÅ‡∏•‡∏Å</button>
      </div>`;
  }).join('') || '<div class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî</div>';

  $('#rewards').innerHTML = html;
  document.querySelectorAll('.btnRedeem').forEach(b=>{
    b.onclick = () => { if(b.disabled) return; createQR(b.dataset.name, Number(b.dataset.need||0)); };
  });
}

// ‚≠ê‚≠ê‚≠ê ‡∏ß‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadUsersMap() ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‚≠ê‚≠ê‚≠ê
async function loadUsersMap(){
    const FB = await ensureFirebase();
    const snap = await FB.get(FB.ref(FB.db, 'public/usersSummary'));
    const obj = snap.val() || {};
    const map = {};
    Object.keys(obj).forEach(sap=>{
        const u = obj[sap];
        map[sap] = u.name || u.Name || u.fullName || sap;
    });
    return map;
}

/* ========= Top 20 (dialog) ========= */
$('#btnTop20').onclick = async () => {
  try {
    const FB = await ensureFirebase();
    const snap = await FB.get(FB.ref(FB.db, 'public/usersSummary'));
    const users = snap.val() || {};

    // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà Active ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const top = Object.values(users)
      .filter(u => {
        const rawStatus = u.Status ?? u.status ?? u.active ?? '';
        return isActiveStatus(rawStatus || 'Active');   // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ
      })
      .map(u => {
        const name  = String(u.name || u.Name || u.sap || u.SAP || '-').trim();
        const total = Number(
          u.PointsTotal ?? u.pointsTotal ??
          (Number(u.PointsEarned ?? u.pointsEarned ?? 0) - Number(u.PointsUsed ?? u.pointsUsed ?? 0))
        ) || 0;
        return { name, total };
      })
      // ‡∏•‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πâ‡∏° = 0 ‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ record ‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ
      .filter(r => r.total > 0)
      .sort((a,b) => b.total - a.total)
      .slice(0, 20);

    const thead = `
      <thead>
        <tr>
          <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°</th>
        </tr>
      </thead>`;

    const tbody = `<tbody>${
      top.map((r,i) => `
        <tr>
          <td>${i+1}</td>
          <td>${escapeHtml(r.name || '-')}</td>
          <td>${fmt(r.total)}</td>
        </tr>
      `).join('')
    }</tbody>`;

    $('#dlgTopTitle').textContent = 'Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°';
    $('#dlgTopBody').innerHTML = `<table class="top20-table">${thead}${tbody}</table>`;
    $('#dlgTop').showModal();
  } catch (e) {
    console.error(e);
    $('#dlgTopTitle').textContent = 'Top 20 ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°';
    $('#dlgTopBody').textContent = '‚Äî';
    $('#dlgTop').showModal();
  }
};

/* ========= Activities realtime ========= */
let actOpen=false, _autoTimer=null;
function renderActList(){ $('#actList').innerHTML=''; $('#actList').style.display='none'; }

function ensureActivitiesRealtime(){ (async ()=>{
  const FB=await ensureFirebase(); const tk=todayKey(); const aref=FB.ref(FB.db,'public/activitiesByDate/'+tk);
  FB.onValue(aref, async s=>{
    let obj=s.val()||{}; let arr=Array.isArray(obj)? obj : Object.values(obj||{});
    if(!arr.length){ try{ const r=await fetch(`${DB_URL}/public/activities.json?t=${Date.now()}`,{cache:'no-store'}); const all=(await r.json())||{}; arr=Object.values(all).filter(a=>{ const active=String((a.Active==null?'TRUE':a.Active)).toLowerCase()!=='false'; return active && isTodayAct(a); }); }catch{} }
    state.activities=arr; state.activitiesMap={}; arr.forEach(a=>{ const gid=(a.GroupId||''); (state.activitiesMap[gid] ||= []).push(a); });
    renderWeekly(); renderLatest(state.lastSubmission||readLatestCache()); checkActivity(); renderActList(); autoOpenOnceIfAvailable(); scheduleAutoPopup();
  });
})(); }

function extractDateKey(s){ const m=String(s||'').match(/\b(20\d{2}-\d{2}-\d{2})\b/); return m?m[1]:null; }
function groupDate(a){ return extractDateKey(a.GroupId||a.groupId) || extractDateKey(a.ActID||a.id||a.actId); }
function isTodayAct(a){ const k=todayKey(); const gd=groupDate(a); if(gd) return gd===k; return isTodayLocal(a.WindowStart) || isTodayLocal(a.WindowEnd); }

function pickAct(){
  const list=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{});
  const cand=list.filter(a=>{ const active=String((a.Active==null?'TRUE':a.Active)).toLowerCase()!=='false'; if(!active) return false; const id=a.ActID||a.id||a.actId; if(!id) return false; if(!isTodayAct(a)) return false; if(hasAns(id)) return false; if(!isIn(a.WindowStart,a.WindowEnd)) return false; const pk=pairKeyOf(a); if(pk && localStorage.getItem(clinPairStoreKey(pk))) return false; return true; }).sort((x,y)=>parseLocal(x.WindowStart)-parseLocal(y.WindowStart));
  if(!cand.length) return null;
  const byPair={}; cand.forEach(a=>{ const pk=pairKeyOf(a); if(!pk) return; (byPair[pk]=byPair[pk]||[]).push(a); });
  const pair=Object.entries(byPair).find(([pk,arr])=> arr.length>=2 && !localStorage.getItem(clinPairStoreKey(pk)));
  if(pair){ const list2=pair[1].slice(0,2).sort((x,y)=>parseLocal(x.WindowStart)-parseLocal(y.WindowStart)); return { twoStep:'clinPair', list:list2 }; }
  return cand[0];
}

function autoOpenOnceIfAvailable(force=false){ if(!state.sap || actOpen) return; const pick=pickAct(); if(!pick){ scheduleAutoPopup(); return; } const id= pick.twoStep==='clinPair' ? ('GROUP:'+pairKeyOf(pick.list[0])) : (pick.ActID||pick.id||pick.actId); const key=`anes.autopopup.${todayKey()}.${id}`; if(!force && sessionStorage.getItem(key)) return; sessionStorage.setItem(key,'1'); if(pick.twoStep==='clinPair') openActSelector(pick); else openAct(pick); }
function scheduleAutoPopup(){ clearTimeout(_autoTimer); if(!state.sap) return; const now=Date.now(); const upcoming=getTodayActs().filter(a=>{ const id=a.ActID||a.id||a.actId; if(!id) return false; if(hasAns(id)) return false; const pk=pairKeyOf(a); if(pk && localStorage.getItem(clinPairStoreKey(pk))) return false; const st=parseLocal(a.WindowStart); return !Number.isNaN(st) && st>now; }).sort((a,b)=> parseLocal(a.WindowStart)-parseLocal(b.WindowStart)); if(!upcoming.length) return; const when=Math.max(250, parseLocal(upcoming[0].WindowStart)-now+200); _autoTimer=setTimeout(()=> autoOpenOnceIfAvailable(true), when); }
window.addEventListener('focus', ()=> autoOpenOnceIfAvailable(true));
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) autoOpenOnceIfAvailable(); });
function getTodayActs(){ const l=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{}); return l.filter(isTodayAct); }

/* ========= Winners ========= */
// helper: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å / ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
function isLottoAct(act){
  const cat   = String(act.Category || '').toUpperCase();
  const group = String(act.GroupId  || '').toUpperCase();
  const title = String(act.Title    || act.Question || '').toUpperCase();
  const input = String(act.InputType || '').toUpperCase();

  // ‡πÉ‡∏ä‡πâ Category / GroupId / Title ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ LOTTO ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢
  if (/LOTTO/.test(cat) || /LOTTO/.test(group)) return true;
  if (/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢/.test(title)) return true;

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (NUM2 / NUMBER ‡∏Ø‡∏•‡∏Ø) ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô lotto
  if (['NUM2','NUM','NUMBER','NUMERIC'].includes(input)) return true;

  return false;
}
// ===== ‡∏•‡πá‡∏≠‡∏ï‡πÇ‡∏ï‡πâ‡πÅ‡∏ö‡∏ö "‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" =====
// ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:
//   - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠/‡∏´‡∏°‡∏ß‡∏î/ID ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ LOTTO
//     ‡∏´‡∏£‡∏∑‡∏≠ ActID ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö D1_2025-12-01, D2_2025-12-15 ‡∏Ø‡∏•‡∏Ø
//   - ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö MCQ / CHOICE
function isNumericLottoAct(meta){
  const cat   = String(meta.Category  || meta.category  || '').toUpperCase();
  const group = String(meta.GroupId   || meta.groupId   || meta.group || '').toUpperCase();
  const idRaw =
    meta.ActID      || meta.actId      ||
    meta.ActivityId || meta.activityId ||
    meta.setId      || meta.GroupId    || '';
  const actId = String(idRaw).toUpperCase();
  const input = String(meta.InputType || meta.inputType || '').toUpperCase();

  // ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ LOTTO ‡πÉ‡∏ô Category / Group / ID
  const hasLottoWord =
    /LOTTO/.test(cat)   ||
    /LOTTO/.test(group) ||
    /LOTTO/.test(actId);

  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ID ‡∏Ç‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏ï‡πÇ‡∏ï‡πâ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô D1_2025-12-01, D2_2025-12-16)
  const idLooksLikeDayLotto =
    /^D\d+_20\d{2}-\d{2}-\d{2}$/.test(actId) ||
    /^DAY\d+[_-]/.test(actId);

  const lottoFlag = hasLottoWord || idLooksLikeDayLotto;

  // ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ MCQ / CHOICE
  const mcqFlag = /(MCQ|CHOICE|‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)/.test(input);

  return lottoFlag && !mcqFlag;
}

// ‡∏´‡∏≤ ActID ‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° LOTTO (‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡πÜ ‡∏à‡∏≤‡∏Å activityIndex
function lottoActIdsForDate(dayKey){
  const actsAll = Object.values(state.activityIndex || {});
  const ids = new Set();

  actsAll.forEach(a => {
    if (!a) return;
    // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° LOTTO ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å
    if (!isNumericLottoAct(a)) return;

    // groupDate(a) ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å GroupId/ActID ‡πÄ‡∏ä‡πà‡∏ô D1_2025-12-01 ‚Üí 2025-12-01
    const g = groupDate(a);
    if (g !== dayKey) return;

    const id = a.ActID || a.id || a.actId;
    if (id) ids.add(String(id));
  });

  return Array.from(ids);
}

function currentActForWinners(){
  // ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
  const allActs = getTodayActs()
    .slice()
    .sort((a,b) => (parseLocal(a.WindowStart)||0) - (parseLocal(b.WindowStart)||0));

  if (!allActs.length) return null;

  // ‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢ / ‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
  const nonLotto = allActs.filter(a => !isLottoAct(a));

  // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢ + ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢ ‚Üí ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢
  // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏ï‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Üí ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (allActs)
  const acts = nonLotto.length ? nonLotto : allActs;

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ lastSubmission ‡πÅ‡∏•‡∏∞ activity ‡∏ô‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô
  if (state.lastSubmission &&
      acts.some(a => (a.ActID || a.id || a.actId) === state.lastSubmission.actId)) {
    return acts.find(a => (a.ActID || a.id || a.actId) === state.lastSubmission.actId);
  }

  // ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (window) ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
  const inwin = acts.find(a => isIn(a.WindowStart, a.WindowEnd));
  return inwin || acts[0];
}
async function readJson(path){ try{ const r=await fetch(`${DB_URL}/${path}.json?t=${Date.now()}`,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
async function fetchWinnersTable(today, actId){
  const paths = [
    actId ? `public/winnersByDate/${today}/${encodeURIComponent(actId)}` : null,
    `public/winnersByDate/${today}`
  ].filter(Boolean);

  // helper: flatten object ‡∏ã‡πâ‡∏≠‡∏ô ‡πÜ 1‚Äì2 ‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á object winner ‡∏à‡∏£‡∏¥‡∏á ‡πÜ
  const flattenWinners = (data) => {
    if (!data) return [];
    if (Array.isArray(data)) {
      return data.filter(v => v && typeof v === "object");
    }
    const lvl1 = Object.values(data || {});
    const lvl2 = lvl1.flatMap(v => {
      if (!v) return [];
      if (Array.isArray(v)) return v;
      if (typeof v === "object") return Object.values(v);
      return [];
    });
    return lvl2.filter(v => v && typeof v === "object");
  };

  for (const p of paths){
    const data = await readJson(p);
    if (!data) continue;

    // --- ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà: ‡∏°‡∏µ __table ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á ‡πÜ ---
    if (data.__table && Array.isArray(data.__table.cols) && Array.isArray(data.__table.rows)){
      return {
        cols: data.__table.cols,
        rows: data.__table.rows
      };
    }

    // --- ‡∏ñ‡πâ‡∏≤ data ‡πÄ‡∏õ‡πá‡∏ô table ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ cols/rows) ---
    if (Array.isArray(data.cols) && Array.isArray(data.rows)){
      return {
        cols: data.cols,
        rows: data.rows
      };
    }

    // --- ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° / ‡∏ã‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô ‚Üí flatten ‡∏Å‡πà‡∏≠‡∏ô ---
    const items = flattenWinners(data);
    if (!items.length) continue;

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏∑‡πà‡∏≠ + ‡πÅ‡∏ï‡πâ‡∏° (‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏ß‡∏° = ‡∏£‡∏ß‡∏°‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢ ‡∏ñ‡πâ‡∏≤ server ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    const enriched = items.map((v,i) => {
      const name  = String(
        v.name || v.Name || v.fullName || v.FullName ||
        v.displayName || v.DisplayName ||
        v.sap  || v.SAP  || '-'
      ).trim();

      const pts   = Number(
        v.totalPoints  ?? v.TotalPoints  ??
        v.points       ?? v.Points       ??
        v.score        ?? v.Score        ?? 0
      ) || 0;

      return { index:i, name, points:pts };
    }).filter(r => r.name !== '-' || r.points !== 0); // ‡∏ï‡∏±‡∏î‡πÅ‡∏ñ‡∏ß‡∏´‡πà‡∏≠ ‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≠‡∏Å

    if (!enriched.length) continue;

    enriched.sort((a,b) => b.points - a.points);
    const top = enriched.slice(0,20);

    const cols = ['‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'];
    const rows = top.map((r,idx) => [idx+1, r.name, r.points]);

    return { cols, rows };
  }

  return { cols:['‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö','‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], rows:[] };
}

async function loadTop20Winners(today, actId){
  const paths = [
    actId ? `public/winnersByDate/${today}/${encodeURIComponent(actId)}` : null,
    `public/winnersByDate/${today}`  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢ act (‡πÄ‡∏ä‡πà‡∏ô clinic / non-clinic)
  ].filter(Boolean);

  for (const p of paths){
    const data = await readJson(p);
    if (!data || typeof data !== 'object') continue;

    let winners = [];

    if (actId) {
      // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö pack ‡∏ï‡πà‡∏≠ act: {sap1:{sap,name,ts}, sap2:{...}}
      winners = Object.values(data).filter(v => v && typeof v === 'object');
    } else {
      // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô: {actId:{sap:{...}}, actId2:{...}}
      winners = Object.values(data)
        .flatMap(group => Object.values(group || {}))
        .filter(v => v && typeof v === 'object');
    }

    if (!winners.length) continue;

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡πá‡∏ß ‚Üí ‡∏ä‡πâ‡∏≤
    winners.sort((a,b) => {
      const ta = new Date(a.ts || a.tsISO || a.timestamp || 0).getTime();
      const tb = new Date(b.ts || b.tsISO || b.timestamp || 0).getTime();
      return ta - tb;
    });

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏° SAP ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 20 ‡∏Ñ‡∏ô
    const seen   = new Set();
    const result = [];

    for (const it of winners){
      const sap = String(it.sap || it.SAP || '').trim();
      if (!sap || seen.has(sap)) continue;
      seen.add(sap);
      result.push({
        sap,
        ts: it.ts || it.tsISO || it.timestamp || null
      });
      if (result.length >= 20) break;
    }

    if (result.length) return result;
  }

  return [];
}

// ‡∏õ‡∏∏‡πà‡∏° Top 20 ‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ) ‚Äî ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢"
$('#btnWinners').onclick = async () => {
  if (state.userActive === false) { forceLogout('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (non-active)'); return; }
const today = todayKey();

  // ‡∏î‡∏∂‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°
  const allActs = getTodayActs()
    .slice()
    .sort((a,b) => (parseLocal(a.WindowStart)||0) - (parseLocal(b.WindowStart)||0));

  // ‡∏ï‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö lotto / ‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å ‡∏≠‡∏≠‡∏Å
  const candidateActs = allActs.filter(a => !isLottoAct(a));

  // ‚ùå ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ choice ‡πÄ‡∏•‡∏¢ (‡∏°‡∏µ‡πÅ‡∏ï‡πà lotto) ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏≠‡πà‡∏≤‡∏ô winnersByDate
  if (!candidateActs.length) {
    $('#dlgTopTitle').textContent = 'Top 20 (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ) ‚Äî ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢';
    $('#dlgTopBody').textContent  = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πâ‡∏≠‡∏¢';
    $('#dlgTop').showModal();
    return;
  }

  // ‡∏°‡∏µ choice ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å act ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
  let act = null;

  // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ ‚Üí ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
  if (state.lastSubmission &&
      candidateActs.some(a => (a.ActID || a.id || a.actId) === state.lastSubmission.actId)) {
    act = candidateActs.find(a => (a.ActID || a.id || a.actId) === state.lastSubmission.actId);
  } else {
    // ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô window ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
    act = candidateActs.find(a => isIn(a.WindowStart, a.WindowEnd)) || candidateActs[0];
  }

  let actId = null;
  let titleSuffix = '';

  if (act) {
    const rawTitle = String(act.Title || act.Question || '').trim();
    const pk = pairKeyOf(act);

    if (pk) {
      // Protocol (Clinic / Non-clinic) ‚Üí ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô Protocol ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      const baseTitle = normalizeProtocolTitle(rawTitle) || rawTitle;
      actId = null;  // ‡∏≠‡πà‡∏≤‡∏ô winners ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
      titleSuffix = ` ‚Äî ${baseTitle || 'Protocol'}`;
    } else {
      // ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° choice ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÉ‡∏ä‡πâ actId ‡∏ï‡∏£‡∏á ‡πÜ
      actId = act.ActID || act.id || act.actId || null;
      const t = rawTitle || actId || '';
      titleSuffix = t ? ` ‚Äî ${t}` : '';
    }
  }

  $('#dlgTopTitle').textContent = 'Top 20 (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)' + titleSuffix;

  // ========= 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ winnersByDate (‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß) ‡∏Å‡πà‡∏≠‡∏ô =========
  try {
    let winners = await loadTop20Winners(today, actId);
    if (!winners.length && actId) {
      // ‡∏ñ‡πâ‡∏≤ act ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Üí ‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ choice
      winners = await loadTop20Winners(today, null);
    }

    if (winners.length) {
      const FB   = await ensureFirebase();
      const snap = await FB.get(FB.ref(FB.db, 'public/usersSummary'));
      const users = snap.val() || {};

const rows = winners.map((w, idx) => {
    // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ sap ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏≠‡∏á winnersByDate)
    let sap = '';

    if (w.sap) sap = String(w.sap).trim();
    else if (w.SAP) sap = String(w.SAP).trim();
    else if (w.user || w.User) sap = String(w.user || w.User).trim();
    else if (typeof w === 'string') sap = w.trim();
    else if (typeof w === 'object') {
        // ‡∏´‡∏≤ key ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô sap ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô object ‡∏ã‡πâ‡∏≠‡∏ô
        for (const k in w) {
            if (k.toLowerCase().includes('sap')) {
                sap = String(w[k]).trim();
                break;
            }
        }
    }

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ sap ‡πÄ‡∏•‡∏¢ ‚Üí ‡πÉ‡∏™‡πà '-'
    if (!sap) sap = '-';

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const u = users[sap] || {};

    const name = String(
        u.fullName || u.name || u.Name || sap
    ).trim();

    return [idx + 1, name];
});

      const thead = `
        <thead>
          <tr>
            <th style="width:80px;text-align:center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          </tr>
        </thead>`;

      const tbody = rows.length
        ? `<tbody>${
            rows.map(r => `
              <tr>
                <td style="text-align:center">${r[0]}</td>
                <td>${escapeHtml(r[1] || '-')}</td>
              </tr>
            `).join('')
          }</tbody>`
        : `<tbody><tr><td colspan="2" style="text-align:center">‚Äî</td></tr></tbody>`;

      $('#dlgTopBody').innerHTML =
        `<table class="top20-table">${thead}${tbody}</table>`;
      $('#dlgTop').showModal();
      return;
    }
  } catch (e) {
    console.error('loadTop20Winners error', e);
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ fallback ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
  }

  // ========= 2) Fallback ‡πÄ‡∏î‡∏¥‡∏°: fetchWinnersTable =========
  try {
    const table = await fetchWinnersTable(today, actId);
    const rows  = Array.isArray(table.rows) ? table.rows : [];

    const simpleRows = rows.map((r, i) => {
      if (Array.isArray(r)) {
        const rank = r[0] ?? (i + 1);
        const name = r[1] ?? '-';
        return [rank, name];
      } else if (r && typeof r === 'object') {
        const name = r.name || r.Name || r.fullName || r.FullName || '-';
        return [i + 1, name];
      }
      return [i + 1, String(r ?? '-')];
    });

    const thead = `
      <thead>
        <tr>
          <th style="width:80px;text-align:center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        </tr>
      </thead>`;

    const tbody = simpleRows.length
      ? `<tbody>${
          simpleRows.map(row => `
            <tr>
              <td style="text-align:center">${escapeHtml(String(row[0]))}</td>
              <td>${escapeHtml(String(row[1]))}</td>
            </tr>
          `).join('')
        }</tbody>`
      : `<tbody><tr><td colspan="2" style="text-align:center">‚Äî</td></tr></tbody>`;

    $('#dlgTopBody').innerHTML =
      `<table class="top20-table">${thead}${tbody}</table>`;
    $('#dlgTop').showModal();
  } catch (e) {
    console.error('fallback winners error', e);
    $('#dlgTopBody').textContent = '‚Äî';
    $('#dlgTop').showModal();
  }
};

// ‡∏õ‡∏∏‡πà‡∏° "‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
$('#btnLottoAll').onclick = async () => {
  if (state.userActive === false) { forceLogout('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (non-active)'); return; }
const tz        = 'Asia/Bangkok';
  const today     = todayKey(tz);
  const now       = new Date();
  const yesterday = dayKeyFromDate(
    new Date(now.getTime() - 24*60*60*1000),
    tz
  );

  const hasLottoToday = getTodayActs().some(isLottoAct);

  try {
    let usedDate = today;
    let winners  = await loadLottoCorrectForDate(today);

  // ‚úÖ ‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ñ‡∏π‡∏Å
    if (!winners.length && hasLottoToday) {
      $('#dlgTopTitle').textContent = '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
      $('#dlgTopBody').textContent  = '‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à‡∏≠‡πà‡∏∞';
      $('#dlgTop').showModal();
      return;
    }


    if (!winners.length) {
      winners  = await loadLottoCorrectForDate(yesterday);
      usedDate = yesterday;
    }

    if (!winners.length) {
      $('#dlgTopTitle').textContent = '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ 2 ‡∏ï‡∏±‡∏ß';
      $('#dlgTopBody').textContent  = '‡∏£‡∏≠‡∏£‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞';
      $('#dlgTop').showModal();
      return;
    }

    $('#dlgTopTitle').textContent =
      (usedDate === today)
        ? '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)'
        : '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (‡∏á‡∏ß‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)';

    // ‡πÇ‡∏´‡∏•‡∏î usersSummary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á SAP -> ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
    const FB   = await ensureFirebase();
    const snap = await FB.get(FB.ref(FB.db, 'public/usersSummary'));
    const users = snap.val() || {};

    const rows = winners
      .sort((a,b) => new Date(a.ts || 0) - new Date(b.ts || 0))
      .map((w, idx) => {
        const sap  = String(w.sap || w.SAP || '').trim();
        const u    = users[sap] || {};
        const name = String(
          u.fullName || u.name || u.Name || sap
        ).trim();
        return [idx + 1, name];
      });

    const thead = `
      <thead>
        <tr>
          <th style="width:80px;text-align:center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        </tr>
      </thead>`;

    const tbody = rows.length
      ? `<tbody>${
          rows.map(r => `
            <tr>
              <td style="text-align:center">${r[0]}</td>
              <td>${escapeHtml(r[1] || '-')}</td>
            </tr>
          `).join('')
        }</tbody>`
      : `<tbody><tr><td colspan="2" style="text-align:center">‚Äî</td></tr></tbody>`;

    $('#dlgTopBody').innerHTML =
      `<table class="top20-table">${thead}${tbody}</table>`;
    $('#dlgTop').showModal();
  } catch (e) {
    console.error('load lotto winners error', e);
    $('#dlgTopTitle').textContent = '‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å';
    $('#dlgTopBody').textContent  = '‡∏£‡∏≠‡∏£‡∏≠‡∏ö‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞';
    $('#dlgTop').showModal();
  }
};

// ===== ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å "‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô) =====
async function loadLottoCorrectForDate(dayKey){
  const winnersMap = new Map();   // sap -> { sap, ts }

  // flatten object ‡∏ã‡πâ‡∏≠‡∏ô ‡πÜ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ array ‡∏Ç‡∏≠‡∏á winner
  const flatten = (data) => {
    const out = [];
    const walk = (v) => {
      if (!v) return;

      if (Array.isArray(v)) {
        v.forEach(walk);
      } else if (typeof v === 'object') {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ sap / SAP ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô leaf ‡πÅ‡∏•‡πâ‡∏ß
        if ('sap' in v || 'SAP' in v) {
          out.push(v);
          return;
        }
        Object.values(v).forEach(walk);
      }
    };
    walk(data);
    return out;
  };

  // helper ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ record ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏•‡πá‡∏≠‡∏ï‡πÇ‡∏ï‡πâ‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" ‡πÑ‡∏´‡∏°
  const isLottoRecord = (rec) => {
    const actId = String(
      rec.actId || rec.ActID || rec.activityId || rec.ActivityId || ''
    ).trim();

    const meta   = actId ? (getActMetaById(actId) || {}) : {};
    const cat    = String(meta.Category || rec.Category || rec.category || '').toUpperCase();
    const title  = String(
      meta.Title || meta.Question ||
      rec.title  || rec.Title    || ''
    ).toUpperCase();
    const input  = String(meta.InputType || rec.InputType || rec.inputType || '').toUpperCase();

    const hasWordLotto =
      /LOTTO/.test(cat) || /LOTTO/.test(title) || /‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢/.test(title);

    const isNumeric =
      ['NUM2','NUM','NUMBER','NUMERIC'].includes(input);

    // ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏•‡πá‡∏≠‡∏ï‡πÇ‡∏ï‡πâ‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥ LOTTO/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å
    return hasWordLotto || isNumeric;
  };

  // ========== 1) ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å winnersByDate/<dayKey> ‡∏Å‡πà‡∏≠‡∏ô ==========
  const data = await readJson(`public/winnersByDate/${dayKey}`);
  const items = flatten(data);

  items.forEach(v => {
    const sap = String(v.sap || v.SAP || '').trim();
    if (!sap) return;

    if (!isLottoRecord(v)) return;

    const flag = v.correct ?? v.Correct ?? v.isWinner ?? v.winner;
    if (flag === false || String(flag).toLowerCase() === 'false') return;

    const ts = v.ts || v.tsISO || v.timestamp || v.awardedAt || v.AwardedAt || null;

    if (!winnersMap.has(sap)) {
      winnersMap.set(sap, { sap, ts });
    } else if (ts) {
      const prev = winnersMap.get(sap);
      const t1 = new Date(prev.ts || 0).getTime();
      const t2 = new Date(ts).getTime();
      if (t2 && (t1 === 0 || t2 < t1)) {
        winnersMap.set(sap, { sap, ts });
      }
    }
  });

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏à‡∏≤‡∏Å winnersByDate ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡∏à‡∏ö‡πÄ‡∏•‡∏¢
  if (winnersMap.size) {
    return Array.from(winnersMap.values());
  }

  // ========== 2) Fallback: lottoWinnersByDate/<dayKey> (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ==========
  const dataLotto  = await readJson(`public/lottoWinnersByDate/${dayKey}`);
  const itemsLotto = flatten(dataLotto);

  itemsLotto.forEach(v => {
    const sap = String(v.sap || v.SAP || '').trim();
    if (!sap) return;

    const flag = v.correct ?? v.Correct ?? v.isWinner ?? v.winner;
    if (flag === false || String(flag).toLowerCase() === 'false') return;

    const ts = v.ts || v.tsISO || v.timestamp || v.awardedAt || v.AwardedAt || null;

    if (!winnersMap.has(sap)) {
      winnersMap.set(sap, { sap, ts });
    } else if (ts) {
      const prev = winnersMap.get(sap);
      const t1 = new Date(prev.ts || 0).getTime();
      const t2 = new Date(ts).getTime();
      if (t2 && (t1 === 0 || t2 < t1)) {
        winnersMap.set(sap, { sap, ts });
      }
    }
  });

  return Array.from(winnersMap.values());
}


/* ========= Open activity UI ========= */
function openActSelector(group){ const box=$('#chooseBody'); box.innerHTML=group.list.map((a,i)=>`<button class="ghost" data-i="${i}" style="flex:1">${escapeHtml(a.Title||('‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '+(i+1)))}</button>`).join(''); box.querySelectorAll('button').forEach(btn=>btn.onclick=()=>{ const i=Number(btn.dataset.i||0); $('#chooseModal').style.display='none'; openAct(group.list[i]); }); $('#btnChooseClose').onclick=()=>$('#chooseModal').style.display='none'; $('#chooseModal').style.display='flex'; }

function openAct(act){
  if (state.userActive === false) { forceLogout('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (non-active)'); return; }
const pk = pairKeyOf(act);
  if (pk && localStorage.getItem(clinPairStoreKey(pk))) {
    toast('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Protocol ‡πÅ‡∏•‡πâ‡∏ß');
    actOpen = false;
    return;
  }

  actOpen = true;
  const id = act.ActID || act.id || act.actId;
  const t  = String(act.InputType || 'MCQ').toUpperCase().replace(/[^A-Z0-9]/g,'');

  // üîπ Title = ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ)
  $('#actTitle').textContent = act.Title || '';

  // üîπ Question = ‡∏£‡∏π‡∏õ + ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
  const q = act.Question || '';
  $('#actQuestion').innerHTML = renderQuestionHTML(q);
  $('#actQuestion').style.display = q ? 'block' : 'none';

  $('#actStatus').textContent = '';
  const box = $('#actOpts');
  
  // ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á UI Input (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
  if(['NUM2','NUM','NUMBER','NUMERIC'].includes(t)) { box.innerHTML=`<input id="actText" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å" maxlength="2" inputmode="numeric" style="width:140px;text-align:center">`; setTimeout(()=>{ const inp=$('#actText'); try{ inp.focus(); }catch{}; inp.addEventListener('input', e => e.target.value = e.target.value.replace(/[^\d]/g,'').slice(0,2)); inp.addEventListener('keydown',e=>{ if(e.key==='Enter') $('#btnActSubmit').click(); }); },0); }
  else if(t==='TEXT') { box.innerHTML=`<input id="actText" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" style="width:100%">`; setTimeout(()=>{ try{$('#actText').focus();}catch{} },0); }
  else {
    const labels = ['A','B','C','D'];
    const options = ['OptionA','OptionB','OptionC','OptionD'].map(k=>act[k]).filter(v=>v!=null&&String(v).trim()!=='');
    box.innerHTML = options.length
      ? options.map((t,i)=> {
          const L = labels[i];
          return `<label style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
                    <input type="radio" name="actOpt" value="${L}">
                    <span><b>${L}.</b> ${escapeHtml(String(t))}</span>
                  </label>`;
        }).join('')
      : '<div class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</div>';
  }
  $('#actModal').style.display='flex';

   $('#btnActSubmit').onclick = async () => {
    if (_submitting) return;
    _submitting = true;

    let success = false;   

    try {
      const id = act.ActID || act.id || act.actId;

      // ‚úÖ ‡∏Å‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏ã‡πâ‡∏≥ (‡∏ù‡∏±‡πà‡∏á client)
      if (localStorage.getItem(aKey(id))) {
        $('#actStatus').textContent = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ';
        $('#actModal').style.display = 'none';
        actOpen = false;
        return;
      }

      // ===== 1) ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å UI =====
      let ans;
      if (['NUM2','NUM','NUMBER','NUMERIC','TEXT'].includes(t)) {
        ans = ($('#actText').value || '').trim();

        if (['NUM2','NUM','NUMBER','NUMERIC'].includes(t) && !/^\d{2}$/.test(ans)) {
          $('#actStatus').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å (00‚Äì99)';
          try { $('#actText').focus(); } catch(_){}
          return;
        }
      } else {
        const chk = document.querySelector('input[name="actOpt"]:checked');
        if (!chk) {
          $('#actStatus').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
          return;
        }
        ans = String(chk.value || '').trim().toUpperCase();
      }

      // ===== 2) ‡∏ï‡∏µ‡∏ï‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (optimistic) =====
      localStorage.setItem(aKey(id),'1');
      const pk = pairKeyOf(act);
      if (pk) localStorage.setItem(clinPairStoreKey(pk),'1');
      localStorage.setItem('anes.act.lastAns.' + id + '.' + (state.sap || ''), ans);

      // payload ‡∏™‡πà‡∏á‡πÑ‡∏õ queue
      const key = 'ans_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
      const ts  = new Date().toISOString();
      const payload = {
        sap: state.sap,
        actId: id,
        answer: ans,
        timestamp: ts,
        client: 'web-anesa+'
      };

      // ===== 3) ‡πÄ‡∏î‡∏≤‡∏ú‡∏• "‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î" (Optimistic UI) =====
      const isNumeric = ['NUM2','NUM','NUMBER','NUMERIC'].includes(t);
      const hasAnswer = String(act.Answer || '').trim() !== '';
      const instantOK = (!isNumeric && hasAnswer && typeof clientIsCorrect === 'function')
        ? clientIsCorrect(act, ans)
        : null;

      const optimisticPts = (instantOK === true ? Number(act.BasePoints || 0) : 0);

      const optimistic = {
        actId: id,
        title: (act.Title || id),
        ts,
        correct: instantOK,
        points: optimisticPts,
        userAnswer: ans,
        Finalized: false
      };

      state.lastSubmission = optimistic;
      
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
      addOrUpdateWeekly({
        dateISO: ts,
        title: optimistic.title,
        actId: id,
        result: optimistic.correct,
        points: optimistic.points,
        userAnswer: ans,
        Finalized: false
      });
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏≤‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
      (optimistic);

      $('#actModal').style.display = 'none';
      actOpen = false;
      toast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 1200);
      $('#btnActNow').disabled = true;
      checkActivity();

      // ===== 4) PUT ‡πÄ‡∏Ç‡πâ‡∏≤ RTDB: answersQueue =====
      try {
        await fetch(DB_URL + '/public/answersQueue/' + encodeURIComponent(key) + '.json', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (_) {}

      // ===== 5) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script: queue:process =====
      let server = null;
      try {
        const r = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action:'queue:process', key, item: payload })
        });
        server = await r.json();
      } catch (_) {}

      // ‡∏Å‡∏£‡∏ì‡∏µ Non-active ‚Üí ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      if (server && server.error === 'USER_NON_ACTIVE') {
        toast('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Non-active</b><br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 4000);
        unmarkAns(id);
        const pk2 = pairKeyOf(act);
        if (pk2) unmarkClinPair(pk2);
        $('#btnActNow').disabled = false;
        checkActivity();
        return;
      }

      // ===== 6) ‡∏ñ‡πâ‡∏≤ queue:process ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á =====
      if (server && server.ok) {
        success = true;

        const final = {
          actId: id,
          title: optimistic.title,
          ts: ts,
          correct: (server.correct === 'TRUE'
                      ? true
                      : (server.correct === 'FALSE' ? false : null)),
          points: Number(server.points || 0),
          userAnswer: ans,
          Finalized: (server.correct !== 'PENDING')
        };

        state.lastSubmission = final;

        // üî• [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á Storage ‡∏Å‡πà‡∏≠‡∏ô
        addOrUpdateWeekly({
          dateISO: ts,
          title: final.title,
          actId: id,
          result: final.correct,
          points: final.points,
          userAnswer: ans,
          Finalized: final.Finalized
        });

        // üî• [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        renderLatest(final);

      } else {
        // ===== 7) fallback ‚Üí ‡∏¢‡∏¥‡∏á submit ‡∏ï‡∏£‡∏á‡πÑ‡∏õ Apps Script =====
        const res = await postSubmissionToSheet(payload);

        if (res && res.error === 'USER_NON_ACTIVE') {
          toast('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <b>Non-active</b><br>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 4000);
          unmarkAns(id);
          const pk2 = pairKeyOf(act);
          if (pk2) unmarkClinPair(pk2);
          $('#btnActNow').disabled = false;
          checkActivity();
          return;
        }

        if (res && res.ok) {
          success = true;

          const final = {
            actId: id,
            title: optimistic.title,
            ts: ts,
            correct: (res.correct === 'TRUE'
                        ? true
                        : (res.correct === 'FALSE' ? false : null)),
            points: (res.points == null ? 0 : Number(res.points)),
            userAnswer: ans,
            Finalized: true
          };

          state.lastSubmission = final;
          
          // üî• [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á Storage ‡∏Å‡πà‡∏≠‡∏ô
          addOrUpdateWeekly({
            dateISO: ts,
            title: final.title,
            actId: id,
            result: final.correct,
            points: final.points,
            userAnswer: ans,
            Finalized: true
          });

          // üî• [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2] ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
          renderLatest(final);
        }
      }

      // ===== 8) ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á queue:process ‡πÅ‡∏•‡∏∞ fallback ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏•‡∏¢ ‚Üí rollback =====
      if (!success) {
        // ‡πÄ‡∏≠‡∏≤ flag ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å
        unmarkAns(id);
        const pk3 = pairKeyOf(act);
        if (pk3) unmarkClinPair(pk3);

        // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ weekly ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÉ‡∏™‡πà‡πÅ‡∏ö‡∏ö optimistic
        try {
          const arr = loadWeekly().filter(r =>
            !(String(r.actId||'') === String(id) &&
              String(r.dateISO || r.ts || '') === ts)
          );
          saveWeekly(arr);
          renderWeekly();
        } catch(_) {}

        // ‡∏•‡πâ‡∏≤‡∏á latest cache ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á ‚Äú‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù
        state.lastSubmission = null;
        clearLatestCache();
        const box = $('#actLatest');
        if (box) {
          box.innerHTML = '';
          box.style.display = 'none';
        }

        $('#btnActNow').disabled = false;
        checkActivity();
        toast('‚ùå ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 4000);
      }

    } catch (err) {
      console.error(err);
      $('#actStatus').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
    } finally {
      _submitting = false;
    }
  };

  $('#btnActClose').onclick=()=>{ $('#actModal').style.display='none'; actOpen=false; };
}

// ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (A/B/C/D ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Å/‡∏Ç/‡∏Ñ/‡∏á) ‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function mapAnswerText(act, raw){
  const K = String(raw||'').trim().toUpperCase();

  const optMap = {
    A: act.OptionA, B: act.OptionB, C: act.OptionC, D: act.OptionD,
    '‡∏Å': act.OptionA, '‡∏Ç': act.OptionB, '‡∏Ñ': act.OptionC, '‡∏á': act.OptionD
  };

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏•‡πâ‡∏ß‡∏ô
  if (['A','B','C','D','‡∏Å','‡∏Ç','‡∏Ñ','‡∏á'].includes(K)){
    const t = optMap[K];
    return t ? `${K}. ${t}` : K;
  }

  // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö "A." ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å)" ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
  const m = String(raw||'').trim().match(/^([A-D‡∏Å-‡∏á])[\.\)]?/i);
  const L = m ? m[1].toUpperCase() : '';
  if (L){
    const t = optMap[L];
    return t ? `${L}. ${t}` : raw;
  }

  // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏î‡∏¥‡∏ö
  return raw;
}

function isAnsweredToday(actId){
  const weekly = loadWeekly().filter(r => {
    const ts = r.dateISO || r.ts || r.timestamp;
    return isToday(ts);
  });

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ actId ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  return weekly.some(r => String(r.actId) === String(actId));
}

function showAnswerInstant(question, yourAnswer, correctAnswer, isCorrect, points){
    const box = document.querySelector("#actLatest");
    if(!box) return;

    const status = isCorrect ? "‚úî ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á" : "‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å";
    const color  = isCorrect ? "#0a8c4a" : "#d93025";

    const html = `
        <div style="background:#fff;border:1px solid #e5e5e5;border-radius:10px;
                    padding:12px;margin-bottom:10px;font-size:15px;line-height:1.45;">
            <div><b>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</b> ${question}</div>
            <div><b>‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö:</b> ${yourAnswer} ‚Ä¢ <b style="color:${color}">${status}</b></div>
            <div><b>‡πÄ‡∏â‡∏•‡∏¢:</b> ${correctAnswer||"-"}</div>
            <div><b>‡πÅ‡∏ï‡πâ‡∏°:</b> ${points}</div>
        </div>
    `;

    box.innerHTML = html + box.innerHTML;   // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î
    box.style.display = "block";
}

function renderLatest(latest) {
  const box = $('#actLatest');
  if (!box) return;

const weeklyLocal = loadWeekly().filter(r => {
  const meta = getActMetaById(r.actId) || {};
  const cat  = String(meta.Category || '').toUpperCase();
  const d    = anyToDate(r.dateISO || r.ts);

  return cat.includes('LOTTO')
    ? isYesterday(d)          // ‚≠ê LOTTO ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ 1 ‡∏ß‡∏±‡∏ô
    : isToday(d);             // ‚≠ê activity ‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
});

const weeklyRemote = (state.weeklyRemote || []).filter(r => {
  const meta = getActMetaById(r.actId) || {};
  const cat  = String(meta.Category || '').toUpperCase();
  const d    = anyToDate(r.dateISO || r.ts || r.dateText);

  return cat.includes('LOTTO')
    ? isYesterday(d)          // ‚≠ê LOTTO ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ 1 ‡∏ß‡∏±‡∏ô
    : isToday(d);
});

  // ‡∏£‡∏ß‡∏° + ‡∏ï‡∏±‡∏î‡∏ã‡πâ‡∏≥
  const pick = {};
  [...weeklyLocal, ...weeklyRemote].forEach(w => {
    const actId = String(w.actId || '');
    const ts = w.dateISO || w.ts || '';
    if (!pick[actId]) pick[actId] = w;
    else {
  const d1 = anyToDate(pick[actId].dateISO || pick[actId].ts || pick[actId].dateText);
  const d2 = anyToDate(ts || w.dateText);
  if ((d2?.getTime() || 0) > (d1?.getTime() || 0)) pick[actId] = w;

    }
  });

  const items = Object.values(pick);
  if (!items.length) {
    box.innerHTML = '';
    box.style.display = 'none';
    return;
  }

  const acts = Array.isArray(state.activities)
    ? state.activities
    : Object.values(state.activities || {});

  const html = items.map(w => {
    const act = acts.find(a =>
      String(a.ActID || a.id || a.actId) === String(w.actId)
    ) || {};

    const qText = act.Question || act.Title || w.title || '-';

  let userAns =
    w.Answer ??                 // ‚≠ê ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Submissions
    w.userAnswer ??
    w.ans ??
    w.answer ??
    latest?.userAnswer ??
    localStorage.getItem(`anes.act.lastAns.${w.actId}.${state.sap}`) ??
    '‚Äî';

    // --- ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ú‡∏¥‡∏î ---
    let corr = null;
    const rRaw = w.result ?? w.correct;
    const rStr = String(rRaw ?? '').trim().toLowerCase();

    if (rStr === 'true') corr = true;
    else if (rStr === 'false') corr = false;
    else {
      const pts = Number(w.points || 0);
      corr = pts > 0 ? true : null;
    }

    // --- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ ---
    const pts = Number(w.points || 0);
    const bonus = Number(w.bonus || act.BonusPoints || 0);

    // --- ‡πÄ‡∏â‡∏•‡∏¢ ---
    const ansKey = String(act.Answer || '').trim().toUpperCase();
    const optMap = { A: act.OptionA, B: act.OptionB, C: act.OptionC, D: act.OptionD };
    let correctFull = ansKey;

    if (['A','B','C','D'].includes(ansKey)) {
      const t = optMap[ansKey];
      correctFull = t ? `${ansKey}. ${t}` : ansKey;
    }

    let verdict = '';
    if (corr === true)
      verdict = `<span style="color:#0a8c4a;font-weight:600">‚úîÔ∏è ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>`;
    else if (corr === false)
      verdict = `<span style="color:#d93025;font-weight:600">‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å</span>`;
    else
      verdict = `<span style="color:#6b78a6">‚åõ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>`;

return `
  <div class="act-item">
    <div><b class="lbl">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</b> ${renderQuestionHTML(qText)}</div>
    <div><b class="lbl">‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö:</b> ${escapeHtml(userAns)} ‚Ä¢ ${verdict}</div>
    <div><b class="lbl">‡πÄ‡∏â‡∏•‡∏¢:</b> ${escapeHtml(correctFull)}</div>
    <div><b class="lbl">‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</b> 
        <b class="pts">${pts}</b> 
        <span class="bonus" style="color:#0a8c4a;font-weight:600">
            ${bonus>0 ? `(+${bonus})` : ``}
        </span>
    </div>
  </div>
`;

  }).join('<hr style="border:none;border-top:1px dashed var(--line);margin:6px 0">');

  box.innerHTML = html;
  box.style.display = 'block';
}

function updateBtnActNow(){
    const btn = document.getElementById("btnActNow");

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const hasAct = state.activities && state.activities.length > 0;
    const now = Date.now();

    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ
    const playable = hasAct && state.activities.some(a=>{
        return isTodayLocal(a.WindowStart) &&
               isIn(a.WindowStart,a.WindowEnd) &&
               !hasAns(a.ActID);
    });

    if(playable){
        btn.classList.add("active");
        btn.classList.remove("disabled");
        btn.disabled = false;
    }else{
        btn.classList.remove("active");
        btn.classList.add("disabled");
        btn.disabled = true;
    }
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
setTimeout(updateBtnActNow,600);

const TZ_TH = 'Asia/Bangkok';

function dayKeyTH(d){
  if (!(d instanceof Date) || isNaN(d.getTime())) return '';
  return dayKeyFromDate(d, TZ_TH);
}

/* ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏≠‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡πÑ‡∏ó‡∏¢‡∏à‡∏£‡∏¥‡∏á) */
function isToday(ts){
  const d = anyToDate(ts);
  if (!d) return false;
  return dayKeyTH(d) === todayKey(TZ_TH);
}

/* ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô (‡∏≠‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡πÑ‡∏ó‡∏¢‡∏à‡∏£‡∏¥‡∏á) */
function isYesterday(ts){
  const d = anyToDate(ts);
  if (!d) return false;
  const y = new Date();
  y.setDate(y.getDate() - 1);
  return dayKeyTH(d) === dayKeyFromDate(y, TZ_TH);
}

// ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LOTTO)
function isTodayOrYesterday(ts){
  return isToday(ts) || isYesterday(ts);
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏á server ‡∏™‡πà‡∏á correct (TRUE/FALSE/PENDING) ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
function showAnswerResult(isCorrect, points){
  const last = state.lastSubmission || readLatestCache();
  if (!last) return;

  const final = {
    ...last,
    correct: (isCorrect === true ? true :
              isCorrect === false ? false : null),
    points: (points != null ? Number(points) || 0 : last.points),
    Finalized: (isCorrect !== null),
    ts: last.ts || last.timestamp || new Date().toISOString()
  };

  state.lastSubmission = final;
  saveLatestCache(final);

  // ‚≠ê ‡∏ö‡∏ß‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏ö‡∏ö realtime (‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å)
  if(isCorrect === true && points>0){
      applyKPIDelta(points,0);
  }

  // ‚≠ê update weekly local ‡πÉ‡∏´‡πâ renderLatest() ‡∏î‡∏∂‡∏á‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  addOrUpdateWeekly({
    dateISO: final.ts,
    title: final.title,
    actId: final.actId,
    result: final.correct,
    points: final.points,
    userAnswer: final.userAnswer,
    Finalized: final.Finalized
  });

  // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‚≠ê‚≠ê‚≠ê
  renderLatest({
    actId: final.actId,
    title: final.title,
    userAnswer: final.userAnswer,
    result: final.correct,
    points: final.points,
    bonus: 0
  });
}

function checkActivity(){
  if(!state.sap){
    $('#actTodayCard').style.display='none';
    return;
  }
  $('#actTodayCard').style.display='block';
  const pick=pickAct();
  $('#btnActNow').disabled=!pick;
  renderActList();
}

$('#btnActNow').onclick = () => {
  if (state.userActive === false) { forceLogout('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (non-active)'); return; }
const pick0 = pickAct();
  if (pick0 && hasAns(pick0.actId)) {
      toast("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß", 3000);
      return;
  }
  const pick=pickAct();
  if(!pick){
    $('#btnActNow').disabled=true;
    return;
  }
  if(pick.twoStep==='clinPair'){
    openActSelector(pick);
  } else {
    openAct(pick);
  }
};

function normalizeProtocolTitle(rawTitle){
  const t = String(rawTitle || '');
  // ‡∏ï‡∏±‡∏î (Clinic) / (Clinical) / (Non-clinic) / (Non-clinical) ‡∏≠‡∏≠‡∏Å
  return t
    .replace(/\s*\((?:non[-\s]?(?:clinic|clinical)|clinic|clinical)\)\s*/ig, '')
    .trim() || t;
}

function mapWeeklyRow(it){
  const dateText = String(
    it.dateISO || it.ts || it.timestamp || it.Date || it.date || it.time || ''
  );
  const actId = String(
    it.actId || it.ActID || it.ActivityId || it.activityId ||
    it.setId || it.GroupId || it.FormId || ''
  );

  let rawTitle = String(
    it.title || it.Title || it.ActivityTitle || it.FormTitle ||
    it.name || it.question || ''
  );

  let title = normalizeProtocolTitle(rawTitle);
  if (!title && actId){
    const meta = getActMetaById(actId);
    if (meta) title = meta.Title || meta.Question || '';
  }

  const r = (it.result ?? it.Result ?? it.correct ?? it.Correct);
  let result = null;
  if (r === true || String(r).toLowerCase() === 'true' || String(r) === '1') result = true;
  if (r === false || String(r).toLowerCase() === 'false' || String(r) === '0') result = false;

  const points = Number(
    it.points ?? it.Points ?? it.point ??
    it.award  ?? it.Award  ?? it.pointsAwarded ?? it.Score ?? 0
  ) || 0;

  const userAnswer =
    it.userAnswer   ?? it.UserAnswer   ??
    it.answerUser   ?? it.AnswerUser   ??
    it.answer       ?? it.Answer       ?? null;

  return { dateText, actId, title, result, points, userAnswer };   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° userAnswer ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
}

async function wireWeeklyRealtime(){
  const FB = await ensureFirebase();
  const unsub = [];
  const paths = [
    `public/weeklyByUser/${state.sap}`,
    `public/FormAwardsByUser/${state.sap}`,
    `public/formAwardsByUser/${state.sap}` // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢
  ];
  paths.forEach(p => {
  const r = ref(FB.db, p);
  const stop = onValue(r, snap => {
    const obj = snap.val() || {};
    const arr = Array.isArray(obj) ? obj : Object.values(obj);
    if (!arr.length) return;

    state.weeklyRemote = arr.map(mapWeeklyRow);
    renderWeekly();
    renderLatest(state.lastSubmission || readLatestCache()); // ‚úÖ ‡πÉ‡∏™‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
  });
  unsub.push(() => off(r));
});

  state.offWeekly = () => unsub.forEach(f => f && f());
}

/* ========= Annual (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å annualByUser ‡πÅ‡∏ö‡∏ö 004) ========= */
  function wireAnnualRealtime(){
  const sap = (state && state.sap || '').trim();
  if (!sap) return;

  const db = getDatabase();

  // ‡∏õ‡∏¥‡∏î listener ‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  if (state.offAnnual) {
    try { state.offAnnual(); } catch(e){}
    state.offAnnual = null;
  }

  const path = `public/annualByUser/${encodeURIComponent(sap)}`;
  const annualRef = ref(db, path);

  state.offAnnual = onValue(annualRef, snap => {
    const val = snap.val();
    state.annual = val || null;
    renderAnnual();
  }, err => {
    console.error('annual realtime error', err);
  });
}

// ‡πÅ‡∏õ‡∏•‡∏á Timestamp / AwardedAt ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‡∏ß‡∏î‡∏õ ‡πÑ‡∏ó‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ)
function annualDateFromRow(row){
  if (!row) return '‚Äî';

  // 1. ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô
  const raw = row.Timestamp ?? row.timestamp ?? row.AwardedAt ?? row.awardedAt ?? null;

  if (raw != null) {
      try {
        // ‡πÉ‡∏ä‡πâ anyToDate ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1
        const d = anyToDate(raw); 
        if (d) return thaiDate(d);
      } catch (e) {
        // ‡∏´‡∏≤‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Fallback
      }
  }
  
  // 2. Fallback: ‡πÉ‡∏ä‡πâ pickDateFrom ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤ (‡∏à‡∏∞‡πÑ‡∏•‡πà‡∏´‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ date/time/stamp/award)
  // pickDateFrom ‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const d_fallback = pickDateFrom(row);
  return thaiDate(d_fallback); // thaiDate ‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ '‚Äî' ‡∏ñ‡πâ‡∏≤ d_fallback ‡πÄ‡∏õ‡πá‡∏ô null
}

function getCurrentThaiYear(){
  return new Date().getFullYear() + 543;
}

function renderAnnual(){
  const box   = document.querySelector('#annualBox');
  const tbody = document.querySelector('#annual');
  if (!box || !tbody) return;

  const source = state.annual || {};
  let rows = [];

  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á array ‡πÅ‡∏•‡∏∞ object ‡∏à‡∏≤‡∏Å annualByUser
  if (Array.isArray(source)) {
    rows = source;
  } else if (source && typeof source === 'object') {
    if (Array.isArray(source.rows)) {
      rows = source.rows;
    } else {
      rows = Object.values(source);
    }
  }

  if (!rows.length){
    box.style.display = 'none';
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">‚Äî</td></tr>';
    return;
  }

// ‚≠ê FIX: ‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ (Form ‡πÄ‡∏î‡∏¥‡∏° + ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
const seen = new Set();
rows = rows.filter(r => {
  const name =
    r.Title      ?? r.title      ??
    r.FormTitle  ?? r.formTitle  ??
    r.FormName   ?? r.formName   ??
    r.name       ?? '';

  const dt = annualDateFromRow(r); // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏≠‡∏ô render

  const key = `${name}|${dt}`;
  if (seen.has(key)) return false;
  seen.add(key);
  return true;
});

// ‚≠ê FIX: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏û.‡∏®.)
const currentYearTH = getCurrentThaiYear();
rows = rows.filter(r => {
  const d = anyToDate(
    r.Timestamp   ?? r.timestamp ??
    r.AwardedAt   ?? r.awardedAt ??
    r.dateISO     ?? r.dateIso   ??
    r.date        ?? r.Date      ??
    r.time        ?? r.Time      ?? null
  );
  if (!d) return false;
  return (d.getFullYear() + 543) === currentYearTH;
});

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‡∏ß‡∏î‡∏õ ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏Å‡πà‡∏≤
  rows.sort((a, b) => {
    const da = anyToDate(
      a.Timestamp   ?? a.timestamp ??
      a.AwardedAt   ?? a.awardedAt ??
      a.dateISO     ?? a.dateIso   ??
      a.date        ?? a.Date      ??
      a.time        ?? a.Time      ?? null
    );
    const db = anyToDate(
      b.Timestamp   ?? b.timestamp ??
      b.AwardedAt   ?? b.awardedAt ??
      b.dateISO     ?? b.dateIso   ??
      b.date        ?? b.Date      ??
      b.time        ?? b.Time      ?? null
    );
    const ta = da ? da.getTime() : 0;
    const tb = db ? db.getTime() : 0;
    return tb - ta;
  });

  const html = rows.map(r => {
    const dt = annualDateFromRow(r);

    // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° ‡∏à‡∏≤‡∏Å FORM_TITLES.Title ‡∏´‡∏£‡∏∑‡∏≠ field ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
    const name =
      r.Title      ?? r.title      ??
      r.FormTitle  ?? r.formTitle  ??
      r.FormName   ?? r.formName   ??
      r.name       ?? '-';

  // ‚≠ê FIX: ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    const pts = fmt(
      Number(
        r.Points ?? r.points ??
        r.Score  ?? r.score  ??
        r.TotalPoints ?? r.totalPoints ?? 0
      ) || 0
    );

    return `<tr>
      <td>${escapeHtml(dt)}</td>
      <td>${escapeHtml(name)}</td>
      <td style="text-align:center">${pts}</td>
    </tr>`;
  }).join('');

  box.style.display = 'block';
  tbody.innerHTML   = html;
}

/* ========= Auto restore ========= */
(function restoreSession(){ const sess=readSession(); if(!sess||!sess.sap) return; state.sap=sess.sap; state.name=sess.name||sess.sap; setWelcome(state.name); document.body.classList.remove('is-login'); $('#loginBox').style.display='none'; $('#btnLogout').style.display='inline-block'; $('#actTodayCard').style.display='block'; renderLatest(readLatestCache()); clearAutoPopupFlags(); attachRealtime(); autoOpenOnceIfAvailable(true); scheduleAutoPopup(); })();

/* ========= Heartbeat ========= */
setInterval(()=>{ if(!state.sap) return; try{ if(!actOpen){ checkActivity(); autoOpenOnceIfAvailable(); } }catch{} }, 5000);

// ===== Client-side correctness helper (instant MCQ) =====
function _normStr(s){
  return String(s||'').replace(/[.\u200b]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
}
function stripChoicePrefix_(s){
  return String(s||'').replace(/^\s*([A-D‡∏Å-‡∏á])[\.\)]?\s*/i,'');
}
function clientIsCorrect(meta, userAns){
  const cat = String(meta.Category||'');
  if(/DAY(1|16)_LOTTO/i.test(cat)){
    const u2 = String(userAns||'').replace(/\D/g,'').slice(-2);
    const a2 = String(meta.Answer||'').replace(/\D/g,'').slice(-2);
    return (u2 && a2 && u2===a2);
  }
  const a = _normStr(stripChoicePrefix_(meta.Answer));
  const u = _normStr(userAns);
  if(u && a && u===a) return true;

  const letterMap = {A:'OptionA',B:'OptionB',C:'OptionC',D:'OptionD','‡∏Å':'OptionA','‡∏Ç':'OptionB','‡∏Ñ':'OptionC','‡∏á':'OptionD'};
  if(u.length===1){
    const keyRaw = String(userAns||'').trim();
    const key = letterMap[keyRaw.toUpperCase()] || letterMap[keyRaw];
    const full = key ? _normStr(stripChoicePrefix_(meta[key]||'')) : '';
    if(full && full===a) return true;
  }
  const m = String(meta.Answer||'').trim().match(/^([A-D‡∏Å-‡∏á])[\.\)]?/i);
  const ansLetter = m ? m[1].toUpperCase() : '';
  if(ansLetter){
    if(String(userAns||'').trim().toUpperCase() === ansLetter) return true;
    const opt = letterMap[ansLetter];
    const full = opt ? _normStr(stripChoicePrefix_(meta[opt]||'')) : '';
    if(full && _normStr(userAns) === full) return true;
  }
  return false;
}

// ‡πÉ‡∏ä‡πâ anyToDate ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date
function pickDateFrom(o){
  if (!o) return null;

  // ‡∏•‡∏≠‡∏á‡∏î‡∏π key ‡∏´‡∏•‡∏±‡∏Å ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
  const keys = [
    'dateText','dateISO','dateIso',
    'awardedAt','AwardedAt',
    'timestamp','ts',
    'date','Date',
    'time','Time'
  ];

  for (const k of keys){
    if (o[k] != null && String(o[k]).trim() !== ''){
      const d = anyToDate(o[k]);
      if (d) return d;
    }
  }

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏•‡∏≠‡∏á‡πÑ‡∏•‡πà‡∏ó‡∏∏‡∏Å field ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ date/time/stamp/award
  for (const [k,v] of Object.entries(o)){
    if (!v) continue;
    if (!/(date|time|stamp|award)/i.test(k)) continue;
    const d = anyToDate(v);
    if (d) return d;
  }

  return null;
}

function fmtThaiDate(d){
  return d
    ? d.toLocaleDateString('th-TH', {
        day:'2-digit',
        month:'2-digit',
        year:'numeric'
      })
    : '‚Äî';
}

// ‡πÉ‡∏ô User_006_fixed3.11.html: ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fmtThaiDate
// **********************************************

function shouldActivityBeHidden(act, todayKey, hasAnswered) {
    if (!act.Active || act.Active.toUpperCase() === 'FALSE') {
        return true; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Non-Active
    }

    const wsKey = act.WindowStart ? act.WindowStart.substring(0, 10) : '';
    const weKey = act.WindowEnd ? act.WindowEnd.substring(0, 10) : '';

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° LOTTO ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÉ‡∏ä‡πâ Category ‡∏´‡∏£‡∏∑‡∏≠ GroupId)
    const isLotto = String(act.Category || '').toUpperCase().includes('LOTTO');

    // -----------------------------------------------------
    // LOGIC ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° LOTTO: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å 1 ‡∏ß‡∏±‡∏ô
    // -----------------------------------------------------
    if (isLotto) {
        // 1. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (WindowStart) ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
        if (wsKey && wsKey > todayKey) return true;

        // 2. ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (WindowStart ‡∏ñ‡∏∂‡∏á WindowEnd) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
        if ((!wsKey || wsKey <= todayKey) && weKey >= todayKey) return false;

        // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡πâ‡∏ô WindowEnd ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß '1 ‡∏ß‡∏±‡∏ô' ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
        if (weKey) {
            // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô parseDateFlexible_ ‡πÅ‡∏•‡∏∞ fmtDayKey ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
            const endDate = parseDateFlexible_(weKey); 
            if (endDate) {
                const dayAfterEnd = new Date(endDate);
                dayAfterEnd.setDate(endDate.getDate() + 1);
                const dayAfterEndKey = fmtDayKey(dayAfterEnd); 

                // ‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡∏à‡∏≤‡∏Å WindowEnd
                if (dayAfterEndKey === todayKey) {
                    return false;
                }
            }
        }
        
        // 4. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô
        return true; 
    }
    // -----------------------------------------------------

    // LOGIC ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Choice)
    if (wsKey && wsKey > todayKey) return true; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    if (weKey && weKey < todayKey) return true; // ‡∏û‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    if (hasAnswered) return true; // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
    
    return false;
}

// ‚≠ê ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• submission ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Weekly Format ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö renderLatest_v3
function renderLatestInstant(answerPayload, result, points){
    const obj = {
        actId: answerPayload.actId,
        title: answerPayload.title || state.currentQuestion?.title,
        userAnswer: answerPayload.answer,
        result: result===true ? true : result===false ? false : null,
        points: Number(points||0),
        bonus: 0,
        dateISO: new Date().toISOString(),
    };

    console.log("Render instant >>>",obj);
    renderLatest([obj]);   // ‡πÉ‡∏ä‡πâ renderLatest_v3 ‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
}

function updateActNowButton(isAvailable){
  const btn = document.getElementById('btnActNow');
  if(!btn) return;

  if(isAvailable){
    btn.classList.add('active');
    btn.classList.remove('disabled');
    btn.disabled = false;
  } else {
    btn.classList.remove('active');
    btn.classList.add('disabled');
    btn.disabled = true;
  }
}

/* ===== Reward image lightbox (zoom only rewards) ===== */
document.addEventListener('click', function(e){

  // üîç ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const img = e.target.closest('img.reward-img');
  if (img) {
    const box = document.querySelector('#imgLightbox');
    const big = document.querySelector('#imgLightboxImg');
    if (!box || !big) return;

    big.src = img.dataset.full || img.src;
    box.style.display = 'flex';
    return;
  }

  if (e.target.id === 'imgLightbox') {
    e.target.style.display = 'none';
  }
});

</script>

<div id="imgLightbox" class="img-lightbox">
  <img id="imgLightboxImg" alt="">
</div>

</body>
</html>