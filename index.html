<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>ANESA+ — User (latest)</title>
<link rel="preconnect" href="https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app" crossorigin>
<link rel="preload" as="image" href="logo3.png" />
<style>
  /* ---------- ตัวแปรหลัก ---------- */
  /* ========== Base variables ========== */
:root{
  --bg:#f6f8fd; --card:#fff; --line:#e6e9f2; --txt:#0f1733; --muted:#6b78a6;
  --btn:#1f6fff; --danger:#d93025; --ok:#0a8c4a;
  --header-h:64px;

  /* pastel/border for cards & KPI */
  --bd:#e9eef7;
  --shadow:0 6px 24px rgba(13,38,76,.06);

  --kpi-total-bg:#eaf1ff; --kpi-total-bd:#d6e4ff; /* ฟ้าอ่อน */
  --kpi-used-bg:#ffe9e9;  --kpi-used-bd:#ffd6d6;  /* ชมพูอ่อน */
  --kpi-left-bg:#e9f8ee;  --kpi-left-bd:#d7f0de;  /* เขียวอ่อน */
}

/* ========== Reset / layout ========== */
*{ box-sizing:border-box }
html,body{ height:100%; margin:0 }
body{
  font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  background:var(--bg); color:var(--txt);
}

/* ========== Header (fixed) ========== */
header{
  position:fixed; inset:0 auto auto 0; right:0; top:0;
  z-index:1000; display:flex; align-items:center; gap:12px;
  background:#1d3557; color:#fff; padding:10px 14px;
}
header img{ height:44px; width:auto }
.brand{ display:flex; flex-direction:column; line-height:1.15 }
.brand .sys{ font-size:24px; font-weight:800; letter-spacing:.2px }
.brand .welcome{ font-size:13px; color:#cdd4f0 }
.spacer{ flex:1 }

/* Logout button (icon) */
#btnLogout{
  background:#1f6fff; color:#fff; border:none; border-radius:12px;
  padding:8px 14px; cursor:pointer; box-shadow:0 6px 16px rgba(31,111,255,.25);
}
#btnLogout.icon-btn{
  width:36px; height:36px; padding:0; display:inline-grid; place-items:center;
  background:#fec89a; border-radius:12px; box-shadow:0 6px 16px rgba(31,111,255,.25);
}
#btnLogout.icon-btn svg{ width:20px; height:20px; fill:currentColor; }

/* ========== Main container ========== */
main{
  max-width:980px; margin:0 auto;
  padding:14px; display:grid; gap:18px;
  margin-top:calc(var(--header-h) + 8px);
}

/* ========== Generic UI ========== */
.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
input,button{
  border-radius:12px; border:1px solid var(--line);
  padding:10px 12px; font:inherit;
}
button{ cursor:pointer; background:var(--btn); color:#fff; border-color:transparent }
button.ghost{ background:#0f1733; color:#fff }
button[disabled]{ background:#cfd7ff; color:#6570a0; cursor:not-allowed }
.muted{ color:var(--muted) }
.pill{ display:inline-block; background:#eef3ff; border-radius:999px; padding:6px 12px }

/* ========== Card ========== */
.card{
  background:#fff; border:1px solid var(--bd); border-radius:16px;
  box-shadow:var(--shadow); padding:16px; position:relative;
}
.card>h3:first-child{
  position:static; margin:0 0 10px; padding:0;
  border:0; background:transparent; border-radius:0;
  font-size:16px; font-weight:800; display:flex; gap:8px; color:var(--txt);
}

/* ========== Rewards list ========== */
.reward{
  display:flex; gap:10px; align-items:center;
  border:1px solid var(--line); border-radius:10px; padding:10px; margin-bottom:8px;
}
.reward img{
  width:56px; height:56px; border-radius:8px; object-fit:cover;
  background:#f4f6fb; border:1px solid var(--line);
}

/* ========== Tables ========== */
table{ width:100%; border-collapse:collapse }
th,td{ border:1px solid var(--line); padding:8px 10px; text-align:left }
#annualBox table th:last-child,
#annualBox table td:last-child{ text-align:center; width:90px }
#weeklyBox table th:nth-child(3),
#weeklyBox table td:nth-child(3),
#weeklyBox table th:nth-child(4),
#weeklyBox table td:nth-child(4){ text-align:center; width:90px }

/* ========== Modals & toast ========== */
#qrModal,#actModal,#chooseModal{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.5); z-index:60;
}
#qrBox,#actBox,#chooseBox{
  background:#fff; border:1px solid var(--line); border-radius:12px;
  padding:16px; max-width:640px; width:92vw;
}
.timer{ font-variant-numeric:tabular-nums; font-size:22px }
.pill2{ display:inline-block; background:#fff7e6; border:1px solid #ffd18a; color:#8a5300; border-radius:999px; padding:4px 10px }
.bad{ color:var(--danger) } .ok{ color:var(--ok) }
.toast{
  position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
  background:#0c8c5f; color:#fff; padding:10px 14px; border-radius:10px;
  box-shadow:0 8px 22px rgba(0,0,0,.18); opacity:0; transition:.25s; z-index:999;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px) }
.latest{ border:1px dashed var(--line); background:#f7f9ff; border-radius:10px; padding:10px; margin-bottom:10px }
.latest b{ font-weight:800 }

/* ========== Login page ========== */
body.is-login{ overflow:hidden; }
#loginBox{ display:flex; align-items:flex-start; justify-content:center; padding:12px }
.login-card{
  width:min(560px,92vw); text-align:center;
  background:rgba(255,255,255,.86); border:1px solid rgba(255,255,255,.6);
  border-radius:22px; box-shadow:0 20px 50px rgba(20,34,89,.12), 0 6px 18px rgba(20,34,89,.08);
  backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
  padding:26px 18px 20px;
}
.login-logo{ width:88px; height:88px; object-fit:contain; margin:0 auto 6px; display:block; animation:floaty 3.6s ease-in-out infinite }
.login-title{ font-weight:800; font-size:clamp(18px,3.6vw,24px); margin:2px 0 }
.login-sub{ margin:0 0 12px; color:#7a86b6 }
.login-row{ display:flex; justify-content:center; gap:12px }
#sap{ width:170px; height:42px; text-align:center; border-radius:999px; border:1px solid #e2e7fb; background:#fff; box-shadow:inset 0 1px 0 rgba(255,255,255,.7) }
#sap:focus{ outline:none; border-color:#b9c8ff; box-shadow:0 0 0 4px rgba(116,148,255,.22) }
#btnLogin{
  height:42px; border-radius:999px; border:none; padding:0 18px; font-weight:700; letter-spacing:.2px;
  background:linear-gradient(135deg,#3b82f6,#6d28d9); box-shadow:0 10px 20px rgba(59,130,246,.25);
}
#btnLogin:hover{ transform:translateY(-1px); filter:brightness(1.03); box-shadow:0 12px 24px rgba(59,130,246,.3) }
@keyframes floaty{ 0%,100%{ transform:translateY(-2px) } 50%{ transform:translateY(2px) } }

/* ดันหน้า Login ลงจากเฮดเดอร์ (ปรับตัวเลขได้) */
body.is-login main{ margin-top:calc(var(--header-h) + 140px) !important; } /* อยากลงมากขึ้น/น้อยลง ปรับ 120 */

/* ========== KPI section ========== */
#kpiBox{ padding-top:8px; }
#kpiBox > h3{ margin:0 0 6px; }
#kpiBox .kpiRow{
  display:flex; align-items:center; gap:12px; margin-top:2px;
}
.kpi{
  min-width:136px; padding:10px 14px; text-align:center;
  border:1px solid var(--line); border-radius:12px;
  box-shadow:inset 0 2px 8px rgba(15,23,51,.05);
}
.kpi .label{ display:block; font-size:12px; line-height:1.2; color:var(--muted); margin-bottom:2px }
.kpi .value{ display:block; font-size:22px; font-weight:800; line-height:1 }

/* KPI colors */
.kpi.is-total{ background:var(--kpi-total-bg); border-color:var(--kpi-total-bd); color:#1f4b99 }
.kpi.is-used { background:var(--kpi-used-bg);  border-color:var(--kpi-used-bd);  color:#9c2a2a }
.kpi.is-left { background:var(--kpi-left-bg);  border-color:var(--kpi-left-bd);  color:#0a6b3d }

/* Top 20 button */
#kpiBox #btnTop20{
  margin-left:auto; font-size:13px; padding:6px 10px; border-radius:10px;
  background:#1f6fff; color:#fff; border:none; white-space:nowrap;
  box-shadow:0 4px 12px rgba(31,111,255,.18);
}

/* ========== Responsive ========== */
@media (max-width:720px){
  #kpiBox .kpiRow{ flex-wrap:wrap }
  #kpiBox #btnTop20{ order:4 } /* ลงบรรทัดใหม่ท้ายสุดเมื่อแคบ */
}
@media (max-width:520px){
  header img{ height:40px }
  .brand .sys{ font-size:22px }
  #sap{ width:150px; height:40px }
  #btnLogin{ height:40px; padding:0 16px }
  .login-logo{ width:80px; height:80px }
  .kpi{ min-width:120px; padding:8px 10px }
  .kpi .value{ font-size:20px }
  #btnLogout.icon-btn{ width:32px; height:32px; border-radius:10px }
  #btnLogout.icon-btn svg{ width:18px; height:18px }
}

/* ---- Fix: เว้นระยะหัวกับกล่องล็อกอิน ---- */
body.is-login main{
  /* ดันลงจากเฮดเดอร์อีก 24px */
  margin-top: calc(var(--header-h) + 8px) !important;
}

body.is-login #loginBox{
  /* กันชนเผื่อไว้ เพิ่ม padding-top ภายใน section */
  padding-top: 16px !important;
}

body.is-login .login-card{
  /* กัน CSS อื่นทับค่า: ถ้ายังชิดอยู่ ให้การ์ดมีระยะเองด้วย */
  margin-top: 48px !important;
}

</style>

</head>
<body class="is-login">
<header>
  <img src="logo4.png" alt="logo" />
  <div class="brand">
    <div class="sys">Anesthesia A+</div>
    <div id="welcomeText" class="welcome" style="display:none">ยินดีต้อนรับคุณ —</div>
  </div>
  <div class="spacer"></div>
  <button id="btnLogout" class="icon-btn" title="ออกจากระบบ" aria-label="ออกจากระบบ" style="display:none">
  <!-- ไอคอน logout แบบ SVG -->
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M10 3a1 1 0 0 0-1 1v4h2V6h8v12h-8v-2H9v4a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H10z"/>
    <path d="M13 12a1 1 0 0 0-1-1H5.41l1.3-1.29A1 1 0 1 0 5.3 7.3l-3 3a1 1 0 0 0 0 1.41l3 3a1 1 0 1 0 1.41-1.41L5.41 13H12a1 1 0 0 0 1-1z"/>
  </svg>
</button>

</header>

<main>
  <!-- Login -->
  <section id="loginBox">
    <div class="login-card">
      <img src="logo3.png" alt="Mascot" class="login-logo" />
      <h1 class="login-title">เข้าสู่ระบบ Anesthesia A+<br>ตอน “ล่าทิ้ว...บิ้วแต้ม”</h1>
      <p class="login-sub">ใส่รหัส <b>SAP</b> ของคุณ เพื่อเริ่มสะสมแต้มและแลกรางวัล</p>
      <div class="login-row">
        <input id="sap" placeholder="SAP" inputmode="numeric" autocomplete="off" />
        <button id="btnLogin">เข้าสู่ระบบ</button>
      </div>
      <div id="loginMsg" class="muted" style="margin-top:8px;min-height:20px"></div>
    </div>
  </section>

  <!-- KPI + Top20 -->
  <section id="kpiBox" class="card" style="display:none">
    <h3>📊 แต้มสะสมของคุณ</h3>
    <div class="kpiRow row">
      <div class="kpi is-total">
      <span class="label">รวมทั้งหมด</span>
      <span class="value" id="uEarned">0</span>
    </div>
    <div class="kpi is-used">
      <span class="label">ใช้ไปแล้ว</span>
      <span class="value" id="uUsed">0</span>
    </div>
    <div class="kpi is-left">
      <span class="label">คงเหลือ</span>
      <span class="value" id="uTotal">0</span>
    </div>
    <button id="btnTop20">🏆Top 20</button>
  </div>
  </section>

  <!-- Today / Activities -->
  <section id="actTodayCard" class="card" style="display:none">
    <h3>🍀 กิจกรรมวันนี้</h3>
    <div id="actLatest" class="latest" style="display:none"></div>
    <div id="actTodayInfo" class="muted" style="display:none"></div>
    <div class="row" style="margin-top:8px">
      <button id="btnActNow">คำถามตอนนี้</button>
      <button id="btnWinners">Top 20 ถูกและเร็ว (วันนี้)</button>
    </div>
    <div id="actList" style="margin-top:10px;display:none"></div>
  </section>

  <!-- Rewards -->
  <section id="rewardsBox" class="card" style="display:none">
    <h3>🎁 ของรางวัลที่แลกได้</h3>
     <div id="rewards"></div>
    <div id="lockBanner" class="muted" style="margin-top:6px;display:none">
      <span>มี QR รอการยืนยัน — หมดอายุใน <b class="timer" id="bannerTimer">10:00</b></span>
      <button class="ghost" id="bannerShow" style="margin-left:8px">เปิด QR</button>
    </div>
  </section>

  <!-- History -->
  <section id="historyBox" class="card" style="display:none">
    <h3>📄 ประวัติการแลก</h3>
    <table>
      <thead><tr><th>เวลา</th><th>รางวัล</th><th>แต้ม</th><th>สถานะ</th></tr></thead>
      <tbody id="history"><tr><td colspan="4" style="text-align:center">—</td></tr></tbody>
    </table>
  </section>

  <!-- Weekly -->
  <section id="weeklyBox" class="card" style="display:none">
    <h3>📅 รายงานกิจกรรมรายสัปดาห์</h3>
    <table>
      <thead><tr><th>วดป</th><th>ชื่อกิจกรรม</th><th>ผลตอบ</th><th>แต้ม</th></tr></thead>
      <tbody id="weekly"><tr><td colspan="4" style="text-align:center">—</td></tr></tbody>
    </table>
  </section>

  <!-- Annual forms -->
  <section id="annualBox" class="card" style="display:none">
    <h3>🗓️ รายงานทำแบบสอบถามประจำปี</h3>
    <table>
      <thead><tr><th>วดป</th><th>ชื่อแบบสอบถาม</th><th>แต้ม (รวม)</th></tr></thead>
      <tbody id="annual"><tr><td colspan="3" style="text-align:center">—</td></tr></tbody>
    </table>
  </section>
</main>

<div id="top20Modal" class="modal" style="display:none">
  <div class="modal-card">
    <h3>Top 20 คะแนนสะสม</h3>
    <table>
      <thead>
        <tr><th>อันดับ</th><th>ชื่อ-นามสกุล</th><th style="text-align:right">คะแนน</th></tr>
      </thead>
      <tbody id="top20List"><tr><td colspan="3" class="muted">—</td></tr></tbody>
    </table>
    <button onclick="hideModalTop20()">ปิด</button>
  </div>
</div>

<!-- QR Modal -->
<div id="qrModal"><div id="qrBox">
  <div class="row" style="align-items:center;margin-bottom:6px">
    <h3 style="margin:0">สแกน QR เพื่อยืนยันการแลก</h3>
    <span class="pill2" style="margin-left:auto">หมดอายุใน <b class="timer" id="qrTimer">10:00</b></span>
  </div>
  <div class="row" style="align-items:center">
    <div style="flex:1">
      <div>รางวัล: <b id="qrRewardName"></b> • ต้องใช้ <b id="qrPoints"></b> แต้ม</div>
      <div id="qrAck" class="muted" style="margin-top:6px"></div>
      <div id="qrExpired" class="bad" style="display:none;margin-top:6px">QR หมดอายุแล้ว กรุณากดแลกใหม่</div>
    </div>
    <img id="qrImg" alt="QR" style="width:180px;height:180px;border:1px solid var(--line);border-radius:8px;background:#fff" />
  </div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button id="btnCloseQR" class="ghost">ปิด</button>
  </div>
</div></div>

<!-- Activity Modal -->
<div id="actModal"><div id="actBox">
  <h3 id="actTitle">กิจกรรม</h3>
  <div id="actQuestion" class="muted" style="margin-bottom:8px"></div>
  <div id="actOpts"></div>
  <div class="row" style="margin-top:10px;justify-content:flex-end">
    <button id="btnActSubmit">ส่งคำตอบ</button>
    <button id="btnActClose" class="ghost">ปิด</button>
  </div>
  <div id="actStatus" class="muted" style="margin-top:6px"></div>
</div></div>

<!-- Two-step chooser -->
<div id="chooseModal"><div id="chooseBox">
  <h3 style="margin-top:0">เลือกชุดคำถาม</h3>
  <div id="chooseBody" class="row"></div>
  <div style="text-align:right;margin-top:8px">
    <button id="btnChooseClose" class="ghost">ปิด</button>
  </div>
</div></div>

<dialog id="dlgTop"><div style="min-width:320px">
  <h3 id="dlgTopTitle">Top 20 คะแนนสะสม</h3>
  <div id="dlgTopBody"></div>
  <div style="text-align:right;margin-top:8px"><button onclick="this.closest('dialog').close()">ปิด</button></div>
</div></dialog>

<div id="toast" class="toast"></div>

<footer style="text-align:center;color:#8b94b2;font-size:12px;margin:8px 0">
  © 2025 | ภาควิชาวิสัญญีวิทยา คณะแพทยศาสตร์ศิริราชพยาบาล
</footer>

<script type="module">
/* ========= Config ========= */
const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
const { getDatabase, ref, onValue, get, off, child } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js");
const app = initializeApp({
  apiKey: "AIzaSyAiSW2d16RpHjtUR7OIl2PVpvH_QPL3cp4",
  authDomain: "anesaplus.firebaseapp.com",
  databaseURL: "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "anesaplus",
  appId: "1:518123966097:web:2f93eeb56ec026aa903930"
});

// Endpoints
const DB_URL = "https://anesaplus-default-rtdb.asia-southeast1.firebasedatabase.app";
const ADMIN_PAGE_URL = "https://sianesth.github.io/Admin_reward/"; 
// ⬇️ IMPORTANT: อัปเดตเป็น URL ของ Web App (Deployment ล่าสุด) ลงท้ายด้วย /exec
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDO2uXrgEAk3Uq9KPNpihQeMJzZWrS45nTkgjO8ZgsGErisAvHAICCKy6MCFUz935L/exec';

async function postSubmissionToSheet(payload) {
  const url = SCRIPT_URL;
  if (!url) return { ok: false, error: 'SCRIPT_URL missing' };

  try {
    const res = await fetch(url, {
      method: 'POST',
      body: JSON.stringify(payload),
      keepalive: false,
      cache: 'no-store'
    });
    const data = await res.json();

    // ✅ แสดงผลได้ทันที
    if (data.ok && data.correct) {
      if (data.correct === "TRUE") {
        showAnswerResult(true, data.points);
      } else if (data.correct === "FALSE") {
        showAnswerResult(false, 0);
      } else {
        showAnswerResult(null, 0);
      }
    }

    // ⬅️ รองรับ error USER_NON_ACTIVE จาก server
    if (data && data.error === 'USER_NON_ACTIVE') {
      toast('บัญชีของคุณอยู่ในสถานะ <b>Non-active</b><br>ติดต่อผู้ดูแลระบบ', 4000);
    }

    return data || { ok: true, correct: 'PENDING', points: null };
  } catch (e) {
    console.error('Submit error:', e);
    return { ok: false, error: String(e) };
  }
}

/* ========= Tiny helpers ========= */
const $ = q => document.querySelector(q);
const fmt = n => Number(n||0).toLocaleString('th-TH');
const pad2 = n => String(n).padStart(2,'0');
function toast(html,ms=3000){ const el=$('#toast'); el.innerHTML=html; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),ms); }
function setWelcome(name){const el=$('#welcomeText'); if(name){ el.textContent='ยินดีต้อนรับคุณ '+name; el.style.display='block'; } else { el.style.display='none'; } }
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function todayKey(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }

// Google Drive image helpers
function extractId(u){ const s=String(u||""); if(!s) return ""; const m = s.match(/\/d\/([A-Za-z0-9_-]+)/) || s.match(/[?&]id=([A-Za-z0-9_-]+)/); return m&&m[1]?m[1]:""; }
function fixImg(u){ const s=String(u||'').trim(); if(!s) return ''; if(/uc\?export=view&id=/.test(s)) return s; const id=extractId(s); return id ? `https://drive.google.com/uc?export=view&id=${id}` : s; }
function driveThumb(id){ return id ? `https://drive.google.com/thumbnail?id=${id}&sz=w300` : ''; }

/* ========= Header offset (fixed header space) ========= */
function applyHeaderOffset(){
  const h = document.querySelector('header')?.offsetHeight || 0;
  document.documentElement.style.setProperty('--header-h', h + 'px');
}
window.addEventListener('load', applyHeaderOffset);
window.addEventListener('resize', applyHeaderOffset);

/* ========= Session ========= */
const SESSION_KEY = 'anes.session.v1';
const saveSession = d => { try{ localStorage.setItem(SESSION_KEY, JSON.stringify(d)); }catch{} };
const readSession = () => { try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch{ return null } };
const clearSession = () => { try{ localStorage.removeItem(SESSION_KEY); }catch{} };
function clearAutoPopupFlags(){ try{ const ks=[]; for(let i=0;i<sessionStorage.length;i++){ const k=sessionStorage.key(i); if(k && k.startsWith('anes.autopopup.')) ks.push(k); } ks.forEach(k=>sessionStorage.removeItem(k)); }catch{} }

/* ========= State ========= */
let state={ sap:null,total:0,name:'', leader:[], rewards:{}, activities:[], activitiesMap:{}, lastSubmission:null, weeklyRemote: [], annual: [], activityIndex:{} };
let fb=null; let actIndex={};
let _submitting = false;

/* ========= Firebase ========= */
async function ensureFirebase(){ if(fb) return fb; const db = getDatabase(app); fb={ app, db, ref, onValue, get, off, child }; return fb; }

/* ========= Latest cache ========= */
const latestStoreKey = () => `anes.latest.${todayKey()}.${state.sap||'0'}`;
const saveLatestCache = x => { try{ localStorage.setItem(latestStoreKey(), JSON.stringify(x)); }catch{} };
const readLatestCache = () => { try{ return JSON.parse(localStorage.getItem(latestStoreKey())||'null'); }catch{ return null } };
const clearLatestCache = () => { try{ localStorage.removeItem(latestStoreKey()); }catch{} };

/* ========= User fetch (fast) ========= */
async function fetchUserQuick(sap){
  const direct = [
    `public/usersSummary/${encodeURIComponent(sap)}`,
    `public/users/${encodeURIComponent(sap)}`,
    `public/UsersSummary/${encodeURIComponent(sap)}`
  ];
  for(const p of direct){ try{ const r=await fetch(`${DB_URL}/${p}.json?t=${Date.now()}`,{cache:'no-store'}); if(r.ok){ const u=await r.json(); if(u&&typeof u==='object') return u; } }catch{} }
  try{ const r2=await fetch(`${DB_URL}/public/usersSummary.json?t=${Date.now()}`,{cache:'no-store'}); if(r2.ok){ const all=await r2.json(); if(all && all[sap]) return all[sap]; } }catch{}
  return null;
}

/* ========= Login / Logout ========= */
$('#sap').addEventListener('input',e=>{ e.target.value=e.target.value.replace(/[^\d]/g,'') });
$('#btnLogin').onclick=async ()=>{
  const s=$('#sap').value.trim(); 
  if(!s){ $('#loginMsg').textContent='กรุณากรอก SAP'; return; }
  $('#loginMsg').textContent='กำลังตรวจสอบ...';
  let u=null; try{ u=await fetchUserQuick(s); }catch{}
  if(!u){ $('#loginMsg').innerHTML='ไม่พบข้อมูลในระบบ • โปรดติดต่อ admin'; return; }
  // normalize สถานะให้เท่ากันกับฝั่ง Apps Script
  function isActiveStatus(val){
    const s = String(val ?? '').normalize('NFKC').trim().toLowerCase();
    if(!s) return true; // ว่าง = ถือว่า active
    if (/^(inactive|non-?active|disabled?|false|0|ปิด|งด|หยุด)$/i.test(s)) return false;
    if (/^(active|true|1|เปิด|ใช้งาน|enabled?|on|yes)$/i.test(s)) return true;
    // fallback: ถ้าไม่ได้ขึ้นต้นด้วย "non" ก็ถือว่า active
    return !(s.startsWith('non'));
  }
  const raw = (u?.active ?? u?.Status ?? u?.status ?? u?.Active ?? 'Active');
  const ok  = (typeof u?.active === 'boolean') ? u.active : isActiveStatus(raw);

  if(!ok){ $('#loginMsg').innerHTML='สถานะ <b>Non-active</b> • กรุณาติดต่อผู้ดูแลระบบ'; return; }

  state.sap=s; state.name=((u && (u.name||u.Name)) || s); setWelcome(state.name);
  saveSession({ sap:state.sap, name:state.name }); clearAutoPopupFlags();

  document.body.classList.remove('is-login');
  $('#loginBox').style.display='none';
  $('#btnLogout').style.display='inline-block';
  attachRealtime();
  autoOpenOnceIfAvailable(true);   
  scheduleAutoPopup();             
};
$('#btnLogout').onclick=()=>{ clearAutoPopupFlags(); clearLatestCache(); clearSession(); location.reload(); };

/* ========= QR lock (10m) ========= */
const QRKEY=()=>`anes.qrlock.${state.sap||'0'}`; let lock=null, raf=null;
function loadLock(){ try{ const x=JSON.parse(localStorage.getItem(QRKEY())||'null'); if(!x) return null; if(Date.now()>x.until){ localStorage.removeItem(QRKEY()); return null } return x }catch{ return null } }
function saveLock(o){ lock=o; localStorage.setItem(QRKEY(),JSON.stringify(o)); }
function clearLock(){ lock=null; localStorage.removeItem(QRKEY()); }
function disableRedeem(dis){ document.querySelectorAll('.btnRedeem').forEach(b=>b.disabled=dis); }
function countdown(until){ const left=Math.max(0,until-Date.now()), mm=Math.floor(left/60000), ss=Math.floor((left%60000)/1000); $('#qrTimer').textContent=`${pad2(mm)}:${pad2(ss)}`; const b=$('#bannerTimer'); if(b) b.textContent=`${pad2(mm)}:${pad2(ss)}`; if(left<=0){ $('#qrExpired').style.display='block'; clearLock(); applyBanner(); if(raf) cancelAnimationFrame(raf); return; } raf=requestAnimationFrame(()=>countdown(until)); }
function applyBanner(){ const el=$('#lockBanner'); if(lock){ el.style.display='block'; $('#bannerShow').onclick=()=>openQR(lock,true); disableRedeem(true); } else { el.style.display='none'; disableRedeem(false); } }
function buildQRUrl(p){ const b64=btoa(unescape(encodeURIComponent(JSON.stringify(p)))); const url=`${ADMIN_PAGE_URL}#p=${encodeURIComponent(b64)}`; return `https://quickchart.io/qr?size=240&text=${encodeURIComponent(url)}`; }
$('#btnCloseQR').onclick=()=>$('#qrModal').style.display='none';
function openQR(o,fromResume=false){ $('#qrRewardName').textContent=o.reward; $('#qrPoints').textContent=fmt(o.pts); $('#qrExpired').style.display='none'; $('#qrAck').textContent=''; $('#qrImg').src=buildQRUrl({sap:o.sap,reward:o.reward,pts:o.pts,ts:o.ts,v:1}); $('#qrModal').style.display='flex'; countdown(o.until); if(!fromResume) applyBanner(); }
function createQR(name,pts){ if(!state.sap) return; if(lock){applyBanner();return;} const ts=new Date().toISOString(), until=Date.now()+10*60*1000; const o={sap:state.sap,reward:name,pts,ts,until}; saveLock(o); disableRedeem(true); openQR(o); }

/* ========= Weekly store ========= */
function weeklyKey(){ return `anes.weekly.${state.sap||'0'}`; }
function loadWeekly(){ try{ return JSON.parse(localStorage.getItem(weeklyKey())||'[]'); }catch{return []} }
function saveWeekly(arr){ localStorage.setItem(weeklyKey(), JSON.stringify(arr)); }
function addOrUpdateWeekly(e){ const arr=loadWeekly(); const i=arr.findIndex(x=>x.dateISO===e.dateISO && String(x.actId||'')===String(e.actId||'')); if(i>=0) arr[i]={...arr[i],...e}; else arr.push(e); saveWeekly(arr); renderWeekly(); }
function thisWeekRange(){ const d=new Date(); const day=(d.getDay()+6)%7; const start=new Date(d); start.setHours(0,0,0,0); start.setDate(d.getDate()-day); const end=new Date(start); end.setDate(start.getDate()+7); return [start,end]; }

/* ========= “ยกเลิกตีตราตอบแล้ว” กรณีถูกปฏิเสธ ========= */
function aKey(id){ return `anes.act.answered.${id}.${todayKey()}.${state.sap||'0'}`; }
function unmarkAns(id){ try{ localStorage.removeItem(aKey(id)); }catch{} }
function clinPairStoreKey(key){ return `anes.group.clinpair.${key}.${todayKey()}.${state.sap||'0'}`; }
function unmarkClinPair(key){ try{ localStorage.removeItem(clinPairStoreKey(key)); }catch{} }

function renderWeekly(){
  const [wStart, wEnd]=thisWeekRange();

  const localArr=loadWeekly().map(x=>({
    dateText:String(x.dateISO||x.ts||''),
    actId:String(x.actId||''),
    title:String(x.title||''),
    result:x.result,
    points:x.points,
    _source:'local'
  }));

  const remoteArr=(state.weeklyRemote||[]).map(x=>({
    dateText:String(x.dateISO||x.ts||x.timestamp||''),
    actId:String(x.actId||''),
    title:String(x.title||''),
    result:x.result,
    points:x.points,
    _source:'remote'
  }));

  const pickByKey={};
  [...localArr,...remoteArr].forEach(x=>{
    const t=parseLocal(x.dateText)||Date.parse(x.dateText);
    const d=new Date(isNaN(t)?0:t);
    if(!(d>=wStart && d<wEnd)) return;
    const key = (d.toISOString().slice(0,10)) + '|' + x.actId;
    const prev = pickByKey[key];
    const item = {
      _t:t, _d:d,
      title: x.title || (getActMetaById(x.actId)||{}).Title || (getActMetaById(x.actId)||{}).Question || x.actId || '-',
      result: x.result,
      points: Number(x.points||0),
      _source: x._source
    };
    if(!prev){ pickByKey[key]=item; return; }
    const better =
      (prev._source!=='remote' && item._source==='remote') ||
      (item.points > prev.points);
    if(better) pickByKey[key]=item;
  });

  const merged = Object.values(pickByKey).sort((a,b)=>b._t-a._t);
  const html = merged.length
    ? merged.map(r=>{
        const th=r._d.toLocaleDateString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit'});
        const result=r.result==null?'รอตรวจ':(r.result?'ถูก':'ผิด');
        const pts=(r.points==null)?'—':fmt(r.points);
        return `<tr><td>${th}</td><td>${escapeHtml(r.title)}</td><td>${result}</td><td>${pts}</td></tr>`;
      }).join('')
    : '<tr><td colspan="4" style="text-align:center">—</td></tr>';

  $('#weekly').innerHTML=html;
  $('#weeklyBox').style.display='block';
}

/* ========= Annual ========= */
function renderAnnual(){
  const box=$('#annualBox'); const tb=$('#annual'); if(!box||!tb) return;
  const raw=Array.isArray(state.annual)? state.annual : Object.values(state.annual||{});
  const list=raw.slice().sort((a,b)=>{ const ta=new Date(a.timestamp||a.awardedAt||a.AwardedAt||0).getTime(); const tb=new Date(b.timestamp||b.awardedAt||b.AwardedAt||0).getTime(); return tb-ta; });
  if(!list.length){ tb.innerHTML='<tr><td colspan="3" style="text-align:center">—</td></tr>'; box.style.display='block'; return; }
  const rows=list.map(r=>{ const d=new Date(r.timestamp||r.awardedAt||r.AwardedAt||Date.now()); const dt=d.toLocaleDateString('th-TH',{day:'2-digit',month:'2-digit',year:'numeric'}); const title=String(r.title||r.Title||`แบบสอบถามชุดที่ ${r.formNo||r.FormNo||''}`).trim(); const total=Number(r.totalPoints ?? (Number(r.basePoints||r.BasePoints||0)+Number(r.bonusPoints||r.BonusPoints||0)))||0; return `<tr><td>${dt}</td><td>${escapeHtml(title)}</td><td style="text-align:center">${total}</td></tr>`; }).join('');
  tb.innerHTML=rows; box.style.display='block';
}

function parseLocal(s){ if(!s) return NaN; let t=String(s).trim(); t=t.replace(/([+\-]\d{2}):?(\d{2})$/, (m,hh,mm)=>{ const ok=['00','30','45']; return `${hh}:${ok.includes(mm)?mm:'00'}`; }).replace(/([+\-])(\d)(?=:)/,(_,sign,d)=>`${sign}0${d}`); if(/^\d{4}-\d{2}-\d{2}\s+\d{1,2}:\d{2}/.test(t)){ const ts=new Date(t.replace(' ','T')).getTime(); if(!Number.isNaN(ts)) return ts; } const ts2=new Date(t).getTime(); if(!Number.isNaN(ts2)) return ts2; const m=t.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/); if(m){ const y=Number(m[3])<100?2000+Number(m[3]):Number(m[3]); const mm=Number(m[2])-1; const dd=Number(m[1]); const hh=Number(m[4]||0); const mi=Number(m[5]||0); return new Date(y,mm,dd,hh,mi).getTime(); } return NaN; }
function isIn(st,en){ const now=Date.now(); const a=parseLocal(st); const b=parseLocal(en); if(Number.isNaN(a)&&Number.isNaN(b)) return true; if(Number.isNaN(a)) return now<=b; if(Number.isNaN(b)) return now>=a; const start=Math.min(a,b); const end=Math.max(a,b); return now>=start && now<=end; }
function isTodayLocal(str){ const t=parseLocal(str); if(Number.isNaN(t)) return false; const d=new Date(t), n=new Date(); return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate(); }
function hasAns(id){ if(!id) return false; if(localStorage.getItem(aKey(id))) return true; const x=state.lastSubmission; if(!x) return false; const same=String(x.actId||'')===String(id||''); const ts=x.ts||x.timestamp; if(!ts) return false; const d=new Date(ts), n=new Date(); return same && d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate(); }
function titleClinType(t){ const s=String(t||'').toLowerCase(); if(/\bnon[-\s]?clinical\b/.test(s) || /(non[-\s]?clinical)/i.test(t)) return 'nonclin'; if(/\bclinic\b/.test(s) || /\bclinical\b/.test(s) || /(clinic)/i.test(t)) return 'clin'; return null; }
function pairKeyOf(a){ const g=a.GroupId||a.groupId||''; const t=a.Title||a.Question||''; const tag=titleClinType(t); return (g && tag)?String(g):null; }

/* ========= Preload activities for titles ========= */
let _allActsLoaded=false;
async function preloadAllActivities(){ if(_allActsLoaded) return; _allActsLoaded=true; try{ const r=await fetch(`${DB_URL}/public/activities.json?t=${Date.now()}`,{cache:'no-store'}); const all=r.ok?await r.json():null; if(all){ Object.values(all).forEach(a=>{ const id=a.ActID||a.id||a.actId; if(id) state.activityIndex[id]=a; }); renderWeekly(); } }catch{} }
function getActMetaById(id){ if(!id) return null; if(actIndex && actIndex[id]) return actIndex[id]; const todays=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{}); const hit=todays.find(a=>(a.ActID||a.id||a.actId)===id); if(hit) return hit; if(state.activityIndex && state.activityIndex[id]) return state.activityIndex[id]; return null; }

/* ========= Realtime wires ========= */
async function attachRealtime(){
  const FB=await ensureFirebase();
  await preloadAllActivities();

  onValue(ref(FB.db,'public/usersSummary/'+state.sap), s=>{
    const v=s.val()||{};
    state.total=Number(v.pointsTotal||v.PointsTotal||0);
    ['kpiBox','actTodayCard','rewardsBox','historyBox','weeklyBox'].forEach(id=>$('#'+id).style.display='block');
    $('#uEarned').textContent=fmt(v.pointsEarned||v.PointsEarned||0);
    $('#uUsed').textContent=fmt(v.pointsUsed||v.PointsUsed||0);
    $('#uTotal').textContent=fmt(v.pointsTotal||v.PointsTotal||0);
    renderRewards(); lock=loadLock(); applyBanner(); if(lock) openQR(lock,true); renderWeekly();
  });

  onValue(ref(FB.db,'public/redemptions/'+state.sap), s=>{
    const arr=s.val()||[];
    $('#history').innerHTML = Array.isArray(arr)&&arr.length
      ? arr.slice(-50).reverse().map(x=>`<tr><td>${escapeHtml((x.timestamp||'').replace('T',' ').slice(0,19))}</td><td>${escapeHtml(x.rewardName||'')}</td><td>${fmt(x.points||0)}</td><td>${escapeHtml(x.status||'')}</td></tr>`).join('')
      : '<tr><td colspan="4" style="text-align:center">—</td></tr>';
  });

  onValue(ref(FB.db,'public/rewards'), s=>{ state.rewards=s.val()||{}; renderRewards(); if(lock) disableRedeem(true); });
  onValue(ref(FB.db,'public/leaderboard'), s=>{ state.leader=s.val()||[]; });
  onValue(ref(FB.db,'public/actIndex'), snap=>{ actIndex=snap.val()||{}; renderWeekly(); renderLatest(state.lastSubmission||readLatestCache()); });

  onValue(ref(FB.db,'public/redeemAck/'+state.sap), s=>{
    const a=s.val(); if(!a) return; const key=`ack:${state.sap}:${a.timestamp||''}:${a.rewardName||''}`; if(localStorage.getItem(key)) return; localStorage.setItem(key,'1'); try{$('#qrModal').style.display='none';}catch{}; const dt=(a.timestamp||'').replace('T',' ').slice(0,19); toast(`✅ ได้รับรางวัลแล้ว<br><b>${escapeHtml(a.rewardName||'')}</b><br>${escapeHtml(dt)} • โดย ${escapeHtml(a.admin||'admin')}`,4500); $('#qrAck').textContent=`แลก "${a.rewardName}" สำเร็จ ✓ โดย ${a.admin||'admin'}`; clearLock(); applyBanner(); renderRewards();
  });

  preloadAllActivities();
  wireWeeklyRealtime();
  wireAnnualRealtime();

  ensureActivitiesRealtime();
}

/* ========= Rewards render ========= */
function renderRewards(){
  const data=state.rewards||{};
  const html=Object.entries(data).map(([name,v])=>{
    const active=String((v.Active==null?true:v.Active)).toLowerCase()!=='false'; if(!active) return '';
    const need=Number((v.pointsRequired==null?0:v.pointsRequired));
    const stock=Number((v.stock==null?0:v.stock));
    const can=(state.total>=need && stock>0) && !lock && need>0;
    const url=fixImg(v.imageUrl||v.ImageURL||v.Image||'');
    const idForThumb=extractId(url);
    return `<div class="reward">
      <img loading="lazy" decoding="async"
           src="${url||'https://via.placeholder.com/56?text=%20'}"
           data-thumb="${idForThumb ? driveThumb(idForThumb) : ''}"
           onerror="this.onerror=null; if(this.dataset.thumb){ this.src=this.dataset.thumb; this.dataset.thumb=''; } else { this.src='https://via.placeholder.com/56?text=%20'; }"
           alt="${escapeHtml(name)}">
      <div style="flex:1"><b>${escapeHtml(name)}</b><div class="muted">${fmt(need)} แต้ม • คงเหลือ ${fmt(stock)}</div></div>
      <button class="btnRedeem" ${can?'':'disabled'} data-name="${escapeHtml(name)}" data-need="${need}">แลก</button>
    </div>`;
  }).join('') || '<div class="muted">— ไม่มีรายการ —</div>';
  $('#rewards').innerHTML=html;
  document.querySelectorAll('.btnRedeem').forEach(b=> b.onclick=()=>{ if(b.disabled) return; createQR(b.dataset.name, Number(b.dataset.need||0)); });
}

/* ========= Top 20 (dialog) ========= */
$('#btnTop20').onclick = async () => {
  try {
    const FB = await ensureFirebase();
    const snap = await FB.get(FB.ref(FB.db, 'public/usersSummary'));
    const users = snap.val() || {};

    // คำนวณอันดับจากคะแนนรวม แต่ "ไม่แสดงคะแนน"
    const top = Object.values(users).map(u => {
      const name  = String(u.name || u.Name || u.sap || u.SAP || '-').trim();
      const total = Number(
        u.PointsTotal ?? u.pointsTotal ??
        (Number(u.PointsEarned ?? u.pointsEarned ?? 0) - Number(u.PointsUsed ?? u.pointsUsed ?? 0))
      ) || 0;
      return { name, total };
    }).sort((a,b) => b.total - a.total).slice(0,20);

    // เรนเดอร์ตาราง 2 คอลัมน์: ลำดับ, ชื่อ-นามสกุล
    const cols = ['ลำดับ','ชื่อ-นามสกุล'];
    const rows = top.map((r,i) => [String(i+1), String(r.name || '-')]);

    const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${
      rows.map(r => `<tr>${
        r.map((c,i) => `<td${i===0 ? ' style="width:80px;text-align:center"' : ''}>${escapeHtml(c)}</td>`).join('')
      }</tr>`).join('')
    }</tbody>`;

    $('#dlgTopTitle').textContent = 'Top 20 คะแนนสะสม';
    $('#dlgTopBody').innerHTML = `<table style="width:100%;border-collapse:collapse">${thead}${tbody}</table>`;
    $('#dlgTop').showModal();
  } catch (e) {
    console.error(e);
    $('#dlgTopTitle').textContent = 'Top 20 คะแนนสะสม';
    $('#dlgTopBody').textContent = '—';
    $('#dlgTop').showModal();
  }
};

/* ========= Activities realtime ========= */
let actOpen=false, _autoTimer=null;
function renderActList(){ $('#actList').innerHTML=''; $('#actList').style.display='none'; }

function ensureActivitiesRealtime(){ (async ()=>{
  const FB=await ensureFirebase(); const tk=todayKey(); const aref=FB.ref(FB.db,'public/activitiesByDate/'+tk);
  FB.onValue(aref, async s=>{
    let obj=s.val()||{}; let arr=Array.isArray(obj)? obj : Object.values(obj||{});
    if(!arr.length){ try{ const r=await fetch(`${DB_URL}/public/activities.json?t=${Date.now()}`,{cache:'no-store'}); const all=(await r.json())||{}; arr=Object.values(all).filter(a=>{ const active=String((a.Active==null?'TRUE':a.Active)).toLowerCase()!=='false'; return active && isTodayAct(a); }); }catch{} }
    state.activities=arr; state.activitiesMap={}; arr.forEach(a=>{ const gid=(a.GroupId||''); (state.activitiesMap[gid] ||= []).push(a); });
    renderWeekly(); renderLatest(state.lastSubmission||readLatestCache()); checkActivity(); renderActList(); autoOpenOnceIfAvailable(); scheduleAutoPopup();
  });
})(); }

function extractDateKey(s){ const m=String(s||'').match(/\b(20\d{2}-\d{2}-\d{2})\b/); return m?m[1]:null; }
function groupDate(a){ return extractDateKey(a.GroupId||a.groupId) || extractDateKey(a.ActID||a.id||a.actId); }
function isTodayAct(a){ const k=todayKey(); const gd=groupDate(a); if(gd) return gd===k; return isTodayLocal(a.WindowStart) || isTodayLocal(a.WindowEnd); }

function pickAct(){
  const list=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{});
  const cand=list.filter(a=>{ const active=String((a.Active==null?'TRUE':a.Active)).toLowerCase()!=='false'; if(!active) return false; const id=a.ActID||a.id||a.actId; if(!id) return false; if(!isTodayAct(a)) return false; if(hasAns(id)) return false; if(!isIn(a.WindowStart,a.WindowEnd)) return false; const pk=pairKeyOf(a); if(pk && localStorage.getItem(clinPairStoreKey(pk))) return false; return true; }).sort((x,y)=>parseLocal(x.WindowStart)-parseLocal(y.WindowStart));
  if(!cand.length) return null;
  const byPair={}; cand.forEach(a=>{ const pk=pairKeyOf(a); if(!pk) return; (byPair[pk]=byPair[pk]||[]).push(a); });
  const pair=Object.entries(byPair).find(([pk,arr])=> arr.length>=2 && !localStorage.getItem(clinPairStoreKey(pk)));
  if(pair){ const list2=pair[1].slice(0,2).sort((x,y)=>parseLocal(x.WindowStart)-parseLocal(y.WindowStart)); return { twoStep:'clinPair', list:list2 }; }
  return cand[0];
}

function autoOpenOnceIfAvailable(force=false){ if(!state.sap || actOpen) return; const pick=pickAct(); if(!pick){ scheduleAutoPopup(); return; } const id= pick.twoStep==='clinPair' ? ('GROUP:'+pairKeyOf(pick.list[0])) : (pick.ActID||pick.id||pick.actId); const key=`anes.autopopup.${todayKey()}.${id}`; if(!force && sessionStorage.getItem(key)) return; sessionStorage.setItem(key,'1'); if(pick.twoStep==='clinPair') openActSelector(pick); else openAct(pick); }
function scheduleAutoPopup(){ clearTimeout(_autoTimer); if(!state.sap) return; const now=Date.now(); const upcoming=getTodayActs().filter(a=>{ const id=a.ActID||a.id||a.actId; if(!id) return false; if(hasAns(id)) return false; const pk=pairKeyOf(a); if(pk && localStorage.getItem(clinPairStoreKey(pk))) return false; const st=parseLocal(a.WindowStart); return !Number.isNaN(st) && st>now; }).sort((a,b)=> parseLocal(a.WindowStart)-parseLocal(b.WindowStart)); if(!upcoming.length) return; const when=Math.max(250, parseLocal(upcoming[0].WindowStart)-now+200); _autoTimer=setTimeout(()=> autoOpenOnceIfAvailable(), when); }
window.addEventListener('focus', ()=> autoOpenOnceIfAvailable());
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) autoOpenOnceIfAvailable(); });
function getTodayActs(){ const l=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{}); return l.filter(isTodayAct); }

/* ========= Winners ========= */
function currentActForWinners(){ const acts=getTodayActs().slice().sort((a,b)=>(parseLocal(a.WindowStart)||0)-(parseLocal(b.WindowStart)||0)); if(!acts.length) return null; if(state.lastSubmission && acts.some(a=>(a.ActID||a.id||a.actId)===state.lastSubmission.actId)){ return acts.find(a=>(a.ActID||a.id||a.actId)===state.lastSubmission.actId); } const inwin=acts.find(a=> isIn(a.WindowStart,a.WindowEnd)); return inwin || acts[0]; }
async function readJson(path){ try{ const r=await fetch(`${DB_URL}/${path}.json?t=${Date.now()}`,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
async function fetchWinnersTable(today, actId){
  const paths = [
    actId ? `public/winnersByDate/${today}/${encodeURIComponent(actId)}` : null,
    `public/winnersByDate/${today}`
  ].filter(Boolean);

  for (const p of paths){
    const data = await readJson(p);
    if (!data) continue;

    // รูปแบบใหม่: มี __table
    if (data.__table && Array.isArray(data.__table.rows)){
      // map แค่ 2 คอลัมน์แรก: อันดับ, ชื่อ-นามสกุล
      const rows = data.__table.rows.map(r => [ String(r[0] ?? ''), String(r[1] ?? '') ]);
      return { cols:['อันดับ','ชื่อ-นามสกุล'], rows };
    }

    // รูปแบบใหม่อีกแบบ: __list = [{rank,sap,name,ts}]
    if (Array.isArray(data.__list)){
      const rows = data.__list.map(x => [
        String(x.rank ?? ''),
        String(x.name ?? x.sap ?? '-')
      ]);
      return { cols:['อันดับ','ชื่อ-นามสกุล'], rows };
    }

    // ของเดิม: object ต่อ SAP { sap, name, ts }
    const items = Object.entries(data)
      .filter(([k]) => !k.startsWith('__'))
      .map(([,v]) => v)
      .filter(Boolean)
      .sort((a,b) => new Date(a.ts||a.timestamp||0) - new Date(b.ts||b.timestamp||0));

    if (items.length){
      const seen = new Set(), rows=[];
      for (const it of items){
        const sap = String(it.sap || it.SAP || '');
        if (!sap || seen.has(sap)) continue;
        seen.add(sap);
        rows.push([
          String(rows.length+1),
          String(it.name || sap)
        ]);
        if (rows.length >= 20) break;
      }
      return { cols:['อันดับ','ชื่อ-นามสกุล'], rows };
    }
  }

  return { cols:['อันดับ','ชื่อ-นามสกุล'], rows:[] };
}

async function loadTop20Winners(today, actId){
  const paths=[ actId?`public/winnersByDate/${today}/${encodeURIComponent(actId)}`:null, `public/winnersByDate/${today}` ].filter(Boolean);
  for(const p of paths){ const data=await readJson(p); if(!data) continue; if(typeof data==='object'){ const arr=Object.values(data).flatMap(v=> Object.values(v||{})); if(arr.length){ arr.sort((a,b)=> new Date(a.ts||a.timestamp||0) - new Date(b.ts||b.timestamp||0)); const seen=new Set(); const out=[]; for(const it of arr){ const sap=it.sap||it.SAP; if(!sap || seen.has(sap)) continue; seen.add(sap); out.push({ sap:String(sap), ts: it.ts||it.timestamp||null }); if(out.length>=20) break; } return out; } }
  }
  return [];
}

$('#btnWinners').onclick = async () => {
  const today = todayKey();
  const act   = currentActForWinners();
  const actId = act ? (act.ActID||act.id||act.actId) : null;
  const actTitle = act ? (act.Title||act.Question||actId||'') : '';

  $('#dlgTopTitle').textContent = actTitle
    ? `Top 20 ผู้ตอบถูก (วันนี้) — ${actTitle}`
    : 'Top 20 ผู้ตอบถูก (วันนี้)';

  const table = await fetchWinnersTable(today, actId);

  if (table.rows && table.rows.length){
    const thead = `<thead><tr>${table.cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>`;
    const tbody = `<tbody>${
      table.rows.map(r=>`<tr>${
        r.map((c,i)=> `<td${i===0? ' style="width:80px;text-align:center"':''}>${escapeHtml(String(c))}</td>`).join('')
      }</tr>`).join('')
    }</tbody>`;
    $('#dlgTopBody').innerHTML = `<table style="width:100%;border-collapse:collapse">${thead}${tbody}</table>`;
  } else {
    $('#dlgTopBody').innerHTML = '—';
  }
  $('#dlgTop').showModal();
};

/* ========= Open activity UI ========= */
function openActSelector(group){ const box=$('#chooseBody'); box.innerHTML=group.list.map((a,i)=>`<button class="ghost" data-i="${i}" style="flex:1">${escapeHtml(a.Title||('ตัวเลือก '+(i+1)))}</button>`).join(''); box.querySelectorAll('button').forEach(btn=>btn.onclick=()=>{ const i=Number(btn.dataset.i||0); $('#chooseModal').style.display='none'; openAct(group.list[i]); }); $('#btnChooseClose').onclick=()=>$('#chooseModal').style.display='none'; $('#chooseModal').style.display='flex'; }

function openAct(act){
  actOpen=true; const id=act.ActID||act.id||act.actId; const t=String(act.InputType||'MCQ').toUpperCase().replace(/[^A-Z0-9]/g,'');
  $('#actTitle').textContent=(act.Question||act.Title||''); $('#actQuestion').style.display='none'; $('#actQuestion').textContent=''; $('#actStatus').textContent=''; const box=$('#actOpts');
  if(['NUM2','NUM','NUMBER','NUMERIC'].includes(t)) { box.innerHTML=`<input id="actText" placeholder="กรอกตัวเลข 2 หลัก" maxlength="2" inputmode="numeric" style="width:140px;text-align:center">`; setTimeout(()=>{ const inp=$('#actText'); try{ inp.focus(); }catch{}; inp.addEventListener('input', e => e.target.value = e.target.value.replace(/[^\d]/g,'').slice(0,2)); inp.addEventListener('keydown',e=>{ if(e.key==='Enter') $('#btnActSubmit').click(); }); },0); }
  else if(t==='TEXT') { box.innerHTML=`<input id="actText" placeholder="พิมพ์คำตอบ" style="width:100%">`; setTimeout(()=>{ try{$('#actText').focus();}catch{} },0); }
  else {
    const labels = ['A','B','C','D'];
    const options = ['OptionA','OptionB','OptionC','OptionD'].map(k=>act[k]).filter(v=>v!=null&&String(v).trim()!=='');
    box.innerHTML = options.length
      ? options.map((t,i)=> {
          const L = labels[i];
          return `<label style="display:flex;gap:8px;align-items:flex-start;margin:6px 0">
                    <input type="radio" name="actOpt" value="${L}">
                    <span><b>${L}.</b> ${escapeHtml(String(t))}</span>
                  </label>`;
        }).join('')
      : '<div class="muted">— ไม่มีตัวเลือก —</div>';
  }
  $('#actModal').style.display='flex';

 $('#btnActSubmit').onclick = async () => {
  if (_submitting) return;
  _submitting = true;
  try {
    // กันตอบซ้ำ (client)
    const id = act.ActID || act.id || act.actId;
    const t  = String(act.InputType || 'MCQ').toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (hasAns(id)) {
      $('#actStatus').textContent = 'คุณได้ตอบคำถามนี้แล้ววันนี้';
      return;
    }

    // คำตอบ
    let ans;
    if (['NUM2','NUM','NUMBER','NUMERIC','TEXT'].includes(t)) {
      ans = ($('#actText').value || '').trim();
      if (t !== 'TEXT' && !/^\d{2}$/.test(ans)) {
        $('#actStatus').textContent = 'กรุณากรอกเลข 2 หลัก (00–99)';
        try { $('#actText').focus(); } catch(_){}
        return;
      }
    } else {
      const chk = document.querySelector('input[name="actOpt"]:checked');
      if (!chk) { $('#actStatus').textContent = 'กรุณาเลือกคำตอบ'; return; }
      ans = String(chk.value || '').trim().toUpperCase();
    }

    // ตีตร้าว่าตอบแล้ว (optimistic)
    localStorage.setItem(aKey(id),'1');
    const pk = pairKeyOf(act); if (pk) localStorage.setItem(clinPairStoreKey(pk),'1');
    localStorage.setItem('anes.act.lastAns.' + id + '.' + (state.sap || ''), ans);

    // payload
    const key = 'ans_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
    const ts  = new Date().toISOString();
    const payload = { sap: state.sap, actId: id, answer: ans, timestamp: ts, client: 'web-anesa+' };

    // Optimistic UI (เฉพาะ MCQ ที่มีเฉลย)
    const isNumeric = ['NUM2','NUM','NUMBER','NUMERIC'].includes(t);
    const hasAnswer = String(act.Answer || '').trim() !== '';
    const instantOK = (!isNumeric && hasAnswer) ? clientIsCorrect(act, ans) : null;
    const instantPts = (instantOK === true) ? (Number(act.BasePoints||0) + Number(act.CorrectBonus||0)) : 0;
    const optimistic = { actId: id, title: (act.Title || id), ts, correct: instantOK, points: (instantOK ? instantPts : 0), userAnswer: ans, Finalized: false };
    state.lastSubmission = optimistic;
    renderLatest(optimistic);
    addOrUpdateWeekly({ dateISO: ts, title: optimistic.title, actId: id, result: optimistic.correct, points: optimistic.points, Finalized: false });

    $('#actModal').style.display = 'none';
    actOpen = false;
    toast('✅ ส่งคำตอบแล้ว', 1200);
    $('#btnActNow').disabled = true;
    checkActivity();

    // PUT queue → RTDB
    try {
      await fetch(DB_URL + '/public/answersQueue/' + encodeURIComponent(key) + '.json', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } catch(_) {}

    // Apps Script: queue:process
    let server = null;
    try{
      const r = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action:'queue:process', key, item: payload })
      });
      server = await r.json();
    }catch(_){}

    // ⬅️ จัดการกรณีถูกปฏิเสธเพราะ Non-active
    if (server && server.error === 'USER_NON_ACTIVE') {
      toast('บัญชีของคุณอยู่ในสถานะ <b>Non-active</b><br>ติดต่อผู้ดูแลระบบ', 4000);
      // ยกเลิกตีตราว่าตอบแล้ว
      unmarkAns(id);
      const pk2 = pairKeyOf(act); if (pk2) unmarkClinPair(pk2);
      // รีเฟรชปุ่ม
      $('#btnActNow').disabled = false;
      checkActivity();
      return;
    }

    // ถ้าสำเร็จ → อัปเดตผล
    if (server && server.ok) {
      const final = {
        actId: id,
        title: optimistic.title,
        ts: ts,
        correct: (server.correct === 'TRUE' ? true : (server.correct === 'FALSE' ? false : null)),
        points: Number(server.points || 0),
        userAnswer: ans,
        Finalized: (server.correct !== 'PENDING')
      };
      state.lastSubmission = final;
      renderLatest(final);
      addOrUpdateWeekly({ dateISO: ts, title: final.title, actId: id, result: final.correct, points: final.points, Finalized: final.Finalized });
    } else {
      // fallback → ยิง submit ตรง
      const res = await postSubmissionToSheet(payload);
      if (res && res.error === 'USER_NON_ACTIVE') {
        toast('บัญชีของคุณอยู่ในสถานะ <b>Non-active</b><br>ติดต่อผู้ดูแลระบบ', 4000);
        unmarkAns(id); const pk2 = pairKeyOf(act); if (pk2) unmarkClinPair(pk2);
        $('#btnActNow').disabled = false; checkActivity();
        return;
      }
      if (res && res.ok){
        const final = {
          actId: id, title: optimistic.title, ts: ts,
          correct: (res.correct === 'TRUE' ? true : (res.correct === 'FALSE' ? false : null)),
          points: (res.points == null ? 0 : Number(res.points)),
          userAnswer: ans, Finalized: true
        };
        state.lastSubmission = final;
        renderLatest(final);
        addOrUpdateWeekly({ dateISO: ts, title: final.title, actId: id, result: final.correct, points: final.points, Finalized: true });
      }
    }

  } catch (err) {
    console.error(err);
    $('#actStatus').textContent = 'เกิดข้อผิดพลาด กรุณาลองใหม่';
  } finally {
    _submitting = false;
  }
};

  $('#btnActClose').onclick=()=>{ $('#actModal').style.display='none'; actOpen=false; };
}

function renderLatest(x){
  const box=$('#actLatest'); const isTodayTs=ts=>{ if(!ts) return false; const d=new Date(ts), n=new Date(); return d.getFullYear()===n.getFullYear() && d.getMonth()===n.getMonth() && d.getDate()===n.getDate(); };
  const acts=Array.isArray(state.activities)? state.activities : Object.values(state.activities||{});
  const hasTodayData=obj=> !!obj && ( isTodayTs(obj.ts) || (!!obj.actId && acts.some(a=>(a.ActID||a.id||a.actId)===obj.actId)) );
  const data=hasTodayData(x)? x : readLatestCache(); if(!hasTodayData(data)) return; saveLatestCache(data);
  const act=acts.find(a=>(a.ActID||a.id||a.actId)===data.actId) || {}; const your=(data.userAnswer || localStorage.getItem(`anes.act.lastAns.${data.actId||''}.${state.sap||''}`) || '—')+''; const ansKey=(act.Answer||'')+'';
  const mapAnswerText = (act, raw) => {
     const K = String(raw||'').trim().toUpperCase();
     const optMap = {A:act.OptionA, B:act.OptionB, C:act.OptionC, D:act.OptionD};
     if(['A','B','C','D'].includes(K)){
       const t = optMap[K];
       return t ? `${K}. ${t}` : K;
     }
     const m = String(raw||'').trim().match(/^([A-Dก-ง])[\.\)]?/i);
     const L = m ? m[1].toUpperCase() : '';
     if(L){
       const t = optMap[L];
       return t ? `${L}. ${t}` : raw;
     }
     return raw;
  };

  const ansText=ansKey ? mapAnswerText(act, ansKey) : '';
  let verdict=''; if(data.correct===true){ verdict=`<span class="ok">✅ ถูกต้อง</span>${(data.points!=null && data.points>0)?` • +${data.points} แต้ม`:''}`; } else if(data.correct===false){ const reveal=ansKey?` • เฉลย: <b>${escapeHtml(ansText)}</b>`:''; verdict=`<span class="bad">❌ ไม่ถูก</span>${reveal}`; } else { verdict=`<span class="muted">⌛ รอตรวจสอบ</span>`; }
  const qText=(act.Question||act.Title||data.title||data.actId||'-')+'';
  const html=`<div><b>คำถามวันนี้:</b> ${escapeHtml(qText)}</div><div><b>คำตอบของคุณ:</b> ${escapeHtml(your)} • ${verdict}</div>`;
  box.innerHTML=html; box.style.display='block';
}

function checkActivity(){ if(!state.sap){ $('#actTodayCard').style.display='none'; return; } $('#actTodayCard').style.display='block'; const pick=pickAct(); $('#btnActNow').disabled=!pick; renderActList(); }
$('#btnActNow').onclick=()=>{ const pick=pickAct(); if(!pick){ $('#btnActNow').disabled=true; return; } if(pick.twoStep==='clinPair'){ openActSelector(pick); } else { openAct(pick); } };

function mapWeeklyRow(it){ const dateText=String(it.dateISO||it.ts||it.timestamp||it.Date||it.date||it.time||''); const actId=String(it.actId||it.ActID||it.ActivityId||it.activityId||it.setId||it.GroupId||it.FormId||''); let title=String(it.title||it.Title||it.ActivityTitle||it.FormTitle||it.name||it.question||''); if(!title && actId){ const meta=getActMetaById(actId); if(meta) title=meta.Title||meta.Question||''; } const r=(it.result ?? it.Result ?? it.correct ?? it.Correct); let result=null; if(r===true || String(r).toLowerCase()==='true' || String(r)==='1') result=true; if(r===false || String(r).toLowerCase()==='false' || String(r)==='0') result=false; const points=Number(it.points ?? it.Points ?? it.point ?? it.award ?? it.Award ?? it.pointsAwarded ?? it.Score ?? 0) || 0; return { dateText, actId, title, result, points }; }

async function wireWeeklyRealtime(){
  const FB=await ensureFirebase();
  const paths=[ `public/weeklyByUser/${state.sap}`, `public/FormAwardsByUser/${state.sap}`, `public/formAwardsByUser/${state.sap}` ];
  paths.forEach(p=>{ onValue(ref(FB.db,p), snap=>{ const obj=snap.val()||{}; const arr=Array.isArray(obj)? obj : Object.values(obj); if(!arr.length) return; state.weeklyRemote=arr.map(mapWeeklyRow); renderWeekly(); }); });
  onValue(ref(FB.db,'public/FormAwards'), snap=>{ const obj=snap.val()||{}; const arr=Object.values(obj).filter(it=> String(it.sap||it.SAP||it.user||it.userId||'')===String(state.sap||'')); if(!arr.length) return; state.weeklyRemote=arr.map(mapWeeklyRow); renderWeekly(); });
}

/* ========= Annual realtime ========= */
state.offAnnual && state.offAnnual();
async function wireAnnualRealtime(){ const FB=await ensureFirebase(); const r=ref(FB.db,'public/annualByUser/'+state.sap); state.offAnnual = onValue(r, snap=>{ const val=snap.val()||{}; const arr=Array.isArray(val)? val : Object.entries(val).map(([k,v])=>({_key:k,...v})); state.annual = arr.filter(Boolean).sort((a,b)=> new Date(b.timestamp||b.awardedAt||0) - new Date(a.timestamp||a.awardedAt||0)).slice(0,200); renderAnnual(); }); }

/* ========= Auto restore ========= */
(function restoreSession(){ const sess=readSession(); if(!sess||!sess.sap) return; state.sap=sess.sap; state.name=sess.name||sess.sap; setWelcome(state.name); document.body.classList.remove('is-login'); $('#loginBox').style.display='none'; $('#btnLogout').style.display='inline-block'; $('#actTodayCard').style.display='block'; renderLatest(readLatestCache()); clearAutoPopupFlags(); attachRealtime(); autoOpenOnceIfAvailable(true); scheduleAutoPopup(); })();

/* ========= Heartbeat ========= */
setInterval(()=>{ if(!state.sap) return; try{ if(!actOpen){ checkActivity(); autoOpenOnceIfAvailable(); } }catch{} }, 5000);

// ===== Client-side correctness helper (instant MCQ) =====
function _normStr(s){
  return String(s||'').replace(/[.\u200b]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
}
function stripChoicePrefix_(s){
  return String(s||'').replace(/^\s*([A-Dก-ง])[\.\)]?\s*/i,'');
}
function clientIsCorrect(meta, userAns){
  const cat = String(meta.Category||'');
  if(/DAY(1|16)_LOTTO/i.test(cat)){
    const u2 = String(userAns||'').replace(/\D/g,'').slice(-2);
    const a2 = String(meta.Answer||'').replace(/\D/g,'').slice(-2);
    return (u2 && a2 && u2===a2);
  }
  const a = _normStr(stripChoicePrefix_(meta.Answer));
  const u = _normStr(userAns);
  if(u && a && u===a) return true;

  const letterMap = {A:'OptionA',B:'OptionB',C:'OptionC',D:'OptionD','ก':'OptionA','ข':'OptionB','ค':'OptionC','ง':'OptionD'};
  if(u.length===1){
    const keyRaw = String(userAns||'').trim();
    const key = letterMap[keyRaw.toUpperCase()] || letterMap[keyRaw];
    const full = key ? _normStr(stripChoicePrefix_(meta[key]||'')) : '';
    if(full && full===a) return true;
  }
  const m = String(meta.Answer||'').trim().match(/^([A-Dก-ง])[\.\)]?/i);
  const ansLetter = m ? m[1].toUpperCase() : '';
  if(ansLetter){
    if(String(userAns||'').trim().toUpperCase() === ansLetter) return true;
    const opt = letterMap[ansLetter];
    const full = opt ? _normStr(stripChoicePrefix_(meta[opt]||'')) : '';
    if(full && _normStr(userAns) === full) return true;
  }
  return false;
}

</script>
</body>
</html>